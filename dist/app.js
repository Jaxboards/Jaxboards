(function(){"use strict";function getComputedStyle$1(e,t){return!!e&&(e.currentStyle?e.currentStyle:!!window.getComputedStyle&&window.getComputedStyle(e,t))}function getCoordinates(e){const{x:t,y:s,height:o,width:n}=e.getBoundingClientRect(),i=t+window.scrollX,r=s+window.scrollY;return{x:i,y:r,yh:r+o,xw:i+n,w:n,h:o}}function isChildOf(e,t){return t.contains(e)}function insertBefore(e,t){e.parentNode&&e.parentNode.removeChild(e),t.parentNode.insertBefore(e,t)}function insertAfter(e,t){e.parentNode&&e.parentNode.removeChild(e),t.parentNode.insertBefore(e,t.nextSibling)}function getHighestZIndex(){return Array.from(document.getElementsByTagName("*")).reduce(((e,t)=>t.style.zIndex&&Number(t.style.zIndex)>e?Number(t.style.zIndex):e),0)+1}function ordsuffix(e){return e+(1===Math.round(e/10)?"th":["","st","nd","rd"][e%10]||"th")}function timeAsAMPM(e){const t=e.getHours()||12;return`${t%12||12}:${`${e.getMinutes()}`.padStart(2,"0")}${t>12?"pm":"am"}`}function asMDY(e){return`${e.getMonth()}/${e.getDate()}/${e.getFullYear()}`}const monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],daysShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months=["January","February","March","April","May","June","July","August","September","October","November","December"];function date(e){const t=new Date,s=new Date;s.setTime(s-864e5);const o=new Date(1e3*e),n=(t-o)/1e3;return n<90?"a minute ago":n<3600?`${Math.round(n/60)} minutes ago`:asMDY(t)===asMDY(o)?`Today @ ${timeAsAMPM(o)}`:asMDY(s)===asMDY(o)?`Yesterday @ ${timeAsAMPM(o)}`:`${monthsShort[o.getMonth()]} ${ordsuffix(o.getDate())}, ${o.getFullYear()} @ ${timeAsAMPM(o)}`}function smalldate(e){const t=new Date(1e3*e);let s=t.getHours();const o=s>=12?"pm":"am";s%=12,s=s||12;return`${s}:${`${t.getMinutes()}`.padStart(2,"0")}${o}, ${t.getMonth()+1}/${`${t.getDate()}`.padStart(2,"0")}/${t.getFullYear()}`}function emojiTime(e){const t=new Date(e);return String.fromCharCode(55357,(t.getHours()%12||12)-1+56656+(t.getMinutes()>29?12:0))}function addIdleClock(e){const t=Array.from(e.classList).find((e=>e.startsWith("lastAction")));void 0!==t&&(e.prepend(emojiTime(parseInt(t.slice(10),10))),e.classList.remove(t))}function assign(e,t){return Object.assign(e,t)}function tryInvoke(e,...t){return e&&"function"==typeof e?e(...t):null}function onImagesLoaded(e,t=2e3){return new Promise((s=>{const o=new Set,n=Array.from(e).filter((e=>!e.complete));function i(){o.delete(this.src),0===o.size&&s()}n.length?(n.forEach((e=>{o.has(e.src)||(o.add(e.src),e.addEventListener("error",i),e.addEventListener("load",i))})),t&&setTimeout(s,t)):s()}))}function updateDates(){const e=document.querySelectorAll(".autodate"),t=Array.from(document.querySelectorAll("[data-timestamp]"));e&&(e.forEach((e=>{const t=parseInt(e.title,10),s=e.classList.contains("smalldate")?smalldate(t):date(t);s!==e.innerHTML&&(e.innerHTML=s)})),t.forEach((e=>{e.title||(e.title=smalldate(e.dataset.timestamp))})))}function toggleOverlay(e){const t=document.documentElement;let s=document.getElementById("overlay");if(s)assign(s.style,{zIndex:getHighestZIndex(),top:0,height:`${t.clientHeight}px`,width:`${t.clientWidth}px`,display:e?"":"none"});else{if(!e)return;s=document.createElement("div"),s.id="overlay",assign(s.style,{height:`${t.clientHeight}0px`,width:`${t.clientWidth}0px`}),t.appendChild(s)}}function onDOMReady(e){"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e)}function Event$1(e){const t=document.body,s=document.documentElement;switch(e.keyCode){case 13:e.ENTER=!0;break;case 37:e.LEFT=!0;break;case 38:e.UP=!0;break;case.39:e.RIGHT=!0;break;case 40:e.DOWN=!0}return void 0===e.srcElement&&(e.srcElement=e.target),void 0===e.pageY&&(e.pageY=e.clientY+(parseInt(s.scrollTop||t.scrollTop,10)||0),e.pageX=e.clientX+(parseInt(s.scrollLeft||t.scrollLeft,10)||0)),e.cancel=()=>(e.returnValue=!1,e.preventDefault&&e.preventDefault(),e),e.stopBubbling=()=>(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e),e}const maxDimension="999999px";function makeResizer(e,t,s,o,n){n.style.maxWidth=maxDimension,n.style.maxHeight=maxDimension,n.madeResized=!0;const i=document.createElement("a");i.target="newwin",i.href=n.src,i.style.display="block",i.style.overflow="hidden",i.style.width=`${e}px`,i.style.height=`${s}px`,i.nw=t,i.nh=o,i.onmousemove=e=>{const t=getCoordinates(i),s=Event$1(e);i.scrollLeft=(s.pageX-t.x)/t.w*(i.nw-t.w)||0,i.scrollTop=(s.pageY-t.y)/t.h*(i.nh-t.h)||0},i.onmouseover=()=>{n.style.width=`${i.nw}px`,n.style.height=`${i.nh}px`},i.onmouseout=()=>{i.scrollLeft&&(i.scrollLeft=0,i.scrollTop=0),n.style.width=`${e}px`,n.style.height=`${s}px`},i.onmouseout(),insertBefore(i,n),i.appendChild(n)}function imageResizer(e){let t,s,o;e&&e.length&&Array.from(e).filter((e=>!e.madeResized)).forEach((e=>{let n=1,i=1;const{naturalWidth:r,naturalHeight:a}=e;let l=r,c=a;o=getComputedStyle$1(e),t=parseInt(o.width,10)||parseInt(o.maxWidth,10),s=parseInt(o.height,10)||parseInt(o.maxHeight,10),t&&l>t&&(n=t/l),s&&c>s&&(i=s/c),n=n&&i?Math.min(n,i):i||n,n<1&&(l*=n,c*=n,makeResizer(l,r,c,a,e))}))}function toolTip(e){let t=document.getElementById("tooltip_thingy");const s=getCoordinates(e),o=e.getAttribute("title");if(o){if(e.title="",!t){t=document.createElement("table");const e=t.insertRow(0),s=t.insertRow(1),o=t.insertRow(2);let n;t.id="tooltip_thingy",t.className="tooltip",e.className="top",s.className="content",o.className="bottom",n=e.insertCell(0),n.className="left",n.colSpan=2,n=e.insertCell(1),n.className="right",n=s.insertCell(0),n.className="left",n=s.insertCell(1),n.innerHTML="default text",n=s.insertCell(2),n.className="right",n=o.insertCell(0),n.className="left",n.colSpan=2,n=o.insertCell(1),n.className="right",document.querySelector("#page").appendChild(t)}t.rows[1].cells[1].innerText=o,t.style.display="",t.style.top=s.y-t.clientHeight+"px",t.style.left=`${s.x}px`,t.style.zIndex=getHighestZIndex(),e.onmouseout=()=>{e.title=o,document.querySelector("#tooltip_thingy").style.display="none"}}}function selectAll(e){if(document.selection){const t=document.body.createTextRange();t.moveToElementText(e),t.select()}else if(window.getSelection){const t=document.createRange();t.selectNode(e);const s=window.getSelection();s.rangeCount&&s.removeAllRanges(),s.addRange(t)}}function replaceSelection(e,t){const s=e.scrollTop;if(document.selection)e.focus(),document.selection.createRange().text=t;else{const s=e.selectionStart,o=e.selectionEnd;e.value=e.value.substring(0,s)+t+e.value.substr(o),e.selectionStart=s+t.length,e.selectionEnd=s+t.length}e.focus(),e.scrollTop=s}function buildQueryString(e,t){return e?t?e.map(((e,s)=>`${encodeURIComponent(e)}=${encodeURIComponent(t[s]||"")}`)).join("&"):Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t]||"")}`)).join("&"):""}class Ajax{constructor(e){this.setup={readyState:4,callback(){},method:"POST",...e}}load(e,{callback:t,data:s,method:o=this.setup.method,requestType:n=1}={}){let i=null;s&&Array.isArray(s)&&Array.isArray(s[0])&&s[0].length===s[1].length?i=buildQueryString(s[0],s[1]):"string"!=typeof s&&(i=buildQueryString(s));const r=new XMLHttpRequest;return t&&(this.setup.callback=t),r.onreadystatechange=()=>{r.readyState===this.setup.readyState&&this.setup.callback(r)},r.open(o,e,!0),r.url=e,r.type=n,o&&r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("X-JSACCESS",n),r.send(i),r}}class Component{static get selector(){throw new Error("No Selector defined")}constructor(e){this.element=e,e.hydrated=!0}}const VALID_CLASS="valid",INVALID_CLASS="invalid";class AutoComplete extends Component{static get selector(){return"input[data-autocomplete-action]"}constructor(e){super(e),e.autocomplete="off",this.action=e.dataset.autocompleteAction;const t=e.dataset.autocompleteOutput,s=e.dataset.autocompleteIndicator;if(this.outputElement=t&&document.querySelector(t),this.indicatorElement=s&&document.querySelector(s),!this.outputElement)throw new Error("Expected element to have data-autocomplete-output");e.addEventListener("keyup",(e=>this.keyUp(e))),e.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()}))}getResultsContainer(){const e=getCoordinates(this.element);let t=document.querySelector("#autocomplete");return t||(t=assign(document.createElement("div"),{id:"autocomplete"}),assign(t.style,{zIndex:getHighestZIndex()}),document.body.appendChild(t)),assign(t.style,{top:`${e.yh}px`,left:`${e.x}px`,width:`${e.w}px`}),t}keyUp(e){const t=this.getResultsContainer(),s=Array.from(t.querySelectorAll("div")),o=s.findIndex((e=>e.classList.contains("selected")));if(s)switch(e.key){case"ArrowUp":return void(o>=0&&(s[o].classList.remove("selected"),s[o-1].classList.add("selected")));case"ArrowDown":return void(-1===o?s[0].classList.add("selected"):o<s.length-1&&(s[o].classList.remove("selected"),s[o+1].classList.add("selected")));case"Enter":return void(o>=0&&s[o].onclick());default:this.indicatorElement&&(this.indicatorElement.classList.remove(VALID_CLASS),this.indicatorElement.classList.add(INVALID_CLASS))}const n=document.location.toString().match("/ACP/")?"../":"",i=encodeURIComponent(this.element.value),r=`act=${this.action}&term=${i}`;(new Ajax).load(`${n}api/?${r}`,{callback:e=>{const s=JSON.parse(e.responseText);if(t.innerHTML="",s.length){t.style.display="";const[e,o]=s;e.forEach(((e,s)=>{const n=o[s],i=document.createElement("div");i.innerHTML=n,i.onclick=()=>{t.style.display="none",this.indicatorElement&&this.indicatorElement.classList.add(VALID_CLASS),this.outputElement.value=e,this.outputElement.dispatchEvent(new Event("change")),this.element.value=n},t.appendChild(i)}))}else t.style.display="none"}})}}class Color{constructor(e){let t=e;if("object"==typeof t)this.rgb=t;else if("string"==typeof t){const e=t.match(/^rgb\((\d+),\s?(\d+),\s?(\d+)\)/i),s=t.match(/#?[^\da-fA-F]/);if(e)e[1]=parseFloat(e[1]),e[2]=parseFloat(e[2]),e[3]=parseFloat(e[3]),e.shift(),this.rgb=e;else if(s)if("#"===t.charAt(0)&&(t=t.substr(1)),3===t.length&&(t=t.charAt(0)+t.charAt(0)+t.charAt(1)+t.charAt(1)+t.charAt(2)+t.charAt(2)),6!==t.length)this.rgb=[0,0,0];else{this.rgb=[];for(let e=0;e<3;e+=1)this.rgb[e]=parseInt(t.substr(2*e,2),16)}}else this.rgb=[0,0,0]}invert(){return this.rgb=[255-this.rgb[0],255-this.rgb[1],255-this.rgb[2]],this}toRGB(){return this.rgb}toHex(){if(!this.rgb)return!1;let e,t,s="";const o="0123456789ABCDEF";for(t=0;t<3;t+=1)e=this.rgb[t],s+=o.charAt(Math.floor(e/16))+o.charAt(Math.floor(e%16));return s}}class Animation{constructor(e,t,s,o){this.el=e,this.steps=t||30,this.delay=s||20,this.curLineup=0,this.stepCount=0,this.loop=o||0,this.lineup=[[]]}play(){return this.interval=setInterval((()=>this.step()),this.delay),this}morph(e,t,s){return Array.isArray(e)&&e.length===s.length?e.map(((e,o)=>Math.round(this.morph(e,t,s[o])))):(s-e)*t+e}step(){const e=this.lineup[this.curLineup];this.stepCount+=1;let t=this.stepCount;"function"==typeof e[0]?(e[0](this.el),t=this.steps):e.forEach((e=>{let s=this.morph(e[1],t/this.steps,e[2]);e[0].match(/color/i)?s=`#${new Color(s).toHex()}`:"opacity"!==e[0]&&(s=Math.round(s)),this.el.style[e[0]]=e[3]+s+e[4]})),t===this.steps&&(this.lineup.length-1>this.curLineup?(this.stepCount=0,this.curLineup+=1):1===this.loop?(this.stepCount=0,this.curLineup=0):clearInterval(this.interval))}add(e,t,s){let o,n=["","",""];return e.match(/color/i)?(o=new Color(t).toRGB(),n[1]=new Color(s).toRGB()):(n=s.match(/(\D*)(-?\d+)(\D*)/),n.shift(),o=parseFloat(t.match(/-?\d+/))),this.lineup[this.lineup.length-1].push([e,o,n[1],n[0],n[2]]),this}dehighlight(){this.el.style.backgroundColor="";const e=getComputedStyle$1(this.el).backgroundColor.toString();let t;return this.el.classList.add("highlight"),t=getComputedStyle$1(this.el).backgroundColor.toString(),t===e&&(t="FF0"),this.el.classList.add("highlight"),this.add("backgroundColor",t,e).then((()=>{this.el.style.backgroundColor=e}))}then(e,t,s,o){return this.lineup.push([]),o&&(this.steps=o),"function"==typeof e?this.lineup[this.lineup.length-1].push(e):this.add(e,t,s),this}}class CollapseBox extends Component{static get selector(){return".collapse-box"}constructor(e){super(e),e.querySelector(".collapse-button").addEventListener("click",(()=>this.click()))}click(){const e=this.element.querySelector(".collapse-content"),t=e.style;let s=e.dataset.fullHeight;const o=e.parentNode;t.overflow="hidden","0px"===t.height?new Animation(e,5,10,0).add("height","0px",s).then((()=>{o.classList.remove("collapsed")})).play():(s||(s=`${e.clientHeight||e.offsetHeight}px`,e.dataset.fullHeight=s),new Animation(e,5,10,0).add("height",s,"0px").then((()=>{o.classList.add("collapsed")})).play())}}class DatePicker extends Component{static get selector(){return"input.date"}constructor(e){super(e),this.picker=this.getPicker(),e.autocomplete="off",e.addEventListener("focus",(()=>this.openPicker())),e.addEventListener("keydown",(()=>this.closePicker()))}getPicker(){if(this.picker)return this.picker;let e=document.querySelector("#datepicker");return e||(e=assign(document.createElement("table"),{id:"datepicker"}),document.body.appendChild(e),e.style.display="none"),e}openPicker(){const e=getCoordinates(this.element);assign(this.picker.style,{display:"",zIndex:getHighestZIndex(),position:"absolute",top:`${e.yh}px`,left:`${e.x}px`});const[t,s,o]=this.element.value.split("/").map((e=>parseInt(e,10)));this.selectedDate=t&&s&&o?[o,t-1,s]:void 0,this.generate(o,t,s)}closePicker(){this.picker.style.display="none"}generate(e,t,s){let o=new Date;const n=document.querySelector("#datepicker");let i,r,[a,l,c]=[e,t,s];void 0===a&&(a=o.getFullYear(),l=o.getMonth(),c=o.getDate(),this.selectedDate=[a,l,c]),-1===l&&(a-=1,l=11),12===l&&(a+=1,l=0),this.lastDate=[a,l,c];const d=new Date(a,l+1,0).getDate(),h=new Date(a,l,1).getDay();o=new Date(a,l,c),n.innerHTML="",i=n.insertRow(0),r=i.insertCell(0),r.innerHTML="&lt;",r.className="control",r.onclick=()=>this.lastYear(),r=i.insertCell(1),r.colSpan="5",r.className="year",r.innerHTML=a,r=i.insertCell(2),r.innerHTML=">",r.className="control",r.onclick=()=>this.nextYear(),i=n.insertRow(1),r=i.insertCell(0),r.innerHTML="<",r.className="control",r.onclick=()=>this.lastMonth(),r=i.insertCell(1),r.colSpan="5",r.innerHTML=months[l],r.className="month",r=i.insertCell(2),r.innerHTML=">",r.className="control",r.onclick=()=>this.nextMonth(),i=n.insertRow(2),i.className="weekdays";for(let e=0;e<7;e+=1)i.insertCell(e).innerHTML=daysShort[e];i=n.insertRow(3);for(let e=0;e<d;e+=1){if(!e)for(let e=0;e<h;e+=1)i.insertCell(e);(h+e)%7==0&&(i=n.insertRow(n.rows.length)),r=i.insertCell((h+e)%7),r.onclick=this.insert.bind(this,r);const t=a===this.selectedDate[0]&&l===this.selectedDate[1]&&e+1===this.selectedDate[2];r.className="day"+(t?" selected":""),r.innerHTML=e+1}}lastYear(){const e=this.lastDate;this.generate(e[0]-1,e[1],e[2])}nextYear(){const e=this.lastDate;this.generate(e[0]+1,e[1],e[2])}lastMonth(){const e=this.lastDate;this.generate(e[0],e[1]-1,e[2])}nextMonth(){const e=this.lastDate;this.generate(e[0],e[1]+1,e[2])}insert(e){const t=this.lastDate;this.element.value=`${t[1]+1}/${e.innerHTML}/${t[0]}`,this.closePicker()}}class ImageGallery extends Component{static get selector(){return".image_gallery"}constructor(e){super(e);const t=document.createElement("div"),s=document.createElement("button"),o=document.createElement("button");this.index=0,this.images=e.querySelectorAll("img"),this.max=Math.max(this.images.length,1),s.innerHTML="Next &raquo;",s.addEventListener("click",(()=>{this.showNext()})),o.innerHTML="Prev &laquo;",o.addEventListener("click",(()=>{this.showPrev()})),this.update(),t.appendChild(o),t.appendChild(document.createTextNode(" ")),t.appendChild(s),e.appendChild(t)}showNext(){this.index<this.max-1&&(this.index+=1),this.update()}showPrev(){this.index>0&&(this.index-=1),this.update()}update(){this.images.forEach(((e,t)=>{let s;s=e.madeResized?e.parentNode:e,s.style.display=t!==this.index?"none":"block"}))}}class PageList extends Component{static get selector(){return".pages"}constructor(e){super(e),e.addEventListener("wheel",(e=>this.wheel(e)))}wheel(e){e.preventDefault();const t=Math.sign(e.deltaY),s=Array.from(this.element.querySelectorAll("a")),o=parseInt(s[1].innerHTML,10),n=parseInt(s[s.length-1].innerHTML,10),i=s.length-2;if(t>0&&o+i<n||t<0&&o>2)for(let e=0;e<i;e+=1)s[e+1].href=s[e+1].href.replace(/\d+$/,e+o+t),s[e+1].innerHTML=o+e+t}}class Switch extends Component{static get selector(){return"input.switch"}constructor(e){super(e),e.style.display="none";const t=assign(document.createElement("button"),{type:"button",title:e.className,className:e.className}),s=()=>{t.style.backgroundPosition=e.checked?"top":"bottom"};s(),t.addEventListener("click",(()=>{e.checked=!e.checked,s(),e.dispatchEvent(new Event("change"))})),insertAfter(t,e)}}const ACTIVE_CLASS="active";class Tabs extends Component{static get selector(){return".tabs"}constructor(e){super(e),e.addEventListener("click",(e=>this.click(e)))}click(e){const{tabSelector:t}=this.element.dataset;let{target:s}=e;if("a"!==s.tagName.toLowerCase())return;t&&(s=s.closest(t));const o=this.element.querySelector(`.${ACTIVE_CLASS}`);o&&o.classList.remove(ACTIVE_CLASS),s.className=ACTIVE_CLASS,s.blur()}}const{userAgent:userAgent}=navigator;var Browser={ie:/msie/i.test(userAgent),mobile:/mobile/i.test(userAgent),n3ds:/nintendo 3ds/.test(userAgent),firefox:/firefox/i.test(userAgent),safari:/safari/i.test(userAgent)};const DISALLOWED_TAGS=["SCRIPT","STYLE","HR"];function htmlToBBCode(e){let t=e;const s=/<(\w+)([^>]*)>([^]*?)<\/\1>/gi;return t=t.replace(/[\r\n]+/g,""),t=t.replace(/<(hr|br|meta)[^>]*>/gi,"\n"),t=t.replace(/<img.*?src=["']?([^'"]+)["'](?: alt=["']?([^"']+)["'])?[^>]*\/?>/g,((e,t,s)=>s||`[img]${t}[/img]`)),t=t.replace(s,((e,t,o,n)=>{let i=s.test(n)?htmlToBBCode(n):n;const r={};o.replace(/(color|size|style|href|src)=(['"]?)(.*?)\2/gi,((e,t,s,o)=>{r[t]=o}));const{style:a=""}=r,l=t.toLowerCase();if(DISALLOWED_TAGS.includes(l))return"";const c=a.match(/text-align: ?(right|center|left)/i),d=a.match(/background(-color)?:[^;]+(rgb\([^)]+\)|#\s+)/i),h=a.match(/font-style: ?italic/i),u=a.match(/text-decoration:[^;]*underline/i),m=a.match(/text-decoration:[^;]*line-through/i),p=a.match(/font-size: ?([^;]+)/i),g=a.match(/color: ?([^;]+)/i),y=a.match(/font-weight: ?bold/i);return d&&(i=`[bgcolor=#${new Color(d[2]).toHex()}]${i}[/bgcolor]`),c&&(i=`[align=${c[1]}]${i}[/align]`),(h||"i"===l||"em"===l)&&(i=`[I]${i}[/I]`),(u||"u"===l)&&(i=`[U]${i}[/U]`),(m||"s"===l||"strike"===l)&&(i=`[S]${i}[/S]`),(y||"strong"===l||"b"===l)&&(i=`[B]${i}[/B]`),(r.size||p)&&(i=`[size=${r.size||p[1]}]${i}[/size]`),(r.color||g)&&(i=`[color=${r.color||g[1]}]${i}[/color]`),"a"===l&&r.href&&(i=`[url=${r.href}]${i}[/url]`),"ol"===l&&(i=`[ol]${i}[/ol]`),"ul"===l&&(i=`[ul]${i}[/ul]`),l.match(/h\d/i)&&(i=`[${l}]${i}[/${l}]`),"li"===l&&(i=`*${i.replace(/[\n\r]+/,"")}\n`),"p"===l&&(i=`\n${"&nbsp"===i?"":i}\n`),"div"===l&&(i=`\n${i}`),i})),t.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&nbsp;/g," ")}function bbcodeToHTML(e){let t=e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(\s) /g,"$1&nbsp;");return t=t.replace(/\[b\]([^]*?)\[\/b\]/gi,"<b>$1</b>"),t=t.replace(/\[i\]([^]*?)\[\/i\]/gi,"<i>$1</i>"),t=t.replace(/\[u\]([^]*?)\[\/u\]/gi,"<u>$1</u>"),t=t.replace(/\[s\]([^]*?)\[\/s\]/gi,"<s>$1</s>"),t=t.replace(/\[img\]([^'"[]+)\[\/img\]/gi,'<img src="$1">'),t=t.replace(/\[color=([^\]]+)\](.*?)\[\/color\]/gi,'<span style="color:$1">$2</span>'),t=t.replace(/\[size=([^\]]+)\](.*?)\[\/size\]/gi,'<span style="font-size:$1">$2</span>'),t=t.replace(/\[url=([^\]]+)\](.*?)\[\/url\]/gi,'<a href="$1">$2</a>'),t=t.replace(/\[bgcolor=([^\]]+)\](.*?)\[\/bgcolor\]/gi,'<span style="backgroun-color:$1">$2</span>'),t=t.replace(/\[h(\d)\](.*?)\[\/h\1\]/g,"<h$1>$2</h$1>"),t=t.replace(/\[align=(left|right|center)\](.*?)\[\/align\]/g,'<div style="text-align:$1">$2</div>'),t=t.replace(/\[(ul|ol)\]([^]*?)\[\/\1\]/gi,((e,t,s)=>`<${t}>${s.split(/(^|[\r\n]+)\*/).filter((e=>e.trim())).map((e=>`<li>${e}</li>`)).join("")}</${t}>`)),t=t.replace(/\n/g,"<br />"),t}const URL_REGEX=/^(ht|f)tps?:\/\/[\w.\-%&?=/]+$/,isURL=e=>URL_REGEX.test(e);class Editor extends Component{static get selector(){return"textarea.bbcode-editor"}constructor(e){super(e),this.iframe=document.createElement("iframe"),this.iframe.addEventListener("load",(()=>this.iframeLoaded())),this.iframe.style.display="none",insertAfter(this.iframe,e),e.closest("form").addEventListener("submit",(()=>{this.submit()}))}iframeLoaded(){const{iframe:e,element:t}=this;e.className="editorframe",this.mode=Browser.mobile||Browser.n3ds?0:globalsettings.wysiwyg,this.mode=this.mode||0,this.window=e.contentWindow,this.doc=e.contentWindow.document;const s=getComputedStyle$1(t),o=this.doc.getElementsByTagName("body")[0];o&&s&&(o.style.backgroundColor=s.backgroundColor,o.style.color=s.color,o.style.borderColor="#FFF"),this.doc.designMode="on",this.editbar=document.createElement("div"),this.buildEditBar(),e.style.height=`${t.clientHeight}px`,insertBefore(this.editbar,t),this.setSource("<div></div>"),setTimeout((()=>{this.setSource(bbcodeToHTML(t.value)),this.switchMode(this.mode)}),100)}buildEditBar(){this.editbar.className="editbar";const e=["Bold","Italic","Underline","Strike-Through","Foreground Color","Background Color","Insert Image","Insert Link","Insert email","Align left","Center","Align right","Insert video from any of your favorite video services!","Insert code","Insert Quote","Insert Spoiler","Create Ordered List","Create Unordered List","Insert Emoticon","Switch editor mode"];["bold","italic","underline","strikethrough","forecolor","backcolor","insertimage","createlink","c_email","justifyleft","justifycenter","justifyright","c_youtube","c_code","c_quote","c_spoiler","insertorderedlist","insertunorderedlist","c_smileys","c_switcheditmode"].forEach(((t,s)=>{const o=document.createElement("a");o.className=t,o.title=e[s],o.href="javascript:void(0)",o.unselectable="on",o.onclick=e=>this.editbarCommand(e,t),this.editbar.appendChild(o)}))}editbarCommand(e,t){switch(e.preventDefault(),t){case"forecolor":case"backcolor":this.showColors(e.pageX,e.pageY,t);break;case"c_smileys":this.showEmotes(e.pageX,e.pageY);break;case"c_switcheditmode":this.switchMode(Math.abs(this.mode-1));break;default:this.cmd(t)}}showEmotes(e,t){const s=this.emoteWindow;s?"none"===s.style.display?(s.style.display="",s.style.top=`${t}px`,s.style.left=`${e}px`):this.hideEmotes():(new Ajax).load("/api/?act=emotes",{callback:s=>this.createEmoteWindow(s,{x:e,y:t})})}hideEmotes(){this.emoteWindow&&(this.emoteWindow.style.display="none")}createEmoteWindow(e,t){const[s,o]=JSON.parse(e.responseText),n=document.createElement("div");n.className="emotewin",s.forEach(((e,t)=>{const s=o[t],i=document.createElement("a");i.href="javascript:void(0)",i.onclick=()=>{this.cmd("inserthtml",s),this.hideEmotes()},i.innerHTML=`${s} ${e}`,n.appendChild(i)})),n.style.position="absolute",n.style.display="none",this.emoteWindow=n,document.querySelector("#page").appendChild(n),this.showEmotes(t.x,t.y)}colorHandler(e,t){this.cmd(e,t),this.hideColors()}showColors(e,t,s){this.hideColors();const o=["#FFFFFF","#AAAAAA","#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"],n=o.length,i=Math.ceil(Math.sqrt(n)),r=document.createElement("table");assign(r.style,{borderCollapse:"collapse",position:"absolute",top:`${t}px`,left:`${e}px`});for(let e=0;e<i;e+=1){const t=r.insertRow(e);for(let n=0;n<i;n+=1){const r=t.insertCell(n),a=o[n+e*i];if(!a)continue;r.style.border="1px solid #000",r.style.padding=0;const l=document.createElement("a");l.href="javascript:void(0)",l.onclick=()=>this.colorHandler(s,a),r.appendChild(l),assign(l.style,{display:"block",backgroundColor:a,height:"20px",width:"20px",margin:0})}}return this.colorWindow=r,document.querySelector("#page").appendChild(r),null}hideColors(){this.colorWindow&&(this.colorWindow.parentNode.removeChild(this.colorWindow),this.colorWindow=void 0)}cmd(e,t){let s;const o=this.getSelection();let n,i=e,r=t;switch(e.toLowerCase()){case"bold":n=`[b]${o}[/b]`;break;case"italic":n=`[i]${o}[/i]`;break;case"underline":n=`[u]${o}[/u]`;break;case"strikethrough":n=`[s]${o}[/s]`;break;case"justifyright":n=`[align=right]${o}[/align]`;break;case"justifycenter":n=`[align=center]${o}[/align]`;break;case"justifyleft":n=`[align=left]${o}[/align]`;break;case"insertimage":if(r=prompt("Image URL:"),!r)return;if(!isURL(r))return void alert("Please enter a valid URL.");n=`[img]${r}[/img]`;break;case"insertorderedlist":this.mode||(n=`[ol]${o.replace(/(.+([\r\n]+|$))/gi,"*$1")}[/ol]`);break;case"insertunorderedlist":this.mode||(n=`[ul]${o.replace(/(.+([\r\n]+|$))/gi,"*$1")}[/ul]`);break;case"createlink":if(r=prompt("Link:"),!r)return;r.match(/^(https?|ftp|mailto):/)||(r=`https://${r}`),n=`[url=${r}]${o}[/url]`;break;case"c_email":if(r=prompt("Email:"),!r)return;i="createlink",r=`mailto:${r}`,n=`[url=${r}]${o}[/url]`;break;case"backcolor":(Browser.firefox||Browser.safari)&&(i="hilitecolor"),n=`[bgcolor=${r}]${o}[/bgcolor]`;break;case"forecolor":n=`[color=${r}]${o}[/color]`;break;case"c_code":i="inserthtml",r=`[code]${o}[/code]`,n=r;break;case"c_quote":i="inserthtml",r=prompt("Who said this?"),r=`[quote${r?`=${r}`:""}]${o}[/quote]`,n=r;break;case"c_spoiler":i="inserthtml",r=`[spoiler]${o}[/spoiler]`,n=r;break;case"c_youtube":if(i="inserthtml",r=prompt("Video URL?"),!r)return;r=`[video]${r}[/video]`,n=r;break;case"inserthtml":n=r;break;default:throw new Error(`Unsupported editor command ${e}`)}this.mode?"inserthtml"===i&&Browser.ie?(s=this.doc.selection.createRange(),s.text.length?(s.pasteHTML(r),s.collapse(!1),s.select()):this.doc.body.innerHTML+=r):(this.doc.execCommand(i,!1,r||!1),this.iframe.contentWindow.focus&&this.iframe.contentWindow.focus()):replaceSelection(this.element,n)}getSelection(){return this.mode?Browser.ie?this.doc.selection.createRange().text:this.window.getSelection():Browser.ie?(this.element.focus(),document.selection.createRange().text):this.element.value.substring(this.element.selectionStart,this.element.selectionEnd)}getSource(){return this.doc.body.innerHTML}setSource(e){this.doc&&this.doc.body&&(this.doc.body.innerHTML=e)}switchMode(e){const{element:t,iframe:s}=this;e?(this.setSource(bbcodeToHTML(t.value)),t.style.display="none",s.style.display=""):(t.value=htmlToBBCode(this.getSource()),t.style.display="",s.style.display="none"),this.mode=e}submit(){this.mode&&(this.switchMode(0),this.switchMode(1))}}class Drag{constructor(){this.droppables=[]}start(e,t,s){const o=new Event$1(e).cancel().stopBubbling(),n=t||e.target,i=getComputedStyle$1(n),r=getHighestZIndex();this.noChild&&(o.srcElement||o.target)!==(s||n)||"false"!==n.getAttribute("draggable")&&(this.sess={el:n,mx:parseInt(o.pageX,10),my:parseInt(o.pageY,10),ex:parseInt(i.left,10)||0,ey:parseInt(i.top,10)||0,info:{},bc:getCoordinates(n),zIndex:n.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<r-1)&&(n.style.zIndex=r),tryInvoke(this.onstart,{...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),this.boundEvents={drag:e=>this.drag(e),drop:e=>this.drop(e)},document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(o))}drag(e){const t=new Event$1(e).cancel(),s=this.sess.el.style;let o,n=!1;const i=parseInt(t.pageX,10),r=parseInt(t.pageY,10);let a,l=i,c=r,d=this.sess.ex+l-this.sess.mx,h=this.sess.ey+c-this.sess.my;const u=this.bounds;u&&(d<u[0]?(l=l-d+u[0],[d]=u):d>u[0]+u[2]&&(d=u[0]+u[2]),h<u[1]?(c=c-h+u[1],[h]=u):h>u[1]+u[3]&&(h=u[1]+u[3])),s.left=`${d}px`,s.top=`${h}px`,n=(o=this.sess.info).droptarget,o={left:d,top:h,e:t,el:this.sess.el,mx:l,my:c,droptarget:this.testDrops(i,r),dx:l-(o.mx||l),dy:c-(o.my||c),sx:this.sess.ex,sy:this.sess.ey},this.sess.info=o,tryInvoke(this.ondrag,o),o.droptarget&&n!==o.droptarget&&tryInvoke(this.ondragover,o),n&&o.droptarget!==n&&(a=o.droptarget,o.droptarget=n,tryInvoke(this.ondragout,o),o.droptarget=a)}boundingBox(e,t,s,o){return this.bounds=[e,t,s,o],this}drop(){return document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag),tryInvoke(this.ondrop,this.sess.info),this.autoZ||(this.sess.el.style.zIndex=this.sess.zIndex),!0}testDrops(e,t){const{droppables:s}=this;let o,n=!1,i=[9999,9999];return s.length?(s.forEach((s=>{s===this.sess.el||isChildOf(s,this.sess.el)||(o=getCoordinates(s),i[0]>o.w&&i[1]>o.h&&e>=o.x&&t>=o.y&&e<=o.xw&&t<=o.yh&&(i=[o.w,o.h],n=s))})),n):n}drops(e){return this.droppables=e,this}addDrops(e){return this.droppables?(this.droppables=this.droppables.concat(e),this):this.drops(e)}addListener(e){return assign(this,e),this}apply(e,t){if(Array.isArray(e))return e.forEach((e=>this.apply(e))),this;let s=getComputedStyle$1(e,"");return s=s.position,s&&"static"!==s||(e.style.position="relative"),(t||e).onmousedown=t?s=>this.start(s,e,t):t=>this.start(t,e),this}autoZ(){return this.autoZ=!0,this}noChildActivation(){return this.noChild=!0,this}reset(e=this.sess.el){return e.style.top=0,e.style.left=0,this}}class Window{constructor(e={}){assign(this,{title:"Title",wait:!0,content:"Content",open:!1,useoverlay:!1,minimizable:!0,resize:!1,className:"",pos:"center",zIndex:getHighestZIndex(),...e})}create(){if(this.windowContainer)return null;const e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),{pos:r}=this;this.windowContainer=e,this.id&&(e.id=this.id),this.contentcontainer=s,this.useOverlay&&toggleOverlay(!0,this.zIndex),e.className="window"+(this.className?` ${this.className}`:""),t.className="title",s.className="content",this.minimizable&&(n.innerHTML="-",n.onclick=()=>this.minimize()),i.innerHTML="X",i.onclick=()=>this.close(),o.appendChild(n),o.appendChild(i),o.className="controls",t.innerHTML=this.title,s.innerHTML=this.content,t.appendChild(o),e.appendChild(t),e.appendChild(s);const a=()=>this.close();if(e.querySelectorAll("[data-window-close]").forEach((e=>{e.addEventListener("click",a)})),document.body.appendChild(e),this.resize){const t=e.querySelector(this.resize);if(!t)throw new Error("Resize target not found");t.style.width=`${t.clientWidth}px`,t.style.height=`${t.clientHeight}px`;const s=document.createElement("div");s.className="resize",e.appendChild(s),s.style.left=e.clientWidth-16+"px",s.style.top=e.clientHeight-16+"px",(new Drag).boundingBox(100,100,1/0,1/0).addListener({ondrag(o){const n=parseFloat(t.style.width)+o.dx,i=parseFloat(t.style.height)+o.dy;t.style.width=`${n}px`,n<e.clientWidth-20?t.style.width=`${e.clientWidth}px`:s.style.left=e.clientWidth-16+"px",t.style.height=`${i}px`},ondrop(){s.style.left=e.clientWidth-16+"px"}}).apply(s),t.style.width=`${e.clientWidth}px`,s.style.left=e.clientWidth-16+"px"}return e.style.zIndex=this.zIndex+5,this.wait?onImagesLoaded(e.querySelectorAll("img")).then((()=>{this.setPosition(r)})):this.setPosition(r),this.drag=(new Drag).autoZ().noChildActivation().boundingBox(0,0,document.documentElement.clientWidth-50,document.documentElement.clientHeight-50).apply(e,t),e.close=()=>this.close(),e.minimize=this.minimize,e}close(){this.windowContainer&&(document.body.removeChild(this.windowContainer),this.windowContainer=null,this.onclose&&this.onclose(),this.useOverlay&&toggleOverlay(!1))}minimize(){const e=this.windowContainer,t=e.classList.contains("minimized");if(e.classList.toggle("minimized"),t)e.removeAttribute("draggable"),this.setPosition(this.oldpos,0);else{e.setAttribute("draggable","false");const t=Array.from(document.querySelectorAll(".window")).reduce(((e,t)=>t.classList.contains("minimized")?e+Number(t.clientWidth):e),0);this.oldpos=this.getPosition(),this.setPosition(`bl ${t} 0`,!1)}}setPosition(e,t){const s=this.windowContainer;let o=0,n=0;const i=document.documentElement.clientHeight,r=document.documentElement.clientWidth,a=e.match(/(\d+) (\d+)/);switch(a&&(o=Number(a[1]),n=Number(a[2])),o=Math.floor(o),n=Math.floor(n),"r"===e.charAt(1)&&(o=r-o-s.clientWidth),e.charAt(0)){case"b":n=i-n-s.clientHeight;break;case"c":n=(i-s.clientHeight)/2,o=(r-s.clientWidth)/2}o=Math.floor(o),n=Math.floor(n),o<0&&(o=0),n<0&&(n=0),s.style.left=`${o}px`,this.animate||t?new Animation(s,10).add("top",n-100+"px",`${n}px`).play():s.style.top=`${n}px`,this.pos=e}getPosition(){const e=this.windowContainer.style;return`tl ${parseFloat(e.left)} ${parseFloat(e.top)}`}}Window.close=function(e){let t=e;do{if(t.close){t.close();break}t=t.offsetParent}while(t)};class MediaPlayer extends Component{static get selector(){return".media"}constructor(e){super(e);const t=e.querySelector("a.popout"),s=e.querySelector("a.inline"),o=e.querySelector(".movie");t.addEventListener("click",(e=>{e.preventDefault();new Window({title:t.href,content:o.innerHTML}).create()})),s.addEventListener("click",(e=>{e.preventDefault(),o.style.display="block"}))}}function gracefulDegrade(e){updateDates();e.querySelectorAll("a").forEach((e=>{if(e.dataset.useTooltip&&e.addEventListener("mouseover",(()=>toolTip(e))),e.href){const t=e.getAttribute("href"),{host:s,pathname:o}=window.location;if(e.host===s&&e.pathname===o){const s=e.onclick;e.onclick=void 0,e.addEventListener("click",(o=>{o.preventDefault(),s&&!1===s.call(e)||RUN.stream.location(t)}))}else e.target="_BLANK"}}));const t=Array.from(e.querySelectorAll(".bbcodeimg"));t.length&&onImagesLoaded(t).then((()=>{imageResizer(t)})),e.querySelectorAll(".bbcode.code").forEach((e=>{e.addEventListener("click",(()=>selectAll(e)))})),[AutoComplete,CollapseBox,DatePicker,Editor,ImageGallery,MediaPlayer,PageList,Switch,Tabs].forEach((t=>{e.querySelectorAll(t.selector).forEach((e=>new t(e)))}));e.querySelectorAll("form[data-ajax-form]").forEach((e=>{const t="resetOnSubmit"===e.dataset.ajaxForm;e.addEventListener("submit",(s=>{s.preventDefault(),RUN.submitForm(e,t)}))})),Array.from(document.querySelectorAll(".idle")).forEach((e=>addIdleClock(e)))}let flashInterval,originalTitle="",lastTitle="";function stopTitleFlashing(){originalTitle&&(document.title=originalTitle),originalTitle="",clearInterval(flashInterval)}function flashTitle(e){document.hasFocus()||(stopTitleFlashing(),originalTitle||(originalTitle=document.title),lastTitle=e,flashInterval=setInterval((()=>{document.title=document.title===originalTitle?lastTitle:originalTitle}),1e3))}let Sound$1=class{constructor(){this.soundCache={}}load(e,t,s){let o=this.soundCache[e];o?s&&this.play(e):(o=new Audio,this.soundCache[e]=o,o.autoplay=!!s,o.src=t)}play(e){this.soundCache[e].play()}loadAndPlay(e,t){this.load(e,t,!0)}};var Sound$2=new Sound$1;function IMWindow(e,t){globalsettings.can_im?RUN.stream.commands.im([e,t,!1]):alert("You do not have permission to use this feature.")}function messageReceived({fromId:e,fromName:t,message:s,fromMe:o,timestamp:n}){notify(t,s);const i=createMessagingWindow({fromId:e,fromName:t,message:s});if(!s)return;const r=document.createElement("div"),a="/me"===s.substring(0,3);a&&(r.className="action",s=s.substring(3),t=`***${t}`),r.classList.add(o?"you":"them"),o||document.querySelector(`#im_${e}`).classList.remove("offline"),r.innerHTML=`<a href='?act=vu${o||parseInt(e,10)}' class='name'>${t}</a> ${a?"":": "}${s}`,r.dataset.timestamp=n;const l=i.scrollTop>i.scrollHeight-i.clientHeight-50;i.appendChild(r),l&&(i.scrollTop=i.scrollHeight),gracefulDegrade(r),!i&&globalsettings.sound_im&&Sound.play("imbeep")}function createMessagingWindow({fromId:e,fromName:t,message:s}){let o=document.querySelector(`#im_${e} .ims`);if(o)return o;const n=new Window({title:`${t}`,content:"\n            <div class='ims'></div>\n            <div class='offline'>This user may be offline</div>\n            <div>\n                <form data-ajax-form='resetOnSubmit' method='post'>\n                    <input type='hidden' name='im_uid' value='%s' />\n                    <input type='text' name='im_im' autocomplete='off' />\n                    <input type='hidden' name='act' value='blank' />\n                </form>\n            </div>\n        ".replace(/%s/g,e),className:"im",resize:".ims",animate:!0}).create();gracefulDegrade(n),n.id=`im_${e}`,n.onclick=()=>{n.querySelector("form").im_im.focus()},n.onclick(),o=document.querySelector(`#im_${e} .ims`);const i=getComputedStyle(o);return o.style.width=i.width,o.style.height=i.height,s&&globalsettings.sound_im&&Sound.play("imnewwindow"),o}function notify(e,t){if(flashTitle(`New message from ${e}!`),!document.hasFocus()&&window.Notification&&"granted"===Notification.permission){const s=new Notification(`${e} says:`,{body:t});s.onclick=()=>{window.focus(),s.close()}}}var Commands={loadscript([e]){document.body.appendChild(Object.assign(document.createElement("script"),{src:e}))},script(a){eval(a[0])},error(e){alert(e[0])},alert(e){alert(e[0])},reload(){window.location.reload()},refreshdata(){RUN.stream.pollData(!0)},addclass([e,t]){const s=document.querySelector(e);s&&s.classList.add(t)},title(e){document.title=e},update([e,t,s]){let o=e;const n=Array.from(document.querySelectorAll(".path"));if("path"===o&&n.length>1)return void n.forEach((e=>{e.innerHTML=t,gracefulDegrade(e)}));/^\W/.test(o)||(o=`#${o}`);const i=document.querySelector(o);i&&(i.innerHTML=t,s&&new Animation(i).dehighlight().play(),gracefulDegrade(i))},removeel(e){const t=document.querySelector(e[0]);t&&t.parentNode.removeChild(t)},overlay:toggleOverlay,back(){window.history.back()},setstatus([e]){const t=document.querySelector("#status");t&&(t.className=e)},appendrows(e){const t=document.querySelector(e[0]),s=document.createElement("span");s.innerHTML=`<table>${e[1]}</table>`;const o=s.getElementsByTagName("tbody")[0];gracefulDegrade(o),t.appendChild(o)},location([e]){"?"===e.charAt(0)?RUN.stream.location(e):document.location=e},enable([e]){const t=document.querySelector(`#${e}`);t&&(t.disabled=!1)},addshout([e]){const t=Array.from(document.querySelectorAll("#shoutbox .shout"));let s;const o=document.createElement("span");o.innerHTML=e;const n=o.firstChild;for(t[0].parentNode.insertBefore(n,t[0]);t.length>globalsettings.shoutlimit-1;)s=t.pop(),s.parentNode.removeChild(s);new Animation(n).dehighlight().play(),globalsettings.sound_shout&&Sound$2.play("sbblip"),gracefulDegrade(n)},tick([e]){const t=document.querySelector("#ticker");let s=document.createElement("div");s.className="tick",s.innerHTML=e,s.style.display="none",s.style.overflow="hidden",t.insertBefore(s,t.firstChild);let o=getComputedStyle$1(s);o=o.height,s.style.height="0px",new Animation(s).add("height","0px",o).play();const n=Array.from(t.querySelectorAll(".tick")),i=n.length;if(s.style.display="block",i>100)for(let e=100;e<i;e+=100)s=n[e],s.bonked||(s=n[e],new Animation(s,30,500).add("opacity","1","0").then((e=>{e.parentNode.removeChild(e)})).play(),s.bonked=!0)},im([e,t,s,o,n]){messageReceived({fromId:e,fromName:t,message:s,fromMe:o,timestamp:n})},imtoggleoffline(e){document.querySelector(`#im_${e}`).classList.add("offline")},window([options]){const existingWindow=options.id&&document.getElementById(options.id);if(existingWindow)return existingWindow.querySelector(".title").innerHTML=options.title,void(existingWindow.querySelector(".content").innerHTML=options.content);const win=new Window;win.title=options.title,win.content=options.content,win.minimizable=options.minimizable||0,win.useoverlay=options.useoverlay||0,win.animate=void 0===options.animate||options.animate,win.resize=options.resize||!1,win.className=options.className||"",options.onclose&&(win.onclose=eval(options.onclose)),options.pos&&(win.pos=options.pos);const winElement=win.create();winElement.id=options.id||"",gracefulDegrade(winElement)},closewindow([e]){const t=document.querySelector(e);t&&Window.close(t)},onlinelist(e){const t=document.querySelector("#statusers");t&&e[0].forEach((([e,s,o,n,i,r])=>{let a=document.querySelector(`#statusers .user${e}`);a||(a=document.createElement("a"),Number.isNaN(parseInt(e,10))||(a.href=`?act=vu${e}`),a.onclick=()=>{RUN.location(a.getAttribute("href"))}),a.innerHTML=n,a.className=`user${e} mgroup${s} ${o?` ${o}`:""} lastAction${r}`,i&&(a.title=i,a.onmouseover=()=>toolTip(a)),"idle"!==o?t.firstChild?t.insertBefore(a,t.firstChild):t.appendChild(a):addIdleClock(a)}))},setoffline(e){const t=document.querySelector("#statusers");e[0].split(",").forEach((e=>{const s=document.querySelector(`#statusers .user${e}`);s&&t.removeChild(s)}))},scrollToPost([e]){const t=document.getElementById(`pid_${e}`);return!!t&&(onImagesLoaded(document.querySelectorAll("#page img")).then((()=>{const e=getCoordinates(t);window.scrollTo({top:e.y})})),!0)},updateqreply(e){const t=document.querySelector("#qreply");t&&(t.querySelector("textarea").focus(),t.querySelector("textarea").value+=e[0])},newmessage([e,t]){let s=document.querySelector("#notification");const o=document.querySelector("#num-messages");o&&(o.innerHTML=parseInt(o.innerHTML,10)+1),s||(s=document.createElement("div"),s.id="notification",document.body.appendChild(s)),s.style.display="",s.className="newmessage",s.onclick=()=>{s.style.display="none",RUN.stream.location(`?act=ucp&what=inbox&view=${t}`,3)},s.innerHTML=e},playsound(e){Sound$2.loadAndPlay(e[0],e[1],!!e[2])},attachfiles(){document.querySelector("#attachfiles").addEventListener("click",(()=>{alert("Attaching files is under construction")}))},listrating([e,t]){let s,o=document.querySelector(`#postrating_${e}`);if(o){if("none"!==o.style.display)return void new Animation(o).add("height","200px","0px").then((()=>{o.style.display="none"})).play();o.style.display="block"}else o=document.createElement("div"),o.className="postrating_list",o.id=`postrating_${e}`,s=getCoordinates(document.querySelector(`#pid_${e} .postrating`)),o.style.top=`${s.yh}px`,o.style.left=`${s.x}px`,document.querySelector("#page").appendChild(o);o.innerHTML=t,new Animation(o).add("height","0px","200px").play()}};const UPDATE_INTERVAL=5e3;class Stream{constructor(){this.request=new Ajax({callback:e=>this.handleRequestData(e)}),this.lastURL=document.location.search.slice(1),this.commands=Commands}handleRequestData(e){if(200!==e.status)return;e.parsed=!0;let{responseText:t}=e,s=!1;"string"!=typeof t&&(t="");let o=[];if(t.length){try{o=JSON.parse(t)}catch(e){console.error(e),o=[]}o.forEach((([e,...t])=>{"softurl"===e?s=!0:this.commands[e]&&this.commands[e](t)}))}if(2===e.type){const t=e.url.substring(1);s||(window.history.pushState({queryParams:t},"",`?${t}`),window.dispatchEvent(new Event("pushstate")),this.lastURL=t)}this.pollData()}location(e,t=2){let s=e.split("?");return s=s[1]||s[0],this.request.load(`?${s}`,{requestType:t}),this.busy=!0,!1}load(...e){this.request.load(...e)}loader(){return this.request.load(`?${this.lastURL}`),!0}pollData(e){e&&this.loader(),clearTimeout(this.timeout),document.cookie.includes(`actw=${window.name}`)&&(this.timeout=setTimeout((()=>this.loader()),UPDATE_INTERVAL))}updatePage(e){e!==this.lastURL&&this.location(e,3)}}class AppState{onAppReady(){this.stream=new Stream,gracefulDegrade(document.body),updateDates(),setInterval(updateDates,3e4),this.stream.pollData(),window.addEventListener("popstate",(({state:e})=>{if(e){const{queryParams:t}=e;this.stream.updatePage(t)}else{const e=document.location.search.replace(/^\?/,"");this.stream.updatePage(e)}})),Sound$2.load("sbblip","./Sounds/blip.mp3",!1),Sound$2.load("imbeep","./Sounds/receive.mp3",!1),Sound$2.load("imnewwindow","./Sounds/receive.mp3",!1)}submitForm(e,t=!1){const s=[],o=[],{submitButton:n}=e;Array.from(e.elements).forEach((e=>{e.name&&"submit"!==e.type&&("select-multiple"!==e.type?["checkbox","radio"].includes(e.type)&&!e.checked||(s.push(e.name),o.push(e.value)):Array.from(e.options).filter((e=>e.selected)).forEach((t=>{s.push(`${e.name}[]`),o.push(t.value)})))})),n&&(s.push(n.name),o.push(n.value)),this.stream.load("?",{data:[s,o]}),t&&e.reset(),this.stream.pollData()}handleQuoting(e){this.stream.load(`${e.href}&qreply=${document.querySelector("#qreply")?"1":"0"}`)}setWindowActive(){document.cookie=`actw=${window.name}; SameSite:Lax`,stopTitleFlashing(),this.stream.pollData()}}const RUN$1=new AppState;onDOMReady((()=>{RUN$1.onAppReady()})),onDOMReady((()=>{window.name=Math.random(),RUN$1.setWindowActive(),window.addEventListener("focus",(()=>{RUN$1.setWindowActive()}))})),assign(window,{RUN:RUN$1,IMWindow:IMWindow})})();
