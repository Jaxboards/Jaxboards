var J=new Map;class x{element;constructor($){this.element=$}}function P($,H,h){if(!J.has($))J.set($,new WeakMap);H.forEach(function(E){if(J.get($)?.has(E))return;J.get($)?.set(E,new h(E))})}function k$($){let H=$.getHours()||12,h=`${$.getMinutes()}`.padStart(2,"0");return`${H%12||12}:${h}${H>12?"pm":"am"}`}function X($){return new Date($*1000)}var B$=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],G$=["January","February","March","April","May","June","July","August","September","October","November","December"];function r$($){return $[0].toUpperCase()+$.slice(1)}function y($){let H=new Date,h=new Intl.RelativeTimeFormat(void 0,{numeric:"auto",style:"long"}),L=new Date;L.setTime(+L-86400000),L.setHours(0),L.setMinutes(0),L.setSeconds(0);let E=X($),f=Math.round((+E-+H)/1000);if(f>-60)return h.format(f,"second");if(f>-3600)return h.format(Math.round(f/60),"minute");if(E>L){let M=new Date;return M.setHours(0),M.setMinutes(0),M.setSeconds(0),`${r$(h.format(E>M?0:-1,"day"))} @ ${k$(E)}`}return Intl.DateTimeFormat(void 0,{month:"short",year:"numeric",day:"numeric",hour:"numeric",hour12:!0,minute:"numeric"}).format(E)}function h$($){let H=X($),h=H.getHours(),L=h>=12?"pm":"am";h%=12,h=h||12;let E=`${H.getMinutes()}`.padStart(2,"0"),f=H.getMonth()+1,M=`${H.getDate()}`.padStart(2,"0"),T=H.getFullYear();return`${h}:${E}${L}, ${f}/${M}/${T}`}function L$($){let H=X($);return String.fromCodePoint(55357,56656+((H.getHours()%12||12)-1)+(H.getMinutes()>29?12:0))}function E$($){let H=Array.from($.classList).find((h)=>h.startsWith("lastAction"));if(H===void 0)return;$.prepend(L$(Number.parseInt(H.slice(10),10))),$.classList.remove(H)}class p extends x{static hydrate($){$.querySelectorAll(".idle").forEach((H)=>E$(H))}}function i$($=200){let H=document.querySelector("#snow");if(H===null){H=document.createElement("div"),H.id="snow",Object.assign(H.style,{position:"fixed",top:0,left:0,zIndex:1});let h=document.createElement("style");h.appendChild(document.createTextNode(`
            .snowflake {
                position: absolute;
                width: 10px;
                height: 10px;
                background: linear-gradient(white, white);
                /* Workaround for Chromium's selective color inversion */
                border-radius: 50%;
                filter: drop-shadow(0 0 10px white);
            }`)),document.body.prepend(h),document.body.prepend(H)}H.innerHTML="";for(let h=1;h<=$;h+=1){let L=document.createElement("div");L.className="snowflake",H.appendChild(L)}}function w$(){let $=document.getElementById("snow-css");if($)return $;return $=document.createElement("style"),$.id="snow-css",document.head.appendChild($),$}function d$($){let H=w$();H.innerHTML=$,document.head.appendChild(H)}function t$($=100){return Math.floor(Math.random()*$)+1}function o$($,H){let h=Math.ceil($),L=Math.floor(H);return Math.floor(Math.random()*(L-h+1))+h}function l$($,H){return Math.random()*(H-$)+$}function s$($=200){let h=100*document.body.offsetHeight/window.innerHeight,L="snowflake",E="";for(let f=1;f<=$;f+=1){let M=Math.random()*100,T=Math.random()*10,u=M+T,F=M+T/2,G=l$(0.3,0.8),j=G*h,b=Math.random(),H$=o$(10,h/10*3),R=t$(h/10*3)*-1,C$=Math.random();E+=`
      .snowflake:nth-child(${f}) {
        opacity: ${C$};
        transform: translate(${M}vw, -10px) scale(${b});
        animation: fall-${f} ${H$}s ${R}s linear infinite;
      }
      @keyframes fall-${f} {
        ${G*100}% {
          transform: translate(${u}vw, ${j}vh) scale(${b});
        }
        to {
          transform: translate(${F}vw, ${h}vh) scale(${b});
        }
      }
    `}d$(E)}function U($=200){s$($),i$($)}async function K($,H,h=600,L="linear"){return new Promise((E)=>{$.animate(H,{duration:h,easing:L}).addEventListener("finish",()=>{Object.assign($.style,H.at(-1)),E($)},{once:!0})})}function f$($){return K($,[{backgroundColor:"#FF0"},{backgroundColor:""}],1000)}function W($){return globalThis.getComputedStyle($)}function A($){let{x:H,y:h,height:L,width:E}=$.getBoundingClientRect(),f=H+globalThis.scrollX,M=h+globalThis.scrollY;return{x:f,y:M,yh:M+L,xw:f+E,w:E,h:L}}function A$($,H){return H.contains($)}function O($,H){H.before($)}function _$($,H){H.after($)}function q(){return Array.from(document.querySelectorAll("*")).reduce((h,L)=>{if(L.style.zIndex&&Number(L.style.zIndex)>h)return Number(L.style.zIndex);return h},0)+1}var K$="valid",Q$="invalid";class g extends x{method;outputElement;indicatorElement;static hydrate($){P("AutoComplete",$.querySelectorAll("input[data-autocomplete-action]"),this)}constructor($){super($);$.autocomplete="off",this.method=$.dataset.autocompleteAction;let H=$.dataset.autocompleteOutput,h=$.dataset.autocompleteIndicator,L=H?document.querySelector(H):void 0;if(!L)throw Error("Expected element to have data-autocomplete-output");this.outputElement=L||document.createElement("input"),this.indicatorElement=h?document.querySelector(h):void 0,$.addEventListener("keyup",(E)=>this.keyUp(E)),$.addEventListener("keydown",(E)=>{if(E.key==="Enter")E.preventDefault()})}getResultsContainer(){let $=A(this.element),H=document.querySelector("#autocomplete");if(!H)H=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(H.style,{zIndex:q()}),document.body.appendChild(H);return Object.assign(H.style,{top:`${$.yh}px`,left:`${$.x}px`,width:`${$.w}px`}),H}keyUp($){let H=this.getResultsContainer(),h=Array.from(H.querySelectorAll("div")),L=h.findIndex((E)=>E.classList.contains("selected"));switch($.key){case"ArrowUp":case"ArrowDown":h.at(L)?.classList.remove("selected"),h.at((L+($.key==="ArrowDown"?1:-1))%h.length)?.classList.add("selected");return;case"Enter":if(L>=0)h.at(L)?.dispatchEvent(new Event("click"));return;default:if(this.indicatorElement)this.indicatorElement.classList.remove(K$),this.indicatorElement.classList.add(Q$);if(this.clearResults(),this.element.value)this.doSearch();break}}clearResults(){let $=this.getResultsContainer();$.style.display="none",$.innerHTML=""}async doSearch(){let $=this.getResultsContainer(),H=/ACP/.test(document.location.toString())?"../":"",L=`term=${encodeURIComponent(this.element.value)}`,E=await fetch(`${H}/api/${this.method}?${L}`);if(!E.ok)return;let f=await E.json();if($.innerHTML="",f.length){$.style.display="";let[M,T]=f;M.forEach((u,F)=>{let G=T[F],j=document.createElement("div");j.innerHTML=G,j.addEventListener("click",()=>{if($.style.display="none",this.indicatorElement)this.indicatorElement.classList.add(K$),this.indicatorElement.classList.remove(Q$);this.outputElement.value=`${u}`,this.outputElement.dispatchEvent(new Event("change")),this.element.value=G}),$.appendChild(j)});return}$.style.display="none"}}function S$($){if(!globalThis.getSelection)return;let H=document.createRange();H.selectNode($);let h=globalThis.getSelection();if(!h)return;if(h.rangeCount)h.removeAllRanges();h.addRange(H)}function W$($,H){let h=$.scrollTop,L=$.selectionStart??0,E=$.selectionEnd??0;$.value=$.value.substring(0,L)+H+$.value.slice(E),$.selectionStart=L+H.length,$.selectionEnd=L+H.length,$.focus(),$.scrollTop=h}class v extends x{static hydrate($){P("CodeBlock",$.querySelectorAll(".bbcode.code"),this)}constructor($){super($);$.addEventListener("click",()=>S$($))}}class C extends x{fullHeight=0;animationLengthInMs=200;static hydrate($){P("CollapseBox",$.querySelectorAll(".collapse-box"),this)}constructor($){super($);let{collapseContent:H}=this;if(H)Object.assign(H.style,{transition:`height ${this.animationLengthInMs}ms ease-in-out`});this.toggle(),this.element.addEventListener("click",(h)=>{if(h.target instanceof HTMLElement&&h.target.matches(".collapse-button"))this.isOpen=!this.isOpen,this.toggle()})}get boxID(){return this.element.getAttribute("id")||""}get collapseContent(){return this.element.querySelector(".collapse-content")}get isOpen(){return!(globalThis.sessionStorage.getItem("collapsed")??"").split(",").includes(this.boxID)}set isOpen($){let H=(globalThis.sessionStorage.getItem("collapsed")??"").split(",").filter(Boolean);if($)H=H.filter((h)=>h!==this.boxID);else H.push(this.boxID);globalThis.sessionStorage.setItem("collapsed",H.join(",")??"")}toggle(){let{collapseContent:$}=this;if(!$)return;let{style:H}=$;if(this.isOpen){if(!this.fullHeight)return;H.height=`${this.fullHeight}px`,this.element.classList.remove("collapsed"),setTimeout(()=>{H.removeProperty("height"),H.removeProperty("overflow")},this.animationLengthInMs)}else this.fullHeight=$.clientHeight||$.offsetHeight,H.height=`${this.fullHeight}px`,H.overflow="hidden",this.element.classList.add("collapsed"),requestAnimationFrame(()=>{H.height="0px"})}}function Y($,H=1000){return new Promise((h)=>{let L=new Set,E=Array.from($).filter((M)=>!M.complete);if(!E.length){h();return}function f(){if(L.delete(this.src),L.size===0)h()}if(E.forEach((M)=>{if(!L.has(M.src))L.add(M.src),M.addEventListener("error",f),M.addEventListener("load",f)}),H)setTimeout(h,H)})}function D(){let $=document.querySelectorAll(".autodate"),H=Array.from(document.querySelectorAll("[data-timestamp]"));if(!$)return;$.forEach((h)=>{let L=Number.parseInt(h.getAttribute("title")??"",10),E=h.classList.contains("smalldate")?h$(L):y(L);if(E!==h.innerHTML)h.innerHTML=E}),H.forEach((h)=>{if(!h.title)h.title=h$(Number.parseInt(h.dataset.timestamp??"",10))})}function I($){if(document.readyState==="complete")$();else document.addEventListener("DOMContentLoaded",$)}function z$(){let $=document.createElement("input");return $.setAttribute("type","date"),$.type==="date"}function V$(){let $=[String.fromCodePoint(9757,127999),String.fromCodePoint(9757)].map((H)=>{let h=document.body.appendChild(document.createElement("span"));h.appendChild(document.createTextNode(H));let L=h.offsetWidth;return h.remove(),L});return $[0]===$[1]}class k extends x{picker;selectedDate;lastDate;static hydrate($){if(z$())return;P("DatePicker",$.querySelectorAll("input[type=date]"),this)}constructor($){super($);this.picker=this.getPicker(),$.autocomplete="off",$.addEventListener("focus",()=>this.openPicker()),$.addEventListener("keydown",()=>this.closePicker())}getPicker(){if(this.picker)return this.picker;let $=document.querySelector("#datepicker");if(!$)$=Object.assign(document.createElement("table"),{id:"datepicker"}),document.body.appendChild($),$.style.display="none";return $}openPicker(){let $=A(this.element);Object.assign(this.picker.style,{display:"",zIndex:q(),position:"absolute",top:`${$.yh}px`,left:`${$.x}px`});let[H,h,L]=this.element.value.split("/").map((E)=>Number.parseInt(E,10));if(H&&h&&L)this.selectedDate=[L,H-1,h];else this.selectedDate=void 0;this.generate(L,H,h)}closePicker(){this.picker.style.display="none"}generate($,H,h){let L=new Date,E=this.getPicker(),f,M,[T,u,F]=[$,H,h];if(T===void 0)T=L.getFullYear(),u=L.getMonth(),F=L.getDate(),this.selectedDate=[T,u,F];if(u===-1)T-=1,u=11;if(u===12)T+=1,u=0;this.lastDate=[T,u,F];let G=new Date(T,u+1,0).getDate(),j=new Date(T,u,1).getDay();E.innerHTML="",f=E.insertRow(0),M=f.insertCell(0),M.innerHTML="&lt;",M.className="control",M.addEventListener("click",()=>this.lastYear()),M=f.insertCell(1),M.colSpan=5,M.className="year",M.innerHTML=`${T}`,M=f.insertCell(2),M.innerHTML=">",M.className="control",M.addEventListener("click",()=>this.nextYear()),f=E.insertRow(1),M=f.insertCell(0),M.innerHTML="<",M.className="control",M.addEventListener("click",()=>this.lastMonth()),M=f.insertCell(1),M.colSpan=5,M.innerHTML=G$[u],M.className="month",M=f.insertCell(2),M.innerHTML=">",M.className="control",M.addEventListener("click",()=>this.nextMonth()),f=E.insertRow(2),f.className="weekdays";for(let b=0;b<7;b+=1)f.insertCell(b).innerHTML=B$[b];f=E.insertRow(3);for(let b=0;b<G;b+=1){if(!b)for(let R=0;R<j;R+=1)f.insertCell(R);if((j+b)%7===0)f=E.insertRow(E.rows.length);M=f.insertCell((j+b)%7),M.addEventListener("click",this.insert.bind(this,M));let H$=!!this.selectedDate&&T===this.selectedDate[0]&&u===this.selectedDate[1]&&b+1===this.selectedDate[2];M.className=`day${H$?" selected":""}`,M.innerHTML=`${b+1}`}}lastYear(){let $=this.lastDate;if($)this.generate($[0]-1,$[1],$[2])}nextYear(){let $=this.lastDate;if($)this.generate($[0]+1,$[1],$[2])}lastMonth(){let $=this.lastDate;if($)this.generate($[0],$[1]-1,$[2])}nextMonth(){let $=this.lastDate;if($)this.generate($[0],$[1]+1,$[2])}insert($){let H=this.lastDate;if(H)this.element.value=`${H[1]+1}/${$.innerHTML}/${H[0]}`;this.closePicker()}}class N${rgb;constructor($){let H=/^rgb\((\d+),\s?(\d+),\s?(\d+)\)/i.exec($),h=/#?([\da-fA-F]+)/.exec($);if(H){this.rgb=[Number.parseFloat(H[1]),Number.parseFloat(H[2]),Number.parseFloat(H[3])];return}if(h){let L=h[1];if(L.length===3)L=L.charAt(0)+L.charAt(0)+L.charAt(1)+L.charAt(1)+L.charAt(2)+L.charAt(2);if(L.length!==6){this.rgb=[0,0,0];return}this.rgb=[];for(let E=0;E<3;E+=1)this.rgb[E]=Number.parseInt(L.slice(E*2,(E+1)*2),16)}}invert(){if(this.rgb)this.rgb=[255-this.rgb[0],255-this.rgb[1],255-this.rgb[2]];return this}toRGB(){return this.rgb}toHex(){return"#"+this.rgb?.map(($)=>$.toString(16).padStart(2,"0")).join("")}}var M$=N$;var Y$={a:($,H)=>`[url=${H?.getAttribute("href")}]${$}[/url]`,b(...$){return this.strong(...$)},br:()=>`
`,div:($)=>`
${$}`,em:($)=>`[i]${$}[/i]`,font:($,H)=>{let h=H.style.fontFamily||H.getAttribute("face");return h?`[font=${h}]${$}[/font]`:$},h1:($)=>`[h1]${$}[/h1]`,h2:($)=>`[h2]${$}[/h2]`,h3:($)=>`[h3]${$}[/h3]`,h4:($)=>`[h4]${$}[/h4]`,h5:($)=>`[h5]${$}[/h5]`,h6:($)=>`[h6]${$}[/h6]`,hr:()=>`
`,i(...$){return this.em(...$)},img:($,H)=>{let h=H.getAttribute("alt")??"",L=H.getAttribute("src");if(H.dataset.emoji)return` ${H.dataset.emoji}`;if(L)return`[img]${L}[/img]`;return h},li:($)=>`* ${$.replace(/[\n\r]+/,"")}
`,meta:()=>`
`,ol:($)=>`[ol]${$}[/ol]`,p:($)=>`
${$==="&nbsp"?"":$}
`,strike:($)=>`[s]${$}[/s]`,strong:($)=>`[b]${$}[/b]`,u:($)=>`[u]${$}[/u]`,ul:($)=>`[ul]${$}[/ul]`},r={"background-color":($,H)=>{let h=$&&new M$($).toHex(),L=h?`${h}`:$;if(["ffffff","white","transparent"].includes(L))return H;return`[bgcolor=${L}]${H}[/bgcolor]`},color($,H){let h=$&&new M$($).toHex();return`[color=${h?`${h}`:$}]${H}[/color]`},"font-family":($,H)=>`[font=${$.replaceAll(/['"]/g,"")}]${H}[/font]`,"font-style":($,H)=>`[i]${H}[/i]`,"font-size":($,H)=>`[size=${$}]${H}[/size]`,"font-weight":($,H)=>`[b]${H}[/b]`,"text-align":($,H)=>`[align=${$}]${H}[/align]`,"text-decoration":function(H,h){return H==="line-through"?`[strike]${h}[/strike]`:`[u]${h}[/u]`}};function m$($){return $.replaceAll(/[\r\n]+/g,"").replaceAll("&amp;","&").replaceAll("&gt;",">").replaceAll("&lt;","<").replaceAll("&nbsp;"," ")}function T$($){let H=$.tagName.toLowerCase(),h="";for(let f of $.childNodes)h+=f.nodeType===Node.ELEMENT_NODE?T$(f):m$(f.textContent??"");if(H==="body")return h;if($.style){for(let f of $.style)if(f in r)h=r[f]($.style.getPropertyValue(f),h)}let L=$.getAttribute("size");if(L)h=r.fontSize(L,h);let E=$.getAttribute("color");if(E)h=r.color(E,h);if(H in Y$)h=Y$[H](h,$);return h}function u$($){return $.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(/(\s) /g,"$1&nbsp;").replaceAll(/\[b\]([^]*?)\[\/b\]/gi,"<b>$1</b>").replaceAll(/\[i\]([^]*?)\[\/i\]/gi,"<i>$1</i>").replaceAll(/\[u\]([^]*?)\[\/u\]/gi,"<u>$1</u>").replaceAll(/\[s\]([^]*?)\[\/s\]/gi,"<s>$1</s>").replaceAll(/\[img\]([^'"[]+)\[\/img\]/gi,'<img src="$1">').replaceAll(/\[color=([^\]]+)\]([^]*?)\[\/color\]/gi,'<span style="color:$1">$2</span>').replaceAll(/\[size=([^\]]+)\]([^]*?)\[\/size\]/gi,'<span style="font-size:$1">$2</span>').replaceAll(/\[font=['"]?([^\]]+?)['"]?\]([^]*?)\[\/font\]/gi,'<span style="font-family:$1">$2</span>').replaceAll(/\[url=([^\]]+)\]([^]*?)\[\/url\]/gi,'<a href="$1">$2</a>').replaceAll(/\[bgcolor=([^\]]+)\]([^]*?)\[\/bgcolor\]/gi,'<span style="background-color:$1">$2</span>').replaceAll(/\[h(\d)\]([^]*?)\[\/h\1\]/g,"<h$1>$2</h$1>").replaceAll(/\[align=(left|right|center)\]([^]*?)\[\/align\]/g,'<div style="text-align:$1">$2</div>').replaceAll(/\[(ul|ol)\]([^]*?)\[\/\1\]/gi,(H,h,L)=>{let f=L.split(/(^|[\r\n]+)\* ?/).filter((M)=>M.trim()).map((M)=>`<li>${M}</li>`).join("");return`<${h}>${f}</${h}>`}).replaceAll(`
`,"<br>")}var{userAgent:z}=navigator,x$={chrome:/chrome/i.test(z),ie:/msie/i.test(z),iphone:/iphone/i.test(z),mobile:/mobile/i.test(z),n3ds:/nintendo 3ds/.test(z),firefox:/firefox/i.test(z),safari:/safari/i.test(z)};function Q($){let H=document.createElement("div");return H.innerHTML=$,H.firstElementChild}var n$=/^(ht|f)tps?:\/\/[\w.\-%&?=/]+$/,a$=($)=>n$.test($),Z$={"Sans Serif":["Arial","Arial Black","Arial Narrow","Arial Rounded MT Bold","Avant Garde","Calibri","Candara","Century Gothic","Comic Sans MS","Franklin Gothic Medium","Futura","Geneva","Gill Sans","Helvetica","Impact","Lucida Grande","Optima","Segoe UI","Tahoma","Trebuchet MS","Verdana"],Serif:["Big Caslon","Bodoni MT","Book Antiqua","Calisto MT","Cambria","Didot","Garamond","Georgia","Goudy Old Style","Hoefler Text","Lucida Bright","Palatino","Perpetua","Rockwell","Rockwell Extra Bold","Baskerville","Times New Roman"],Monospaced:["Consolas","Courier New","Lucida Console","Lucida Sans Typewriter","Monaco","Andale Mono"],Fantasy:["Copperplate","Papyrus"],Script:["Brush Script MT"]};class i extends x{iframe;colorWindow;container;htmlMode=!0;editbar;emoteWindow;static hydrate($){P("Editor",$.querySelectorAll("textarea.bbcode-editor"),this)}constructor($){super($);this.container=Object.assign(document.createElement("div"),{className:"editor"}),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.addEventListener("load",()=>this.iframeLoaded(),{once:!0}),O(this.container,$),this.container.appendChild($),this.container.appendChild(this.iframe)}get doc(){return this.window?.document}get window(){return this.iframe.contentWindow}iframeLoaded(){let{iframe:$,element:H}=this;if($.className="editorframe",this.htmlMode=globalSettings.wysiwyg,H.addEventListener("input",()=>{this.setSource(u$(H.value))}),this.doc?.addEventListener("input",()=>{if(!this.doc)return;this.element.value=T$(this.doc.body)}),this.doc?.addEventListener("drop",(E)=>{if(!E.dataTransfer?.files.length)return;this.upload(E.dataTransfer.files[0])}),this.doc?.addEventListener("dragleave",()=>{this.getAttachmentStatus().remove()}),this.doc?.addEventListener("dragover",()=>{this.getAttachmentStatus()}),!this.doc)return;let h=W(H),L=this.doc.getElementsByTagName("body")[0];if(L&&h)L.style.backgroundColor=h.backgroundColor,L.style.color=h.color,L.style.borderColor="#FFF";this.doc.designMode="on",this.editbar=this.buildEditBar(),$.style.height=`${H.clientHeight}px`,O(this.editbar,H),this.setSource("<div></div>"),setTimeout(()=>{if(this.setSource(u$(H.value)),this.switchMode(this.htmlMode),H.hasAttribute("autofocus"))this.window?.focus()},100)}getAttachmentStatus(){let $=this.doc?.querySelector("#attachmentStatus");if($)return $;return $=document.createElement("div"),Object.assign($,{id:"attachmentStatus",innerHTML:"Drop file here",contentEditable:"false"}),Object.assign($.style,{position:"fixed",padding:"20px",top:"50%",left:"50%",translate:"-50% -50%",border:"2px dashed #ccc"}),this.doc?.body.appendChild($),$}upload($){let H=new FormData;H.append("Filedata",$);let h=new XMLHttpRequest;this.getAttachmentStatus().innerHTML='Uploading: <progress id="attachmentProgress"></div>';let L=this.getAttachmentStatus().querySelector("#attachmentProgress");h.upload.addEventListener("progress",(E)=>{if(L&&E.lengthComputable){let f=Math.round(E.loaded/E.total*100);L.value=E.loaded,L.max=E.total,L.textContent=`${f}%`}}),h.addEventListener("load",()=>{this.window?.focus(),this.getAttachmentStatus().remove();let E=h.responseText;if(/\D/.test(E)){alert("Error: "+E);return}this.cmd("inserthtml",`[attachment]${h.responseText}[/attachment]`)}),h.upload.addEventListener("error",()=>{this.getAttachmentStatus().remove()}),h.open("POST","/api/upload",!0),h.send(H)}buildEditBar(){let $=document.createElement("div");$.className="editbar",$.innerHTML=['<select class="fontface"><option value="">Default Font</option></select>','<a class="bold" title="Bold"></a>','<a class="italic" title="Italic"></a>','<a class="underline" title="Underline"></a>','<a class="strikethrough" title="Strike-Through"></a>','<a class="forecolor" title="Foreground Color"></a>','<a class="backcolor" title="Background Color"></a>','<a class="insertimage" title="Insert Image"></a>','<a class="createlink" title="Insert Link"></a>','<a class="c_email" title="Insert Email"></a>','<a class="justifyleft" title="Align Left"></a>','<a class="justifycenter" title="Center"></a>','<a class="justifyright" title="Align Right"></a>','<a class="c_youtube" title="Insert video from any of your favorite video services!"></a>','<a class="c_code" title="Insert code"></a>','<a class="c_quote" title="Insert Quote"></a>','<a class="c_spoiler" title="Insert Spoiler"></a>','<a class="insertorderedlist" title="Create Ordered List"></a>','<a class="insertunorderedlist" title="Create Unordered List"></a>','<a class="c_smileys" title="Insert Emoticon"></a>','<a class="c_switcheditmode" title="Switch editor mode"></a>'].join(""),$.addEventListener("click",(h)=>{if(h.target instanceof HTMLElement&&h.target.matches(".editbar a"))this.editbarCommand(h,h.target.className)});let H=$.querySelector("select.fontface");if(H){H.addEventListener("input",(h)=>{this.editbarCommand(h,"fontname",H.value)});for(let h of Object.keys(Z$)){let L=Z$[h].map((E)=>`<option style="font-family: ${E}">${E}</option>`);H.innerHTML+=`<optgroup label="${h}">${L}</optgroup>`}}return $}editbarCommand($,H,h){switch($.preventDefault(),H){case"forecolor":case"backcolor":this.showColors($.pageX,$.pageY,H);break;case"c_smileys":this.showEmotes($.pageX,$.pageY);break;case"c_switcheditmode":this.switchMode(!this.htmlMode);break;default:this.cmd(H,h);break}}async showEmotes($,H){let h=this.emoteWindow;if(!h){let L=await fetch("/api/emotes"),E=await L.json();if(L.ok)this.createEmoteWindow(E,{x:$,y:H});return}if(h.style.display==="none")h.style.display="",h.style.left=`${$}px`,h.style.top=`${H}px`;else this.hideEmotes()}hideEmotes(){if(this.emoteWindow)this.emoteWindow.style.display="none"}createEmoteWindow([$,H],h){let L=document.createElement("div");L.className="emotewin",$.forEach((E,f)=>{let M=H[f],T=document.createElement("a");T.href="javascript:void(0)",T.addEventListener("click",()=>{this.cmd("inserthtml",M),this.hideEmotes()}),T.innerHTML=`${M} ${E}`,L.appendChild(T)}),L.style.position="absolute",L.style.display="none",this.emoteWindow=L,document.querySelector("#page")?.appendChild(L),this.showEmotes(h.x,h.y)}colorHandler($,H){this.cmd($,H),this.hideColors()}showColors($,H,h){this.hideColors();let E=Q(`
      <div>
        ${["#FFFFFF","#AAAAAA","#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"].map((f)=>`<button style="background-color:${f}" data-color="${f}"></button>`).join("")}
      </div>
    `);return Object.assign(E.style,{display:"grid",gridTemplateColumns:"20px 20px 20px",gridTemplateRows:"20px 20px 20px",position:"absolute",top:`${H}px`,left:`${$}px`,cursor:"pointer",zIndex:q()}),E.addEventListener("click",(f)=>{if(f.target instanceof HTMLButtonElement&&f.target.dataset.color)this.colorHandler(h,f.target.dataset.color)}),this.colorWindow=E,document.querySelector("#page")?.appendChild(E),null}hideColors(){if(this.colorWindow)this.colorWindow.remove(),this.colorWindow=void 0}cmd($,H){let h=this.getSelection(),L="",E=$,f=H;switch($.toLowerCase()){case"bold":L=`[b]${h}[/b]`;break;case"italic":L=`[i]${h}[/i]`;break;case"underline":L=`[u]${h}[/u]`;break;case"strikethrough":L=`[s]${h}[/s]`;break;case"justifyright":L=`[align=right]${h}[/align]`;break;case"justifycenter":L=`[align=center]${h}[/align]`;break;case"justifyleft":L=`[align=left]${h}[/align]`;break;case"insertimage":if(f=prompt("Image URL:")||"",!f)return;if(!a$(f)){alert("Please enter a valid URL.");return}L=`[img]${f}[/img]`;break;case"insertorderedlist":if(!this.htmlMode)L=`[ol]${h.replaceAll(/(.+([\r\n]+|$))/i,"* $1")}[/ol]`;break;case"insertunorderedlist":if(!this.htmlMode)L=`[ul]${h.replaceAll(/(.+([\r\n]+|$))/i,"* $1")}[/ul]`;break;case"createlink":if(f=prompt("Link:")||"",!f)return;if(!/^(https?|ftp|mailto):/.test(f))f=`https://${f}`;L=`[url=${f}]${h}[/url]`;break;case"c_email":if(f=prompt("Email:")||"",!f)return;E="createlink",f=`mailto:${f}`,L=`[url=${f}]${h}[/url]`;break;case"backcolor":if(x$.firefox||x$.safari)E="hilitecolor";L=`[bgcolor=${f}]${h}[/bgcolor]`;break;case"forecolor":L=`[color=${f}]${h}[/color]`;break;case"fontname":L=`[font=${f}]${h}[/font]`;break;case"c_code":E="inserthtml",f=`[code]${h}[/code]`,L=f;break;case"c_quote":E="inserthtml",f=prompt("Who said this?")||"",f=f?`=${f}`:"",f=`[quote${f}]${h}[/quote]`,L=f;break;case"c_spoiler":E="inserthtml",f=`[spoiler]${h}[/spoiler]`,L=f;break;case"c_youtube":if(E="inserthtml",f=prompt("Video URL?")||"",!f)return;f=`[video]${f}[/video]`,L=f;break;case"inserthtml":L=f||"";break;default:throw Error(`Unsupported editor command ${$}`)}if(this.htmlMode)this.doc?.execCommand(E,!1,f),this.doc?.dispatchEvent(new Event("input")),this.window?.focus();else W$(this.element,L),this.element.dispatchEvent(new Event("input"))}getSelection(){if(this.htmlMode)return this.window?.getSelection()?.toString()||"";return this.element.value.substring(this.element.selectionStart,this.element.selectionEnd)}getSource(){return this.doc?.body.innerHTML}setSource($){if(this.doc)this.doc.body.innerHTML=$}switchMode($){let{element:H,iframe:h}=this;if($)H.style.display="none",h.style.display="";else H.style.display="",h.style.display="none";this.htmlMode=$}}class w extends x{resetOnSubmit;static hydrate($){P("Form",$.querySelectorAll("form[data-ajax-form]"),this)}constructor($){super($);this.resetOnSubmit=$.dataset.ajaxForm==="resetOnSubmit",$.addEventListener("submit",(H)=>{H.preventDefault(),this.submitForm()})}submitForm(){let{element:$,resetOnSubmit:H}=this,{submitButton:h}=$,L=new FormData($,h),E=Array.from(L.entries()).filter((f)=>typeof f[1]==="string");if(RUN.stream.load($.action||globalThis.location.toString(),{body:new URLSearchParams(E)}),H)$.reset();RUN.stream.pollData()}}class d extends x{index;images;max;static hydrate($){P("ImageGallery",$.querySelectorAll(".image_gallery"),this)}constructor($){super($);let H=document.createElement("div"),h=document.createElement("button"),L=document.createElement("button");this.index=0,this.images=$.querySelectorAll("img"),this.max=Math.max(this.images.length,1),h.innerHTML="Next &raquo;",h.addEventListener("click",()=>{this.showNext()}),L.innerHTML="Prev &laquo;",L.addEventListener("click",()=>{this.showPrev()}),this.update(),H.appendChild(L),H.appendChild(document.createTextNode(" ")),H.appendChild(h),$.appendChild(H)}showNext(){if(this.index<this.max-1)this.index+=1;this.update()}showPrev(){if(this.index>0)this.index-=1;this.update()}update(){this.images.forEach(($,H)=>{let h=$.dataset.madeResized?$.parentNode:$;if(h)h.style.display=H===this.index?"block":"none"})}}var R$="999999px";class t extends x{static async hydrate($){let H=$.querySelectorAll(".bbcodeimg");await Y(Array.from(H)),P("ImageResizer",H,this)}constructor($){super($);let H=1,h=1,{naturalWidth:L,naturalHeight:E}=$,f=W($),M=Number.parseInt(f.width,10)||Number.parseInt(f.maxWidth,10),T=Number.parseInt(f.height,10)||Number.parseInt(f.maxHeight,10);if(M&&L>M)H=M/E;if(T&&E>T)h=T/E;if(H=H&&h?Math.min(H,h):h||H,H<1)this.makeResizer(L*H,E*H)}makeResizer($,H){let{element:h}=this;h.style.maxWidth=R$,h.style.maxHeight=R$,h.dataset.madeResized="true";let L=Object.assign(document.createElement("a"),{target:"_blank",href:h.src});Object.assign(L.style,{display:"block",overflow:"hidden",width:`${$}px`,height:`${H}px`}),L.dataset.nw=`${h.naturalWidth}`,L.dataset.nh=`${h.naturalHeight}`,L.addEventListener("mousemove",(f)=>{let{x:M,y:T,w:u,h:F}=A(L);L.scrollLeft=(f.pageX-M)/u*(+(L.dataset.nw||0)-u)||0,L.scrollTop=(f.pageY-T)/F*(+(L.dataset.nh||0)-F)||0}),L.addEventListener("mouseover",()=>{h.style.width=`${L.dataset.nw}px`,h.style.height=`${L.dataset.nh}px`});let E=()=>{if(L.scrollLeft)L.scrollLeft=0,L.scrollTop=0;h.style.width=`${$}px`,h.style.height=`${H}px`};L.addEventListener("mouseout",E),E(),O(L,h),L.appendChild(h)}}function c($){let H=A($),h=$.getAttribute("title");if($.dataset.lastOnline){let E=Number.parseInt($.dataset.lastOnline??"",10);h=`Last Online: ${y(E)} ${L$(E)}`}if(!h)return;let L=document.querySelector("#tooltip");if(!L)L=Q('<div id="tooltip" class="tooltip">Default text</div>'),document.querySelector("#page")?.appendChild(L);$.title="",$.addEventListener("mouseout",()=>{$.title=h,L.style.display="none"}),L.innerText=h,L.style.display="",Object.assign(L.style,{top:`${H.y-L.offsetHeight}px`,left:`${H.x}px`,zIndex:`${q()}`})}class o extends x{static hydrate($){P("Link",$.querySelectorAll("a"),this)}constructor($){super($);if($.dataset.useTooltip)$.addEventListener("mouseover",()=>c($));if(!$.href)return;let H=$.getAttribute("href"),h=!$.target&&H&&(H.startsWith("/")||H.startsWith("?"));if(H?.startsWith("javascript"))return;if(h){let E=$.onclick;$.onclick=null,$.addEventListener("click",(f)=>{if(f.preventDefault(),!E||E.call($,f)!==!1)RUN.stream.location(H)});return}$.target="_blank"}}class U${sess;boundEvents;droppables;noChild=!1;bounds;onstart;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[],this.sess={el:document.body,mx:0,my:0},this.boundEvents={drag:($)=>this.drag($),drop:()=>this.drop()}}start($,H,h){$.preventDefault(),$.stopPropagation();let L=H||$.target,E=W(L),f=q();if(this.noChild&&$.target!==(h||L))return;if(L.getAttribute("draggable")==="false")return;if(this.sess={el:L,mx:$.pageX,my:$.pageY,ex:Number.parseInt(E.left,10)||0,ey:Number.parseInt(E.top,10)||0,info:{el:L,mx:0,my:0},zIndex:L.style.zIndex},!this.sess.zIndex||Number(this.sess.zIndex)<f-1)L.style.zIndex=`${f}`;this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag($)}drag($){$.stopPropagation();let H=this.sess.el.style,h=$.pageX,L=$.pageY,E=h,f=L,M,T=(this.sess.ex??0)+E-this.sess.mx,u=(this.sess.ey??0)+f-this.sess.my,F=this.bounds;if(F){if(T<F[0])E=E-T+F[0],[T]=F;else if(T>F[0]+F[2])T=F[0]+F[2];if(u<F[1])f=f-u+F[1],[u]=F;else if(u>F[1]+F[3])u=F[1]+F[3]}H.left=`${T}px`,H.top=`${u}px`;let G=this.sess.info,j=G?.droptarget,b={left:T,top:u,el:this.sess.el,mx:E,my:f,dx:E-(G?.mx||E),dy:f-(G?.my||f),droptarget:this.testDrops(h,L)};if(this.sess.info=b,this.ondrag?.(b),b.droptarget&&j!==b.droptarget)this.ondragover?.(b);if(j&&b.droptarget!==j)M=b.droptarget,b.droptarget=j,this.ondragout?.(b),b.droptarget=M}boundingBox($,H,h,L){return this.bounds=[$,H,h,L],this}drop(){if(this.boundEvents)document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag);if(this.ondrop?.(this.sess.info??{}),this.autoZIndex)this.sess.el.style.zIndex=this.sess.zIndex??"";return!0}testDrops($,H){let{droppables:h}=this,L,E=[9999,9999];if(!h.length)return;return h.findLast((f)=>{if(f===this.sess.el||A$(f,this.sess.el))return;if(L=A(f),E[0]>L.w&&E[1]>L.h&&$>=L.x&&H>=L.y&&$<=L.xw&&H<=L.yh)return E=[L.w,L.h],f;return})}drops($){return this.droppables=$,this}addDrops($){if(!this.droppables)return this.drops($);return this.droppables=this.droppables.concat($),this}addListener($){return Object.assign(this,$),this}apply($,H){if(Array.isArray($))return $.forEach((E)=>this.apply(E)),this;let L=W($)?.position;if(!L||L==="static")$.style.position="relative";return(H||$).onmousedown=H?(E)=>this.start(E,$,H):(E)=>this.start(E,$),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset($=this.sess.el){return $.style.top="0",$.style.left="0",this}}var F$=U$;class O${title="Title";wait=!0;content="Content";open=!1;minimizable=!0;resize;className="";pos="center";zIndex;windowContainer;id;onclose;animate=!0;oldpos="";constructor($={}){this.zIndex=q(),Object.assign(this,$)}render(){let $=Q(`
      <div id="${this.id||""}" class="window ${this.className}">
        <div class="title">
          ${this.title}
          <div class="controls">
            ${this.minimizable?'<button data-action="minimize">-</button>':""}
            <button data-action="close" data-shortcut="Escape">X</button>
          </div>
        </div>
        <div class="content">${this.content}</div>
      </div>`);this.windowContainer=$,$.addEventListener("click",(E)=>{if(E.target instanceof HTMLElement){let f=E.target.dataset.action;if(f&&f in this)this[f]()}});let H=document.querySelector(".windows");if(!H)H=Q('<div class="windows" style="z-index: 1"></div>'),document.body.appendChild(H);if(H.appendChild($),this.resize)this.renderResizeHandle(this.resize);let h=$.style;h.zIndex=`${this.zIndex+5}`;let{pos:L}=this;if(this.wait)Y(Array.from($.querySelectorAll("img"))).then(()=>{this.setPosition(L)});else this.setPosition(L);return new F$().autoZ().noChildActivation().boundingBox(0,0,document.documentElement.clientWidth-50,document.documentElement.clientHeight-50).apply($,$.querySelector(".title")||void 0),$}renderResizeHandle($){let{windowContainer:H}=this;if(!H)return;let h=H.querySelector($);if(!h)throw Error("Resize target not found");h.style.width=`${h.clientWidth}px`,h.style.height=`${h.clientHeight}px`;let L=Q('<div class="resize"></div>');H.appendChild(L),L.style.left=`${H.clientWidth-16}px`,L.style.top=`${H.clientHeight-16}px`,new F$().boundingBox(100,100,1/0,1/0).addListener({ondrag(E){let f=Number.parseFloat(h.style.width)+(E.dx??0),M=Number.parseFloat(h.style.height)+(E.dy??0);if(h.style.width=`${f}px`,f<H.clientWidth-20)h.style.width=`${H.clientWidth}px`;else L.style.left=`${H.clientWidth-16}px`;h.style.height=`${M}px`},ondrop(){L.style.left=`${H.clientWidth-16}px`}}).apply(L),h.style.width=`${H.clientWidth}px`,L.style.left=`${H.clientWidth-16}px`}close(){if(!this.windowContainer)return;if(this.windowContainer.remove(),this.windowContainer=void 0,this.onclose)this.onclose()}minimize(){let{windowContainer:$}=this;if(!$)return;let H=!$.classList.toggle("minimized");if($.querySelector(".controls [data-action=minimize]").innerHTML=H?"-":"\uD83D\uDDD6",H)$.removeAttribute("draggable");else $.setAttribute("draggable","false"),this.oldpos=this.getPosition();this.setPosition(H?this.oldpos:"",!1)}setPosition($,H=!0){let h=this.windowContainer;if(!h)return;let L=0,E=0,f=document.documentElement.clientHeight,M=document.documentElement.clientWidth;if($==="center")E=Math.floor((f-h.clientHeight)/2),L=Math.floor((M-h.clientWidth)/2);else{let T=/(\d+) (\d+)/.exec($);if(T)L=Number(T[1]),E=Number(T[2])}if(h.style.left=`${L}px`,this.animate&&H)K(h,[{top:`${E-100}px`},{top:`${E}px`}],300,"ease-out");else h.style.top=`${E}px`;this.pos=$}getPosition(){if(!this.windowContainer)return"";let $=this.windowContainer.style;return`${Number.parseFloat($.left)} ${Number.parseFloat($.top)}`}}var S=O$;class l extends x{static hydrate($){P("MediaPlayer",$.querySelectorAll(".media"),this)}constructor($){super($);let H=$.querySelector("a.popout"),h=$.querySelector("a.inline"),L=$.querySelector(".movie");if(!L)return;H?.addEventListener("click",(E)=>{E.preventDefault(),new S({title:H.href,content:L.innerHTML}).render()}),h?.addEventListener("click",(E)=>{E.preventDefault(),L.style.display="block"})}}class s extends x{static hydrate($){P("PageList",$.querySelectorAll(".pages"),this)}constructor($){super($);$.addEventListener("wheel",(H)=>this.wheel(H))}wheel($){$.preventDefault();let H=Math.sign($.deltaY),h=Array.from(this.element.querySelectorAll("a")),L=Number.parseInt(h[1].innerHTML,10),E=Number.parseInt(h.at(-1)?.innerHTML||"",10),f=h.length-2;if(H>0&&L+f<E||H<0&&L>2)for(let M=0;M<f;M+=1)h[M+1].href=h[M+1].href.replace(/\d+$/,`${M+L+H}`),h[M+1].innerHTML=`${L+M+H}`}}class m extends x{static hydrate($){P("Switch",$.querySelectorAll("input.switch"),this)}constructor($){super($);$.style.display="none";let H=Object.assign(document.createElement("button"),{type:"button",title:$.className,className:$.className}),h=()=>{H.style.backgroundPosition=$.checked?"top":"bottom"};h(),H.addEventListener("click",()=>{$.checked=!$.checked,h(),$.dispatchEvent(new Event("change"))}),_$(H,$)}}var b$="active";class n extends x{static hydrate($){P("Tabs",$.querySelectorAll(".tabs"),this)}constructor($){super($);$.addEventListener("click",(H)=>this.click(H))}click($){let{tabSelector:H}=this.element.dataset,{target:h}=$;if(!h||!(h instanceof HTMLElement)||h.tagName.toLowerCase()!=="a")return;let L=h;if(H){let f=h.closest(H);if(f)L=f}let E=this.element.querySelector(`.${b$}`);if(E)E.classList.remove(b$);L.className=b$,L.blur()}}function B($){D(),[g,v,C,k,i,w,p,d,t,o,l,s,m,n].forEach((H)=>{H.hydrate($)})}var P$="50px";class D${success($){this.showToast($,"success",3000)}error($){this.showToast($,"error")}async showToast($,H,h=0){let L=document.createElement("div"),E=async()=>{await K(L,[{top:P$},{top:`-${P$}`}]),L.remove()};L.classList.add(H),Object.assign(L.style,{position:"fixed",left:"50%",transform:"translateX(-50%)",boxShadow:"black 5px 5px 10px",zIndex:q()}),L.addEventListener("click",E,{once:!0}),L.innerHTML=$;let f=document.createElement("a");if(f.href="javascript:void(0)",f.innerHTML=" [X]",f.title="close notification",f.addEventListener("click",E,{once:!0}),L.append(f),document.body.appendChild(L),await K(L,[{top:"0"},{top:P$}],600,"ease-in-out"),h)await new Promise((M)=>setTimeout(M,h)),E()}}var V=new D$;class I${soundCache={};load($,H,h){let L=this.soundCache[$];if(L){if(h)this.play($);return}L=new Audio,this.soundCache[$]=L,L.autoplay=!!h,L.src=H}play($){this.soundCache[$].play()}loadAndPlay($,H){this.load($,H,!0)}}var _=new I$;var Z={loadscript($){document.body.appendChild(Object.assign(document.createElement("script"),{src:$}))},script($){(0,eval)($)},error($){V.error($)},success($){V.success($)},reload($=0){setTimeout(()=>globalThis.location.reload(),$)},refreshdata(){RUN.stream.pollData(!0)},addclass($,H){let h=document.querySelector($);if(h)h.classList.add(H)},title($){document.title=$},update($,H,h){let L=$,E=Array.from(document.querySelectorAll(".path"));if(L==="path"&&E.length>1){E.forEach((T)=>{T.innerHTML=H,B(T)});return}if(!/^\W/.test(L))L=`#${L}`;let f=document.querySelector(L);if(!f)return;f.innerHTML=H;let M=f.querySelector("[autofocus]");if(M)M.focus();if(h)f$(f);B(f)},removeel($){let H=document.querySelector($);if(H)H.remove()},back(){globalThis.history.back()},setstatus($){let H=document.querySelector("#status");if(H)H.className=$},appendrows($,H){let h=document.querySelector($);if(!h)return;let L=document.createElement("span");L.innerHTML=`<table>${H}</table>`;let E=L.getElementsByTagName("tbody")[0];B(E),h.appendChild(E)},location($){if(["?","/"].includes($.charAt(0))){RUN.stream.location($);return}document.location=$},enable($){let H=document.querySelector(`#${$}`);if(H)H.disabled=!1},addshout($){let H=Array.from(document.querySelectorAll("#shoutbox .shout")),h=document.createElement("span");h.innerHTML=$;let L=h.firstElementChild;if(!L)return;H[0].parentNode?.insertBefore(L,H[0]);while(H.length>globalSettings.shoutLimit-1)H.pop()?.remove();if(f$(L),globalSettings.soundShout)_.play("sbblip");B(L)},tick($){let H=document.querySelector("#ticker");if(!H)return;let h=document.createElement("div");h.innerHTML=$,h=h.firstElementChild,H.insertBefore(h,H.firstChild);let L=Array.from(H.querySelectorAll(".tick"));for(let E=100;E<L.length;E+=100)L[E].remove()},im($,H,h,L,E){c$({fromId:$,fromName:H,message:h,fromMe:L,timestamp:E})},imtoggleoffline($){document.querySelector(`#im_${$}`)?.classList.add("offline")},window($){if($.id&&document.getElementById($.id))return;let h=new S($);B(h.render())},closewindow($){let H=document.querySelector($+" [data-action=close]");if(H)H.click()},onlinelist($){let H=document.querySelector("#statusers");if(!H)return;$.forEach((h)=>{let L=document.querySelector(`#statusers .user${h.uid}`);if(!L)L=document.createElement("a"),L.addEventListener("click",function(){if(this.href)RUN.stream.location(this.href)}),L.addEventListener("mouseover",function(){c(this)});if(h.profileURL)L.href=h.profileURL;if(L.innerHTML=h.name,L.className=[`user${h.uid}`,`mgroup${h.groupID}`,h.status,`lastAction${h.lastAction}`].join(" "),h.locationVerbose)L.title=h.locationVerbose;if(h.status==="idle"){E$(L);return}if(H.firstChild)H.insertBefore(L,H.firstChild);else H.appendChild(L)})},snow($){U($)},setoffline($){let H=document.querySelector("#statusers");$.split(",").forEach((L)=>{let E=document.querySelector(`#statusers .user${L}`);if(E&&H)E.remove()})},async scrollToPost($){let H=document.getElementById(`pid_${$}`);if(!H)return!1;await Y(Array.from(document.querySelectorAll("#page img")));let h=A(H);return globalThis.scrollTo({top:h.y}),!0},updateqreply($){let h=document.querySelector("#qreply")?.querySelector("textarea");if(h)h.focus(),h.value+=$,h.dispatchEvent(new Event("input"))},newmessage($,H){let h=document.querySelector("#notification"),L=document.querySelector("#num-messages");if(L)L.innerHTML=`${Number.parseInt(L.innerHTML,10)+1}`;if(!h)h=document.createElement("div"),h.id="notification",document.body.appendChild(h);h.style.display="",h.className="newmessage",h.addEventListener("click",()=>{h.style.display="none",RUN.stream.location(`/ucp/inbox?view=${H}`,3)}),h.innerHTML=$},playsound($,H){_.loadAndPlay($,H)},listrating($,H){let h=document.querySelector(`#postrating_${$}`),L;if(h){if(h.style.display!=="none"){K(h,[{height:"200px"},{height:"0px"}],300).then((E)=>E.style.display="none");return}h.style.display="block"}else{h=document.createElement("div"),h.className="postrating_list",h.id=`postrating_${$}`;let E=document.querySelector(`#pid_${$} .postrating`);if(!E)return;L=A(E),h.style.top=`${L.yh}px`,h.style.left=`${L.x}px`,document.querySelector("#page")?.appendChild(h)}h.innerHTML=H,K(h,[{height:"0px"},{height:"200px"}],300)}};var X$,N="",J$="";function j$(){if(N)document.title=N;N="",clearInterval(X$)}function y$($){if(document.hasFocus())return;if(j$(),!N)N=document.title;J$=$,X$=setInterval(()=>{document.title=document.title===N?J$:N},1000)}function e$($,H){if(y$(`New message from ${$}!`),!document.hasFocus()&&globalThis.Notification&&Notification.permission==="granted"){let h=new Notification(`${$} says:`,{body:H});h.onclick=()=>{globalThis.focus(),h.close()}}}function $H({fromId:$,fromName:H,message:h}){let L=document.querySelector(`#im_${$} .ims`);if(L)return L;let f=new S({title:`${H}`,content:`
            <div class='ims'></div>
            <div class='offline'>This user may be offline</div>
            <div>
                <form data-ajax-form='resetOnSubmit' method='post'>
                    <input type='hidden' name='im_uid' value='%s'>
                    <input type='text' name='im_im' autocomplete='off'>
                </form>
            </div>
        `.replaceAll("%s",`${$}`),className:"im",resize:".ims",animate:!0,id:`im_${$}`}).render();B(f);let M=()=>{f.querySelector('form input[name="im_im"]')?.focus()};f.addEventListener("click",M),M(),L=f.querySelector(".ims");let T=getComputedStyle(L);if(L.style.width=T.width,L.style.height=T.height,h&&globalSettings.soundIM)_.play("imnewwindow");return L}function q$($,H){if(!globalSettings.canIM){alert("You do not have permission to use this feature.");return}Z.im($,H,"",1,Date.now())}function c$({fromId:$,fromName:H,message:h,fromMe:L,timestamp:E}){e$(H,h);let f=$H({fromId:$,fromName:H,message:h});if(!h)return;let M=document.createElement("div"),T=h.startsWith("/me");if(T)M.className="action",h=h.substring(3),H=`***${H}`;if(M.classList.add(L?"you":"them"),!L)document.querySelector(`#im_${$}`)?.classList.remove("offline");M.innerHTML=`<a href='/profile/${L||$}' class='name'>${H}</a> ${T?"":": "}${h}`,M.dataset.timestamp=`${E}`;let u=f.scrollTop>f.scrollHeight-f.clientHeight-50;if(f.appendChild(M),u)f.scrollTop=f.scrollHeight;if(B(M),globalSettings.soundIM)_.play("imbeep")}function HH($){let H=$?$.split(","):[],h=H.length===1?"":"s",L=H.length?" and <br>":"";return[H,h,L]}function hH($){let H=$?$.split(","):[],L=(H?H.length:0)===1?"":"s";return[H,L]}class a{whichone=0;boundCheckLocation;pids=[];tids=[];modb;constructor(){this.boundCheckLocation=()=>this.checkLocation(),Object.assign(Z,{modcontrols_clearbox:this.destroyModControls.bind(this),modcontrols_move:this.showMoveControls.bind(this),modcontrols_postsync:this.postSync.bind(this)})}checkLocation(){let{whichone:$}=this,h=($?/topic\/(\d+)/:/forum\/(\d+)/).exec(document.location.toString());if(h)this.moveTo(Number(h[1]));else this.showMoveControls($)}moveTo($){let{whichone:H}=this;this.renderModControls(`<form method="post" action="/modcontrols" data-ajax-form="true">
                move ${H?"posts":"topics"} here?
            <input type="hidden"
                name="${H?"dop":"dot"}"
                value="moveto">
            <input type="hidden" name="id" value="${$}">
            <input type="submit" value="Yes">
            <input type="submit" name="cancel" value="Cancel" onclick="this.form.submitButton=this">
            </form>`)}renderModControls($){if(this.modb=this.modb||document.querySelector("#modbox")||void 0,!this.modb)this.modb=document.createElement("div"),this.modb.id="modbox",document.body.appendChild(this.modb);this.modb.style.display="block",this.modb.innerHTML=$,B(this.modb)}destroyModControls(){if(globalThis.removeEventListener("pushstate",this.boundCheckLocation),this.modb)this.modb.innerHTML="",this.modb.style.display="none"}togbutton($){$.classList.toggle("selected")}postSync($,H){let[h,L,E]=HH($),[f,M]=hH(H);if(this.tids=f,this.pids=h,!f.length&&!h.length){this.destroyModControls();return}let T=f.length?`
            <select name="dot">
                <option value="delete">Delete</option>
                <option value="merge">Merge</option>
                <option value="move">Move</option>
                <option value="pin">Pin</option>
                <option value="unpin">Unpin</option>
                <option value="lock">Lock</option>
                <option value="unlock">Unlock</option>
            </select> &nbsp; &nbsp;
            <strong>${f.length}</strong> topic${M}${E}`:"",u=h.length?`
            <select name="dop">
                <option value="delete">Delete</option>
                <option value="move">Move</option>
            </select> &nbsp; &nbsp;
            <strong>${h.length}</strong> post${L}`:"",F=h.length&&f.length?"<br>":" &nbsp; &nbsp; ",G=`
        <form method="post" action="/modcontrols" data-ajax-form="true">
            ${T}
            ${u}
            ${F}
            <input type="submit" value="Go">
            <input
                name="cancel" type="submit"
                onclick="this.form.submitButton=this;" value="Cancel">
        </form>`;this.renderModControls(G)}showMoveControls($){this.whichone=$,globalThis.addEventListener("pushstate",this.boundCheckLocation),this.renderModControls(`Ok, now browse to the ${this.whichone?"topic":"forum"} you want to move the ${this.whichone?`${this.pids.length} posts`:`${this.tids.length} topics`} to...`)}}function LH(){new S({title:"Keyboard Shortcuts",id:"shortcuts",content:`
      <style>
        #shortcuts { width: 300px; }
        #shortcuts dt { float: left;margin-left: 5px;}
      </style>
      <h3>Navigation</h3>
      <dl>
        <dt>?</dt><dd>This help window</dd>
        <dt>h</dt><dd>Home / Board Index</dd>
        <dt>i</dt><dd>Inbox</dd>
        <dt>s</dt><dd>Settings</dd>
        `+(globalSettings.isAdmin?"<dt>a</dt><dd>Admin CP</dd>":"")+(globalSettings.isMod?"<dt>m</dt><dd>Moderator CP</dd>":"")+`</dl>

      <h3>Inbox</h3>
      <dl>
        <dt>c</dt><dd>Compose</dd>
        <dt>i</dt><dd>Inbox</dd>
        <dt>f</dt><dd>Flagged Messages</dd>
        <dt>r</dt><dd>Reply to Message</dd>
      </dl>

      <h3>Forum/Topic</h3>
      <dl>
        <dt>t</dt><dd>New Topic</dd>
        <dt>r</dt><dd>Reply</dd>
      </dl>
      `}).render()}function p$($){if($.target instanceof HTMLInputElement||$.target instanceof HTMLTextAreaElement||$.target instanceof HTMLSelectElement)return;if($.key==="?"){LH();return}document.documentElement.querySelector(`[data-shortcut="${$.key}"]`)?.click()}var EH=5000;class e{commands;lastURL;timeout;constructor(){this.lastURL=`${document.location.pathname}${document.location.search}`,this.commands=Z}handleRequestData($,H,h=1){let L=!1;if(H.forEach(([E,...f])=>{if(E==="preventNavigation")L=!0;else if(E in this.commands)this.commands[E].apply(null,f)}),h>=2){if(!L)globalThis.history.pushState({lastURL:$},"",$),globalThis.dispatchEvent(new Event("pushstate")),this.lastURL=$}this.pollData()}location($,H=2){this.load($,{requestType:H})}async load($,{body:H,method:h="POST",requestType:L=1}={}){try{let E=await fetch($,{method:h,body:H,headers:{"X-JSACCESS":`${L}`,"Content-Type":"application/x-www-form-urlencoded"}});if(E.ok){let f=await E.json();this.handleRequestData($,f,L);return}V.error("An unrecoverable error has occurred.<br>Please try again later.")}catch(E){if(!navigator.onLine)V.error("You appear to be offline.");else V.error("Network fetch failed: timeout")}}pollData($=!1){if($)this.load(this.lastURL);if(clearTimeout(this.timeout),document.cookie.includes(`actw=${window.name}`))this.timeout=setTimeout(()=>this.load(this.lastURL),EH)}updatePage($){if($!==this.lastURL)this.location($,3)}}var fH=2;class g${stream=new e;onAppReady(){if(fH)B(document.body);let $=new Date;if($.getMonth()===11&&[23,24,25].includes($.getDate()))U();D(),setInterval(D,30000),this.stream.pollData(),globalThis.addEventListener("popstate",({state:h})=>{if(h){let{lastURL:L}=h;this.stream.updatePage(L)}else this.stream.updatePage(document.location.toString())}),_.load("sbblip","/Sounds/blip.mp3",!1),_.load("imbeep","/Sounds/receive.mp3",!1),_.load("imnewwindow","/Sounds/receive.mp3",!1)}handleQuoting($){let H=new URLSearchParams($.search),h=H.get("quote");if(h){let L=document.querySelector(`#pid_${h} .post_content`),E=window.getSelection();if(L&&E&&L.contains(E.anchorNode)&&L.contains(E.focusNode))H.set("quotedText",E.toString())}H.set("qreply",document.querySelector("#qreply")?"1":"0"),this.stream.load(`${$.pathname}?${H.toString()}`)}setWindowActive(){document.cookie=`actw=${window.name}; SameSite:Lax`,j$(),this.stream.pollData()}}var $$=new g$;I(()=>{$$.onAppReady()});I(()=>{window.name=`${Math.random()}`,$$.setWindowActive(),globalThis.addEventListener("focus",()=>{$$.setWindowActive()})});I(function(){if(!V$())document.documentElement.classList.add("no-emoji");document.documentElement.classList.add("js-enabled")});I(()=>{globalThis.addEventListener("keyup",p$)});var v$=$$;Object.assign(globalThis,{RUN:v$,IMWindow:q$,ModControls:new a});
