"use strict";(()=>{var V=new Map,u=class{element;constructor(t){this.element=t}};function h(o,t,e){V.has(o)||V.set(o,new WeakMap),t.forEach(function(s){V.get(o)?.has(s)||V.get(o)?.set(s,new e(s))})}function jt(o){let t=o.getHours()||12,e=`${o.getMinutes()}`.padStart(2,"0");return`${t%12||12}:${e}${t>12?"pm":"am"}`}function Z(o){return new Date(o*1e3)}var vt=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],Tt=["January","February","March","April","May","June","July","August","September","October","November","December"];function zt(o){return o[0].toUpperCase()+o.slice(1)}function J(o){let t=new Date,e=new Intl.RelativeTimeFormat(void 0,{numeric:"auto",style:"long"}),n=new Date;n.setTime(+n-1e3*60*60*24),n.setHours(0),n.setMinutes(0),n.setSeconds(0);let s=Z(o),i=Math.round((+s-+t)/1e3);if(i>-60)return e.format(i,"second");if(i>-3600)return e.format(Math.round(i/60),"minute");if(s>n){let r=new Date;return r.setHours(0),r.setMinutes(0),r.setSeconds(0),`${zt(e.format(s>r?0:-1,"day"))} @ ${jt(s)}`}return Intl.DateTimeFormat(void 0,{month:"short",year:"numeric",day:"numeric",hour:"numeric",hour12:!0,minute:"numeric"}).format(s)}function et(o){let t=Z(o),e=t.getHours(),n=e>=12?"pm":"am";e%=12,e=e||12;let s=`${t.getMinutes()}`.padStart(2,"0"),i=t.getMonth()+1,r=`${t.getDate()}`.padStart(2,"0"),a=t.getFullYear();return`${e}:${s}${n}, ${i}/${r}/${a}`}function nt(o){let t=Z(o);return String.fromCodePoint(55357,56656+((t.getHours()%12||12)-1)+(t.getMinutes()>29?12:0))}function ot(o){let t=Array.from(o.classList).find(e=>e.startsWith("lastAction"));t!==void 0&&(o.prepend(nt(Number.parseInt(t.slice(10),10))),o.classList.remove(t))}var C=class extends u{static hydrate(t){t.querySelectorAll(".idle").forEach(e=>ot(e))}};async function L(o,t,e=600,n="linear"){return new Promise(s=>{o.animate(t,{duration:e,easing:n}).addEventListener("finish",()=>{Object.assign(o.style,t.at(-1)),s(o)},{once:!0})})}function st(o){return L(o,[{backgroundColor:"#FF0"},{backgroundColor:""}],1e3)}function T(o){return globalThis.getComputedStyle(o)}function b(o){let{x:t,y:e,height:n,width:s}=o.getBoundingClientRect(),i=t+globalThis.scrollX,r=e+globalThis.scrollY;return{x:i,y:r,yh:r+n,xw:i+s,w:s,h:n}}function xt(o,t){return t.contains(o)}function A(o,t){t.before(o)}function Mt(o,t){t.after(o)}function y(){return Array.from(document.querySelectorAll("*")).reduce((e,n)=>n.style.zIndex&&Number(n.style.zIndex)>e?Number(n.style.zIndex):e,0)+1}var wt="valid",$t="invalid",k=class extends u{method;outputElement;indicatorElement;static hydrate(t){h("AutoComplete",t.querySelectorAll("input[data-autocomplete-action]"),this)}constructor(t){super(t),t.autocomplete="off",this.method=t.dataset.autocompleteAction;let e=t.dataset.autocompleteOutput,n=t.dataset.autocompleteIndicator,s=e?document.querySelector(e):void 0;if(!s)throw new Error("Expected element to have data-autocomplete-output");this.outputElement=s||document.createElement("input"),this.indicatorElement=n?document.querySelector(n):void 0,t.addEventListener("keyup",i=>this.keyUp(i)),t.addEventListener("keydown",i=>{i.key==="Enter"&&i.preventDefault()})}getResultsContainer(){let t=b(this.element),e=document.querySelector("#autocomplete");return e||(e=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(e.style,{zIndex:y()}),document.body.appendChild(e)),Object.assign(e.style,{top:`${t.yh}px`,left:`${t.x}px`,width:`${t.w}px`}),e}keyUp(t){let e=this.getResultsContainer(),n=Array.from(e.querySelectorAll("div")),s=n.findIndex(i=>i.classList.contains("selected"));switch(t.key){case"ArrowUp":case"ArrowDown":n.at(s)?.classList.remove("selected"),n.at((s+(t.key==="ArrowDown"?1:-1))%n.length)?.classList.add("selected");return;case"Enter":s>=0&&n.at(s)?.dispatchEvent(new Event("click"));return;default:this.indicatorElement&&(this.indicatorElement.classList.remove(wt),this.indicatorElement.classList.add($t)),this.clearResults(),this.element.value&&this.doSearch();break}}clearResults(){let t=this.getResultsContainer();t.style.display="none",t.innerHTML=""}async doSearch(){let t=this.getResultsContainer(),e=/ACP/.test(document.location.toString())?"../":"",s=`term=${encodeURIComponent(this.element.value)}`,i=await fetch(`${e}/api/${this.method}?${s}`);if(!i.ok)return;let r=await i.json();if(t.innerHTML="",r.length){t.style.display="";let[a,l]=r;a.forEach((d,c)=>{let f=l[c],p=document.createElement("div");p.innerHTML=f,p.addEventListener("click",()=>{t.style.display="none",this.indicatorElement&&(this.indicatorElement.classList.add(wt),this.indicatorElement.classList.remove($t)),this.outputElement.value=`${d}`,this.outputElement.dispatchEvent(new Event("change")),this.element.value=f}),t.appendChild(p)});return}t.style.display="none"}};function Ht(o){if(!globalThis.getSelection)return;let t=document.createRange();t.selectNode(o);let e=globalThis.getSelection();e&&(e.rangeCount&&e.removeAllRanges(),e.addRange(t))}function St(o,t){let e=o.scrollTop,n=o.selectionStart??0,s=o.selectionEnd??0;o.value=o.value.substring(0,n)+t+o.value.slice(s),o.selectionStart=n+t.length,o.selectionEnd=n+t.length,o.focus(),o.scrollTop=e}var D=class extends u{static hydrate(t){h("CodeBlock",t.querySelectorAll(".bbcode.code"),this)}constructor(t){super(t),t.addEventListener("click",()=>Ht(t))}};var I=class extends u{fullHeight=0;animationLengthInMs=200;static hydrate(t){h("CollapseBox",t.querySelectorAll(".collapse-box"),this)}constructor(t){super(t);let{collapseContent:e}=this;e&&Object.assign(e.style,{transition:`height ${this.animationLengthInMs}ms ease-in-out`}),this.toggle(),this.element.addEventListener("click",n=>{n.target instanceof HTMLElement&&n.target.matches(".collapse-button")&&(this.isOpen=!this.isOpen,this.toggle())})}get boxID(){return this.element.getAttribute("id")||""}get collapseContent(){return this.element.querySelector(".collapse-content")}get isOpen(){return!(globalThis.sessionStorage.getItem("collapsed")??"").split(",").includes(this.boxID)}set isOpen(t){let e=(globalThis.sessionStorage.getItem("collapsed")??"").split(",").filter(Boolean);t?e=e.filter(n=>n!==this.boxID):e.push(this.boxID),globalThis.sessionStorage.setItem("collapsed",e.join(",")??"")}toggle(){let{collapseContent:t}=this;if(!t)return;let{style:e}=t;if(this.isOpen){if(!this.fullHeight)return;e.height=`${this.fullHeight}px`,this.element.classList.remove("collapsed"),setTimeout(()=>{e.removeProperty("height"),e.removeProperty("overflow")},this.animationLengthInMs)}else this.fullHeight=t.clientHeight||t.offsetHeight,e.height=`${this.fullHeight}px`,e.overflow="hidden",this.element.classList.add("collapsed"),requestAnimationFrame(()=>{e.height="0px"})}};function $(o,t=1e3){return new Promise(e=>{let n=new Set,s=Array.from(o).filter(r=>!r.complete);if(!s.length){e();return}function i(){n.delete(this.src),n.size===0&&e()}s.forEach(r=>{n.has(r.src)||(n.add(r.src),r.addEventListener("error",i),r.addEventListener("load",i))}),t&&setTimeout(e,t)})}function N(){let o=document.querySelectorAll(".autodate"),t=Array.from(document.querySelectorAll("[data-timestamp]"));o&&(o.forEach(e=>{let n=Number.parseInt(e.getAttribute("title")??"",10),s=e.classList.contains("smalldate")?et(n):J(n);s!==e.innerHTML&&(e.innerHTML=s)}),t.forEach(e=>{e.title||(e.title=et(Number.parseInt(e.dataset.timestamp??"",10)))}))}function q(o){document.readyState==="complete"?o():document.addEventListener("DOMContentLoaded",o)}function Ct(){let o=document.createElement("input");return o.setAttribute("type","date"),o.type==="date"}function At(){let o=[String.fromCodePoint(9757,127999),String.fromCodePoint(9757)].map(t=>{let e=document.body.appendChild(document.createElement("span"));e.appendChild(document.createTextNode(t));let n=e.offsetWidth;return e.remove(),n});return o[0]===o[1]}var R=class extends u{picker;selectedDate;lastDate;static hydrate(t){Ct()||h("DatePicker",t.querySelectorAll("input[type=date]"),this)}constructor(t){super(t),this.picker=this.getPicker(),t.autocomplete="off",t.addEventListener("focus",()=>this.openPicker()),t.addEventListener("keydown",()=>this.closePicker())}getPicker(){if(this.picker)return this.picker;let t=document.querySelector("#datepicker");return t||(t=Object.assign(document.createElement("table"),{id:"datepicker"}),document.body.appendChild(t),t.style.display="none"),t}openPicker(){let t=b(this.element);Object.assign(this.picker.style,{display:"",zIndex:y(),position:"absolute",top:`${t.yh}px`,left:`${t.x}px`});let[e,n,s]=this.element.value.split("/").map(i=>Number.parseInt(i,10));e&&n&&s?this.selectedDate=[s,e-1,n]:this.selectedDate=void 0,this.generate(s,e,n)}closePicker(){this.picker.style.display="none"}generate(t,e,n){let s=new Date,i=this.getPicker(),r,a,[l,d,c]=[t,e,n];l===void 0&&(l=s.getFullYear(),d=s.getMonth(),c=s.getDate(),this.selectedDate=[l,d,c]),d===-1&&(l-=1,d=11),d===12&&(l+=1,d=0),this.lastDate=[l,d,c];let f=new Date(l,d+1,0).getDate(),p=new Date(l,d,1).getDay();i.innerHTML="",r=i.insertRow(0),a=r.insertCell(0),a.innerHTML="&lt;",a.className="control",a.addEventListener("click",()=>this.lastYear()),a=r.insertCell(1),a.colSpan=5,a.className="year",a.innerHTML=`${l}`,a=r.insertCell(2),a.innerHTML=">",a.className="control",a.addEventListener("click",()=>this.nextYear()),r=i.insertRow(1),a=r.insertCell(0),a.innerHTML="<",a.className="control",a.addEventListener("click",()=>this.lastMonth()),a=r.insertCell(1),a.colSpan=5,a.innerHTML=Tt[d],a.className="month",a=r.insertCell(2),a.innerHTML=">",a.className="control",a.addEventListener("click",()=>this.nextMonth()),r=i.insertRow(2),r.className="weekdays";for(let m=0;m<7;m+=1)r.insertCell(m).innerHTML=vt[m];r=i.insertRow(3);for(let m=0;m<f;m+=1){if(!m)for(let S=0;S<p;S+=1)r.insertCell(S);(p+m)%7===0&&(r=i.insertRow(i.rows.length)),a=r.insertCell((p+m)%7),a.addEventListener("click",this.insert.bind(this,a));let tt=!!this.selectedDate&&l===this.selectedDate[0]&&d===this.selectedDate[1]&&m+1===this.selectedDate[2];a.className=`day${tt?" selected":""}`,a.innerHTML=`${m+1}`}}lastYear(){let t=this.lastDate;t&&this.generate(t[0]-1,t[1],t[2])}nextYear(){let t=this.lastDate;t&&this.generate(t[0]+1,t[1],t[2])}lastMonth(){let t=this.lastDate;t&&this.generate(t[0],t[1]-1,t[2])}nextMonth(){let t=this.lastDate;t&&this.generate(t[0],t[1]+1,t[2])}insert(t){let e=this.lastDate;e&&(this.element.value=`${e[1]+1}/${t.innerHTML}/${e[0]}`),this.closePicker()}};var it=class{rgb;constructor(t){let e=/^rgb\((\d+),\s?(\d+),\s?(\d+)\)/i.exec(t),n=/#?([\da-fA-F]+)/.exec(t);if(e){this.rgb=[Number.parseFloat(e[1]),Number.parseFloat(e[2]),Number.parseFloat(e[3])];return}if(n){let s=n[1];if(s.length===3&&(s=s.charAt(0)+s.charAt(0)+s.charAt(1)+s.charAt(1)+s.charAt(2)+s.charAt(2)),s.length!==6){this.rgb=[0,0,0];return}this.rgb=[];for(let i=0;i<3;i+=1)this.rgb[i]=Number.parseInt(s.slice(i*2,(i+1)*2),16)}}invert(){return this.rgb&&(this.rgb=[255-this.rgb[0],255-this.rgb[1],255-this.rgb[2]]),this}toRGB(){return this.rgb}toHex(){return"#"+this.rgb?.map(t=>t.toString(16).padStart(2,"0")).join("")}},rt=it;var kt={a:(o,t)=>`[url=${t?.getAttribute("href")}]${o}[/url]`,b(...o){return this.strong(...o)},br:()=>`
`,div:o=>`
${o}`,em:o=>`[i]${o}[/i]`,font:(o,t)=>`[font=${t.style.fontFamily||t.getAttribute("face")}]${o}[/font]`,h1:o=>`[h1]${o}[/h1]`,h2:o=>`[h2]${o}[/h2]`,h3:o=>`[h3]${o}[/h3]`,h4:o=>`[h4]${o}[/h4]`,h5:o=>`[h5]${o}[/h5]`,h6:o=>`[h6]${o}[/h6]`,hr:()=>`
`,i(...o){return this.em(...o)},img:(o,t)=>{let e=t.getAttribute("alt")??"",n=t.getAttribute("src");return t.dataset.emoji?` ${t.dataset.emoji}`:n?`[img]${n}[/img]`:e},li:o=>`*${o.replace(/[\n\r]+/,"")}
`,meta:()=>`
`,ol:o=>`[ol]${o}[/ol]`,p:o=>`
${o==="&nbsp"?"":o}
`,strike:o=>`[s]${o}[/s]`,strong:o=>`[b]${o}[/b]`,u:o=>`[u]${o}[/u]`,ul:o=>`[ul]${o}[/ul]`},K={"background-color":(o,t)=>{let e=o&&new rt(o).toHex(),n=e?`${e}`:o;return["ffffff","white","transparent"].includes(n)?t:`[bgcolor=${n}]${t}[/bgcolor]`},color(o,t){let e=o&&new rt(o).toHex();return`[color=${e?`${e}`:o}]${t}[/color]`},"font-family":(o,t)=>`[font=${o.replaceAll(/['"]/g,"")}]${t}[/font]`,"font-style":(o,t)=>`[i]${t}[/i]`,"font-size":(o,t)=>`[size=${o}]${t}[/size]`,"font-weight":(o,t)=>`[b]${t}[/b]`,"text-align":(o,t)=>`[align=${o}]${t}[/align]`,"text-decoration":function(t,e){return t==="line-through"?`[strike]${e}[/strike]`:`[u]${e}[/u]`}};function Ot(o){return o.replaceAll(/[\r\n]+/g,"").replaceAll("&amp;","&").replaceAll("&gt;",">").replaceAll("&lt;","<").replaceAll("&nbsp;"," ")}function at(o){let t=o.tagName.toLowerCase(),e="";for(let i of o.childNodes)e+=i.nodeType===Node.ELEMENT_NODE?at(i):Ot(i.textContent??"");if(t==="body")return e;if(o.style)for(let i of o.style)i in K&&(e=K[i](o.style.getPropertyValue(i),e));let n=o.getAttribute("size");n&&(e=K.fontSize(n,e));let s=o.getAttribute("color");return s&&(e=K.color(s,e)),t in kt&&(e=kt[t](e,o)),e}function lt(o){return o.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(/(\s) /g,"$1&nbsp;").replaceAll(/\[b\]([^]*?)\[\/b\]/gi,"<b>$1</b>").replaceAll(/\[i\]([^]*?)\[\/i\]/gi,"<i>$1</i>").replaceAll(/\[u\]([^]*?)\[\/u\]/gi,"<u>$1</u>").replaceAll(/\[s\]([^]*?)\[\/s\]/gi,"<s>$1</s>").replaceAll(/\[img\]([^'"[]+)\[\/img\]/gi,'<img src="$1">').replaceAll(/\[color=([^\]]+)\]([^]*?)\[\/color\]/gi,'<span style="color:$1">$2</span>').replaceAll(/\[size=([^\]]+)\]([^]*?)\[\/size\]/gi,'<span style="font-size:$1">$2</span>').replaceAll(/\[font=['"]?([^\]]+?)['"]?\]([^]*?)\[\/font\]/gi,'<span style="font-family:$1">$2</span>').replaceAll(/\[url=([^\]]+)\]([^]*?)\[\/url\]/gi,'<a href="$1">$2</a>').replaceAll(/\[bgcolor=([^\]]+)\]([^]*?)\[\/bgcolor\]/gi,'<span style="background-color:$1">$2</span>').replaceAll(/\[h(\d)\]([^]*?)\[\/h\1\]/g,"<h$1>$2</h$1>").replaceAll(/\[align=(left|right|center)\]([^]*?)\[\/align\]/g,'<div style="text-align:$1">$2</div>').replaceAll(/\[(ul|ol)\]([^]*?)\[\/\1\]/gi,(t,e,n)=>{let i=n.split(/(^|[\r\n]+)\*/).filter(r=>r.trim()).map(r=>`<li>${r}</li>`).join("");return`<${e}>${i}</${e}>`}).replaceAll(`
`,"<br>")}var{userAgent:x}=navigator,ct={chrome:/chrome/i.test(x),ie:/msie/i.test(x),iphone:/iphone/i.test(x),mobile:/mobile/i.test(x),n3ds:/nintendo 3ds/.test(x),firefox:/firefox/i.test(x),safari:/safari/i.test(x)};var Bt=/^(ht|f)tps?:\/\/[\w.\-%&?=/]+$/,_t=o=>Bt.test(o),Dt={"Sans Serif":["Arial","Arial Black","Arial Narrow","Arial Rounded MT Bold","Avant Garde","Calibri","Candara","Century Gothic","Comic Sans MS","Franklin Gothic Medium","Futura","Geneva","Gill Sans","Helvetica","Impact","Lucida Grande","Optima","Segoe UI","Tahoma","Trebuchet MS","Verdana"],Serif:["Big Caslon","Bodoni MT","Book Antiqua","Calisto MT","Cambria","Didot","Garamond","Georgia","Goudy Old Style","Hoefler Text","Lucida Bright","Palatino","Perpetua","Rockwell","Rockwell Extra Bold","Baskerville","Times New Roman"],Monospaced:["Consolas","Courier New","Lucida Console","Lucida Sans Typewriter","Monaco","Andale Mono"],Fantasy:["Copperplate","Papyrus"],Script:["Brush Script MT"]},F=class extends u{iframe;colorWindow;container;htmlMode=!0;editbar;emoteWindow;static hydrate(t){h("Editor",t.querySelectorAll("textarea.bbcode-editor"),this)}constructor(t){super(t),this.container=Object.assign(document.createElement("div"),{className:"editor"}),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.addEventListener("load",()=>this.iframeLoaded(),{once:!0}),A(this.container,t),this.container.appendChild(t),this.container.appendChild(this.iframe)}get doc(){return this.window?.document}get window(){return this.iframe.contentWindow}iframeLoaded(){let{iframe:t,element:e}=this;if(t.className="editorframe",this.htmlMode=globalSettings.wysiwyg,this.doc?.addEventListener("input",()=>{this.doc&&(this.element.value=at(this.doc.body))}),this.doc?.addEventListener("drop",i=>{i.dataTransfer?.files.length&&this.upload(i.dataTransfer.files[0])}),this.doc?.addEventListener("dragleave",()=>{this.getAttachmentStatus().remove()}),this.doc?.addEventListener("dragover",()=>{this.getAttachmentStatus()}),!this.doc)return;let n=T(e),s=this.doc.getElementsByTagName("body")[0];s&&n&&(s.style.backgroundColor=n.backgroundColor,s.style.color=n.color,s.style.borderColor="#FFF"),this.doc.designMode="on",this.editbar=this.buildEditBar(),t.style.height=`${e.clientHeight}px`,A(this.editbar,e),this.setSource("<div></div>"),setTimeout(()=>{this.setSource(lt(e.value)),this.switchMode(this.htmlMode),e.hasAttribute("autofocus")&&this.window?.focus()},100)}getAttachmentStatus(){let t=this.doc?.querySelector("#attachmentStatus");return t||(t=document.createElement("div"),Object.assign(t,{id:"attachmentStatus",innerHTML:"Drop file here",contentEditable:"false"}),Object.assign(t.style,{position:"fixed",padding:"20px",top:"50%",left:"50%",translate:"-50% -50%",border:"2px dashed #ccc"}),this.doc?.body.appendChild(t),t)}upload(t){let e=new FormData;e.append("Filedata",t);let n=new XMLHttpRequest;this.getAttachmentStatus().innerHTML='Uploading: <progress id="attachmentProgress"></div>';let s=this.getAttachmentStatus().querySelector("#attachmentProgress");n.upload.addEventListener("progress",i=>{if(s&&i.lengthComputable){let r=Math.round(i.loaded/i.total*100);s.value=i.loaded,s.max=i.total,s.textContent=`${r}%`}}),n.addEventListener("load",()=>{this.window?.focus(),this.getAttachmentStatus().remove();let i=n.responseText;if(/\D/.test(i)){alert("Error: "+i);return}this.cmd("inserthtml",`[attachment]${n.responseText}[/attachment]`)}),n.upload.addEventListener("error",()=>{this.getAttachmentStatus().remove()}),n.open("POST","/api/upload",!0),n.send(e)}buildEditBar(){let t=document.createElement("div");t.className="editbar",t.innerHTML=['<select class="fontface"><option value="">Default Font</option></select>','<a class="bold" title="Bold"></a>','<a class="italic" title="Italic"></a>','<a class="underline" title="Underline"></a>','<a class="strikethrough" title="Strike-Through"></a>','<a class="forecolor" title="Foreground Color"></a>','<a class="backcolor" title="Background Color"></a>','<a class="insertimage" title="Insert Image"></a>','<a class="createlink" title="Insert Link"></a>','<a class="c_email" title="Insert Email"></a>','<a class="justifyleft" title="Align Left"></a>','<a class="justifycenter" title="Center"></a>','<a class="justifyright" title="Align Right"></a>','<a class="c_youtube" title="Insert video from any of your favorite video services!"></a>','<a class="c_code" title="Insert code"></a>','<a class="c_quote" title="Insert Quote"></a>','<a class="c_spoiler" title="Insert Spoiler"></a>','<a class="insertorderedlist" title="Create Ordered List"></a>','<a class="insertunorderedlist" title="Create Unordered List"></a>','<a class="c_smileys" title="Insert Emoticon"></a>','<a class="c_switcheditmode" title="Switch editor mode"></a>'].join(""),t.addEventListener("click",n=>{n.target instanceof HTMLElement&&n.target.matches(".editbar a")&&this.editbarCommand(n,n.target.className)});let e=t.querySelector("select.fontface");if(e){e.addEventListener("input",n=>{this.editbarCommand(n,"fontname",e.value)});for(let n of Object.keys(Dt)){let s=Dt[n].map(i=>`<option style="font-family: ${i}">${i}</option>`);e.innerHTML+=`<optgroup label="${n}">${s}</optgroup>`}}return t}editbarCommand(t,e,n){switch(t.preventDefault(),e){case"forecolor":case"backcolor":this.showColors(t.pageX,t.pageY,e);break;case"c_smileys":this.showEmotes(t.pageX,t.pageY);break;case"c_switcheditmode":this.switchMode(!this.htmlMode);break;default:this.cmd(e,n);break}}async showEmotes(t,e){let n=this.emoteWindow;if(!n){let s=await fetch("/api/emotes"),i=await s.json();s.ok&&this.createEmoteWindow(i,{x:t,y:e});return}n.style.display==="none"?(n.style.display="",n.style.left=`${t}px`,n.style.top=`${e}px`):this.hideEmotes()}hideEmotes(){this.emoteWindow&&(this.emoteWindow.style.display="none")}createEmoteWindow([t,e],n){let s=document.createElement("div");s.className="emotewin",t.forEach((i,r)=>{let a=e[r],l=document.createElement("a");l.href="javascript:void(0)",l.addEventListener("click",()=>{this.cmd("inserthtml",a),this.hideEmotes()}),l.innerHTML=`${a} ${i}`,s.appendChild(l)}),s.style.position="absolute",s.style.display="none",this.emoteWindow=s,document.querySelector("#page")?.appendChild(s),this.showEmotes(n.x,n.y)}colorHandler(t,e){this.cmd(t,e),this.hideColors()}showColors(t,e,n){this.hideColors();let s=["#FFFFFF","#AAAAAA","#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"],i=s.length,r=Math.ceil(Math.sqrt(i)),a=document.createElement("table");Object.assign(a.style,{borderCollapse:"collapse",position:"absolute",top:`${e}px`,left:`${t}px`});for(let l=0;l<r;l+=1){let d=a.insertRow(l);for(let c=0;c<r;c+=1){let f=d.insertCell(c),p=s[c+l*r];if(!p)continue;f.style.border="1px solid #000",f.style.padding="0px";let m=document.createElement("a");m.href="javascript:void(0)",m.addEventListener("click",()=>this.colorHandler(n,p)),f.appendChild(m),Object.assign(m.style,{display:"block",backgroundColor:p,height:"20px",width:"20px",margin:0})}}return this.colorWindow=a,document.querySelector("#page")?.appendChild(a),null}hideColors(){this.colorWindow&&(this.colorWindow.remove(),this.colorWindow=void 0)}cmd(t,e){let n=this.getSelection(),s="",i=t,r=e;switch(t.toLowerCase()){case"bold":s=`[b]${n}[/b]`;break;case"italic":s=`[i]${n}[/i]`;break;case"underline":s=`[u]${n}[/u]`;break;case"strikethrough":s=`[s]${n}[/s]`;break;case"justifyright":s=`[align=right]${n}[/align]`;break;case"justifycenter":s=`[align=center]${n}[/align]`;break;case"justifyleft":s=`[align=left]${n}[/align]`;break;case"insertimage":if(r=prompt("Image URL:")||"",!r)return;if(!_t(r)){alert("Please enter a valid URL.");return}s=`[img]${r}[/img]`;break;case"insertorderedlist":this.htmlMode||(s=`[ol]${n.replaceAll(/(.+([\r\n]+|$))/i,"*$1")}[/ol]`);break;case"insertunorderedlist":this.htmlMode||(s=`[ul]${n.replaceAll(/(.+([\r\n]+|$))/i,"*$1")}[/ul]`);break;case"createlink":if(r=prompt("Link:")||"",!r)return;/^(https?|ftp|mailto):/.test(r)||(r=`https://${r}`),s=`[url=${r}]${n}[/url]`;break;case"c_email":if(r=prompt("Email:")||"",!r)return;i="createlink",r=`mailto:${r}`,s=`[url=${r}]${n}[/url]`;break;case"backcolor":(ct.firefox||ct.safari)&&(i="hilitecolor"),s=`[bgcolor=${r}]${n}[/bgcolor]`;break;case"forecolor":s=`[color=${r}]${n}[/color]`;break;case"fontname":s=`[font=${r}]${n}[/font]`;break;case"c_code":i="inserthtml",r=`[code]${n}[/code]`,s=r;break;case"c_quote":i="inserthtml",r=prompt("Who said this?")||"",r=r?`=${r}`:"",r=`[quote${r}]${n}[/quote]`,s=r;break;case"c_spoiler":i="inserthtml",r=`[spoiler]${n}[/spoiler]`,s=r;break;case"c_youtube":if(i="inserthtml",r=prompt("Video URL?")||"",!r)return;r=`[video]${r}[/video]`,s=r;break;case"inserthtml":s=r||"";break;default:throw new Error(`Unsupported editor command ${t}`)}this.htmlMode?(this.doc?.execCommand(i,!1,r),this.window?.focus()):St(this.element,s)}getSelection(){return this.htmlMode?this.window?.getSelection()?.toString()||"":this.element.value.substring(this.element.selectionStart,this.element.selectionEnd)}getSource(){return this.doc?.body.innerHTML}setSource(t){this.doc&&(this.doc.body.innerHTML=t)}switchMode(t){let{element:e,iframe:n}=this;t?(this.setSource(lt(e.value)),e.style.display="none",n.style.display=""):(e.style.display="",n.style.display="none"),this.htmlMode=t}};var P=class extends u{resetOnSubmit;static hydrate(t){h("Form",t.querySelectorAll("form[data-ajax-form]"),this)}constructor(t){super(t),this.resetOnSubmit=t.dataset.ajaxForm==="resetOnSubmit",t.addEventListener("submit",e=>{e.preventDefault(),this.submitForm()})}submitForm(){let{element:t,resetOnSubmit:e}=this,{submitButton:n}=t,s=new FormData(t,n),i=Array.from(s.entries()).filter(r=>typeof r[1]=="string");RUN.stream.load(t.action||globalThis.location.toString(),{body:new URLSearchParams(i)}),e&&t.reset(),RUN.stream.pollData()}};var W=class extends u{index;images;max;static hydrate(t){h("ImageGallery",t.querySelectorAll(".image_gallery"),this)}constructor(t){super(t);let e=document.createElement("div"),n=document.createElement("button"),s=document.createElement("button");this.index=0,this.images=t.querySelectorAll("img"),this.max=Math.max(this.images.length,1),n.innerHTML="Next &raquo;",n.addEventListener("click",()=>{this.showNext()}),s.innerHTML="Prev &laquo;",s.addEventListener("click",()=>{this.showPrev()}),this.update(),e.appendChild(s),e.appendChild(document.createTextNode(" ")),e.appendChild(n),t.appendChild(e)}showNext(){this.index<this.max-1&&(this.index+=1),this.update()}showPrev(){this.index>0&&(this.index-=1),this.update()}update(){this.images.forEach((t,e)=>{let n=t.dataset.madeResized?t.parentNode:t;n&&(n.style.display=e===this.index?"block":"none")})}};var It="999999px",j=class extends u{static async hydrate(t){let e=t.querySelectorAll(".bbcodeimg");await $(Array.from(e)),h("ImageResizer",e,this)}constructor(t){super(t);let e=1,n=1,{naturalWidth:s,naturalHeight:i}=t,r=T(t),a=Number.parseInt(r.width,10)||Number.parseInt(r.maxWidth,10),l=Number.parseInt(r.height,10)||Number.parseInt(r.maxHeight,10);a&&s>a&&(e=a/i),l&&i>l&&(n=l/i),e=e&&n?Math.min(e,n):n||e,e<1&&this.makeResizer(s*e,i*e)}makeResizer(t,e){let{element:n}=this;n.style.maxWidth=It,n.style.maxHeight=It,n.dataset.madeResized="true";let s=Object.assign(document.createElement("a"),{target:"_blank",href:n.src});Object.assign(s.style,{display:"block",overflow:"hidden",width:`${t}px`,height:`${e}px`}),s.dataset.nw=`${n.naturalWidth}`,s.dataset.nh=`${n.naturalHeight}`,s.addEventListener("mousemove",r=>{let{x:a,y:l,w:d,h:c}=b(s);s.scrollLeft=(r.pageX-a)/d*(+(s.dataset.nw||0)-d)||0,s.scrollTop=(r.pageY-l)/c*(+(s.dataset.nh||0)-c)||0}),s.addEventListener("mouseover",()=>{n.style.width=`${s.dataset.nw}px`,n.style.height=`${s.dataset.nh}px`});let i=()=>{s.scrollLeft&&(s.scrollLeft=0,s.scrollTop=0),n.style.width=`${t}px`,n.style.height=`${e}px`};s.addEventListener("mouseout",i),i(),A(s,n),s.appendChild(n)}};function z(o){let t=document.querySelector("#tooltip_thingy"),e=b(o),n=o.getAttribute("title");if(o.dataset.lastOnline){let s=Number.parseInt(o.dataset.lastOnline??"",10);n=`Last Online: ${J(s)} ${nt(s)}`}if(n){if(o.title="",!t){t=document.createElement("table");let s=t.insertRow(0),i=t.insertRow(1),r=t.insertRow(2),a;t.id="tooltip_thingy",t.className="tooltip",s.className="top",i.className="content",r.className="bottom",a=s.insertCell(0),a.className="left",a.colSpan=2,a=s.insertCell(1),a.className="right",a=i.insertCell(0),a.className="left",a=i.insertCell(1),a.innerHTML="default text",a=i.insertCell(2),a.className="right",a=r.insertCell(0),a.className="left",a.colSpan=2,a=r.insertCell(1),a.className="right",document.querySelector("#page")?.appendChild(t)}t.rows[1].cells[1].innerText=n,t.style.display="",t.style.top=`${e.y-t.clientHeight}px`,t.style.left=`${e.x}px`,t.style.zIndex=`${y()}`,o.addEventListener("mouseout",()=>{o.title=n,t.style.display="none"})}}var O=class extends u{static hydrate(t){h("Link",t.querySelectorAll("a"),this)}constructor(t){if(super(t),t.dataset.useTooltip&&t.addEventListener("mouseover",()=>z(t)),!t.href)return;let e=t.getAttribute("href"),n=!t.target&&e&&(e.startsWith("/")||e.startsWith("?"));if(!e?.startsWith("javascript")){if(n){let i=t.onclick;t.onclick=null,t.addEventListener("click",r=>{r.preventDefault(),(!i||i.call(t,r)!==!1)&&RUN.stream.location(e)});return}t.target="_blank"}}};var dt=class{sess;boundEvents;droppables;noChild=!1;bounds;onstart;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[],this.sess={el:document.body,mx:0,my:0},this.boundEvents={drag:t=>this.drag(t),drop:()=>this.drop()}}start(t,e,n){t.preventDefault(),t.stopPropagation();let s=e||t.target,i=T(s),r=y();this.noChild&&t.target!==(n||s)||s.getAttribute("draggable")!=="false"&&(this.sess={el:s,mx:t.pageX,my:t.pageY,ex:Number.parseInt(i.left,10)||0,ey:Number.parseInt(i.top,10)||0,info:{el:s,mx:0,my:0},zIndex:s.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<r-1)&&(s.style.zIndex=`${r}`),this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(t))}drag(t){t.stopPropagation();let e=this.sess.el.style,n=t.pageX,s=t.pageY,i=n,r=s,a,l=(this.sess.ex??0)+i-this.sess.mx,d=(this.sess.ey??0)+r-this.sess.my,c=this.bounds;c&&(l<c[0]?(i=i-l+c[0],[l]=c):l>c[0]+c[2]&&(l=c[0]+c[2]),d<c[1]?(r=r-d+c[1],[d]=c):d>c[1]+c[3]&&(d=c[1]+c[3])),e.left=`${l}px`,e.top=`${d}px`;let f=this.sess.info,p=f?.droptarget,m={left:l,top:d,el:this.sess.el,mx:i,my:r,dx:i-(f?.mx||i),dy:r-(f?.my||r),droptarget:this.testDrops(n,s)};this.sess.info=m,this.ondrag?.(m),m.droptarget&&p!==m.droptarget&&this.ondragover?.(m),p&&m.droptarget!==p&&(a=m.droptarget,m.droptarget=p,this.ondragout?.(m),m.droptarget=a)}boundingBox(t,e,n,s){return this.bounds=[t,e,n,s],this}drop(){return this.boundEvents&&(document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag)),this.ondrop?.(this.sess.info??{}),this.autoZIndex&&(this.sess.el.style.zIndex=this.sess.zIndex??""),!0}testDrops(t,e){let{droppables:n}=this,s,i=[9999,9999];if(n.length)return n.findLast(r=>{if(!(r===this.sess.el||xt(r,this.sess.el))&&(s=b(r),i[0]>s.w&&i[1]>s.h&&t>=s.x&&e>=s.y&&t<=s.xw&&e<=s.yh))return i=[s.w,s.h],r})}drops(t){return this.droppables=t,this}addDrops(t){return this.droppables?(this.droppables=this.droppables.concat(t),this):this.drops(t)}addListener(t){return Object.assign(this,t),this}apply(t,e){if(Array.isArray(t))return t.forEach(i=>this.apply(i)),this;let s=T(t)?.position;return(!s||s==="static")&&(t.style.position="relative"),(e||t).onmousedown=e?i=>this.start(i,t,e):i=>this.start(i,t),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset(t=this.sess.el){return t.style.top="0",t.style.left="0",this}},mt=dt;function Ut(o){let t=document.createElement("div");return t.innerHTML=o,t.firstElementChild}var ut=class{title="Title";wait=!0;content="Content";open=!1;minimizable=!0;resize;className="";pos="center";zIndex;windowContainer;id;onclose;animate=!0;oldpos;constructor(t={}){this.zIndex=y(),Object.assign(this,t)}render(){let t=Ut(`
      <div id="${this.id||""}" class="window ${this.className}">
        <div class="title">
          ${this.title}
          <div class="controls">
            ${this.minimizable?'<button data-action="minimize">-</button>':""}
            <button data-action="close" data-shortcut="Escape">X</button>
          </div>
        </div>
        <div class="content">${this.content}</div>
      </div>`);this.windowContainer=t,t.addEventListener("click",s=>{if(s.target instanceof HTMLElement){let i=s.target.dataset.action;i&&i in this&&this[i]()}}),document.body.appendChild(t),this.resize&&this.renderResizeHandle(this.resize);let e=t.style;e.zIndex=`${this.zIndex+5}`;let{pos:n}=this;return this.wait?$(Array.from(t.querySelectorAll("img"))).then(()=>{this.setPosition(n)}):this.setPosition(n),new mt().autoZ().noChildActivation().boundingBox(0,0,document.documentElement.clientWidth-50,document.documentElement.clientHeight-50).apply(t,t.querySelector(".title")||void 0),t}renderResizeHandle(t){let{windowContainer:e}=this;if(!e)return;let n=e.querySelector(t);if(!n)throw new Error("Resize target not found");n.style.width=`${n.clientWidth}px`,n.style.height=`${n.clientHeight}px`;let s=document.createElement("div");s.className="resize",e.appendChild(s),s.style.left=`${e.clientWidth-16}px`,s.style.top=`${e.clientHeight-16}px`,new mt().boundingBox(100,100,1/0,1/0).addListener({ondrag(i){let r=Number.parseFloat(n.style.width)+(i.dx??0),a=Number.parseFloat(n.style.height)+(i.dy??0);n.style.width=`${r}px`,r<e.clientWidth-20?n.style.width=`${e.clientWidth}px`:s.style.left=`${e.clientWidth-16}px`,n.style.height=`${a}px`},ondrop(){s.style.left=`${e.clientWidth-16}px`}}).apply(s),n.style.width=`${e.clientWidth}px`,s.style.left=`${e.clientWidth-16}px`}close(){this.windowContainer&&(this.windowContainer.remove(),this.windowContainer=void 0,this.onclose&&this.onclose())}minimize(){let t=this.windowContainer;if(!t)return;let e=t.classList.contains("minimized");if(t.classList.toggle("minimized"),e)t.removeAttribute("draggable"),this.setPosition(this.oldpos??"");else{t.setAttribute("draggable","false");let s=Array.from(document.querySelectorAll(".window")).reduce((i,r)=>r.classList.contains("minimized")?i+Number(r.clientWidth):i,0);this.oldpos=this.getPosition(),this.setPosition(`bl ${s} 0`,!1)}}setPosition(t,e=!0){let n=this.windowContainer;if(!n)return;let s=0,i=0,r=document.documentElement.clientHeight,a=document.documentElement.clientWidth,l=/(\d+) (\d+)/.exec(t);switch(l&&(s=Number(l[1]),i=Number(l[2])),s=Math.floor(s),i=Math.floor(i),t.charAt(1)==="r"&&(s=a-s-n.clientWidth),t.charAt(0)){case"b":i=r-i-n.clientHeight;break;case"c":i=(r-n.clientHeight)/2,s=(a-n.clientWidth)/2;break;default:}s=Math.floor(s),i=Math.floor(i),s<0&&(s=0),i<0&&(i=0),n.style.left=`${s}px`,this.animate&&e?L(n,[{top:`${i-100}px`},{top:`${i}px`}],300,"ease-out"):n.style.top=`${i}px`,this.pos=t}getPosition(){if(!this.windowContainer)return"";let t=this.windowContainer.style;return`tl ${Number.parseFloat(t.left)} ${Number.parseFloat(t.top)}`}},v=ut;var B=class extends u{static hydrate(t){h("MediaPlayer",t.querySelectorAll(".media"),this)}constructor(t){super(t);let e=t.querySelector("a.popout"),n=t.querySelector("a.inline"),s=t.querySelector(".movie");s&&(e?.addEventListener("click",i=>{i.preventDefault(),new v({title:e.href,content:s.innerHTML}).render()}),n?.addEventListener("click",i=>{i.preventDefault(),s.style.display="block"}))}};var _=class extends u{static hydrate(t){h("PageList",t.querySelectorAll(".pages"),this)}constructor(t){super(t),t.addEventListener("wheel",e=>this.wheel(e))}wheel(t){t.preventDefault();let e=Math.sign(t.deltaY),n=Array.from(this.element.querySelectorAll("a")),s=Number.parseInt(n[1].innerHTML,10),i=Number.parseInt(n.at(-1)?.innerHTML||"",10),r=n.length-2;if(e>0&&s+r<i||e<0&&s>2)for(let a=0;a<r;a+=1)n[a+1].href=n[a+1].href.replace(/\d+$/,`${a+s+e}`),n[a+1].innerHTML=`${s+a+e}`}};var U=class extends u{static hydrate(t){h("Switch",t.querySelectorAll("input.switch"),this)}constructor(t){super(t),t.style.display="none";let e=Object.assign(document.createElement("button"),{type:"button",title:t.className,className:t.className}),n=()=>{e.style.backgroundPosition=t.checked?"top":"bottom"};n(),e.addEventListener("click",()=>{t.checked=!t.checked,n(),t.dispatchEvent(new Event("change"))}),Mt(e,t)}};var ht="active",Y=class extends u{static hydrate(t){h("Tabs",t.querySelectorAll(".tabs"),this)}constructor(t){super(t),t.addEventListener("click",e=>this.click(e))}click(t){let{tabSelector:e}=this.element.dataset,{target:n}=t;if(!n||!(n instanceof HTMLElement)||n.tagName.toLowerCase()!=="a")return;let s=n;if(e){let r=n.closest(e);r&&(s=r)}let i=this.element.querySelector(`.${ht}`);i&&i.classList.remove(ht),s.className=ht,s.blur()}};function g(o){N(),[k,D,I,R,F,P,C,W,j,O,B,_,U,Y].forEach(t=>{t.hydrate(o)})}var pt="50px",ft=class{success(t){this.showToast(t,"success",3e3)}error(t){this.showToast(t,"error")}async showToast(t,e,n=0){let s=document.createElement("div"),i=async()=>{await L(s,[{top:pt},{top:`-${pt}`}]),s.remove()};s.classList.add(e),Object.assign(s.style,{position:"fixed",left:"50%",transform:"translateX(-50%)",boxShadow:"black 5px 5px 10px",zIndex:y()}),s.addEventListener("click",i,{once:!0}),s.innerHTML=t;let r=document.createElement("a");r.href="javascript:void(0)",r.innerHTML=" [X]",r.title="close notification",r.addEventListener("click",i,{once:!0}),s.append(r),document.body.appendChild(s),await L(s,[{top:"0"},{top:pt}],600,"ease-in-out"),n&&(await new Promise(a=>setTimeout(a,n)),i())}},M=new ft;var gt=class{soundCache={};load(t,e,n){let s=this.soundCache[t];if(s){n&&this.play(t);return}s=new Audio,this.soundCache[t]=s,s.autoplay=!!n,s.src=e}play(t){this.soundCache[t].play()}loadAndPlay(t,e){this.load(t,e,!0)}},E=new gt;var H={loadscript(o){document.body.appendChild(Object.assign(document.createElement("script"),{src:o}))},script(o){(0,eval)(o)},error(o){M.error(o)},success(o){M.success(o)},reload(o=0){setTimeout(()=>globalThis.location.reload(),o)},refreshdata(){RUN.stream.pollData(!0)},addclass(o,t){let e=document.querySelector(o);e&&e.classList.add(t)},title(o){document.title=o},update(o,t,e){let n=o,s=Array.from(document.querySelectorAll(".path"));if(n==="path"&&s.length>1){s.forEach(a=>{a.innerHTML=t,g(a)});return}/^\W/.test(n)||(n=`#${n}`);let i=document.querySelector(n);if(!i)return;i.innerHTML=t;let r=i.querySelector("[autofocus]");r&&r.focus(),e&&st(i),g(i)},removeel(o){let t=document.querySelector(o);t&&t.remove()},back(){globalThis.history.back()},setstatus(o){let t=document.querySelector("#status");t&&(t.className=o)},appendrows(o,t){let e=document.querySelector(o);if(!e)return;let n=document.createElement("span");n.innerHTML=`<table>${t}</table>`;let s=n.getElementsByTagName("tbody")[0];g(s),e.appendChild(s)},location(o){if(["?","/"].includes(o.charAt(0))){RUN.stream.location(o);return}document.location=o},enable(o){let t=document.querySelector(`#${o}`);t&&(t.disabled=!1)},addshout(o){let t=Array.from(document.querySelectorAll("#shoutbox .shout")),e=document.createElement("span");e.innerHTML=o;let n=e.firstElementChild;if(n){for(t[0].parentNode?.insertBefore(n,t[0]);t.length>globalSettings.shoutLimit-1;)t.pop()?.remove();st(n),globalSettings.soundShout&&E.play("sbblip"),g(n)}},tick(o){let t=document.querySelector("#ticker");if(!t)return;let e=document.createElement("div");e.innerHTML=o,e=e.firstElementChild,t.insertBefore(e,t.firstChild);let n=Array.from(t.querySelectorAll(".tick"));for(let s=100;s<n.length;s+=100)n[s].remove()},im(o,t,e,n,s){Nt({fromId:o,fromName:t,message:e,fromMe:n,timestamp:s})},imtoggleoffline(o){document.querySelector(`#im_${o}`)?.classList.add("offline")},window(o){if(o.id&&document.getElementById(o.id))return;let e=new v(o);g(e.render())},closewindow(o){let t=document.querySelector(o+" [data-action=close]");t&&t.click()},onlinelist(o){let t=document.querySelector("#statusers");t&&o.forEach(e=>{let n=document.querySelector(`#statusers .user${e.uid}`);if(n||(n=document.createElement("a")),n.innerHTML=e.name,n.className=[`user${e.uid}`,`mgroup${e.groupID}`,e.status,`lastAction${e.lastAction}`].join(" "),e.profileURL&&(n.href=e.profileURL,n.addEventListener("click",function(){RUN.stream.location(this.href)})),e.locationVerbose&&(n.title=e.locationVerbose,n.addEventListener("mouseover",()=>z(n))),e.status==="idle"){ot(n);return}t.firstChild?t.insertBefore(n,t.firstChild):t.appendChild(n)})},setoffline(o){let t=document.querySelector("#statusers");o.split(",").forEach(n=>{let s=document.querySelector(`#statusers .user${n}`);s&&t&&s.remove()})},async scrollToPost(o){let t=document.getElementById(`pid_${o}`);if(!t)return!1;await $(Array.from(document.querySelectorAll("#page img")));let e=b(t);return globalThis.scrollTo({top:e.y}),!0},updateqreply(o){let e=document.querySelector("#qreply")?.querySelector("textarea");e&&(e.focus(),e.value+=o)},newmessage(o,t){let e=document.querySelector("#notification"),n=document.querySelector("#num-messages");n&&(n.innerHTML=`${Number.parseInt(n.innerHTML,10)+1}`),e||(e=document.createElement("div"),e.id="notification",document.body.appendChild(e)),e.style.display="",e.className="newmessage",e.addEventListener("click",()=>{e.style.display="none",RUN.stream.location(`/ucp/inbox?view=${t}`,3)}),e.innerHTML=o},playsound(o,t){E.loadAndPlay(o,t)},listrating(o,t){let e=document.querySelector(`#postrating_${o}`),n;if(e){if(e.style.display!=="none"){L(e,[{height:"200px"},{height:"0px"}],300).then(s=>s.style.display="none");return}e.style.display="block"}else{e=document.createElement("div"),e.className="postrating_list",e.id=`postrating_${o}`;let s=document.querySelector(`#pid_${o} .postrating`);if(!s)return;n=b(s),e.style.top=`${n.yh}px`,e.style.left=`${n.x}px`,document.querySelector("#page")?.appendChild(e)}e.innerHTML=t,L(e,[{height:"0px"},{height:"200px"}],300)}};var Rt,w="",qt="";function bt(){w&&(document.title=w),w="",clearInterval(Rt)}function Ft(o){document.hasFocus()||(bt(),w||(w=document.title),qt=o,Rt=setInterval(()=>{document.title=document.title===w?qt:w},1e3))}function Yt(o,t){if(Ft(`New message from ${o}!`),!document.hasFocus()&&globalThis.Notification&&Notification.permission==="granted"){let e=new Notification(`${o} says:`,{body:t});e.onclick=()=>{globalThis.focus(),e.close()}}}function Xt({fromId:o,fromName:t,message:e}){let n=document.querySelector(`#im_${o} .ims`);if(n)return n;let i=new v({title:`${t}`,content:`
            <div class='ims'></div>
            <div class='offline'>This user may be offline</div>
            <div>
                <form data-ajax-form='resetOnSubmit' method='post'>
                    <input type='hidden' name='im_uid' value='%s'>
                    <input type='text' name='im_im' autocomplete='off'>
                </form>
            </div>
        `.replaceAll("%s",`${o}`),className:"im",resize:".ims",animate:!0,id:`im_${o}`}).render();g(i);let r=()=>{i.querySelector('form input[name="im_im"]')?.focus()};i.addEventListener("click",r),r(),n=i.querySelector(".ims");let a=getComputedStyle(n);return n.style.width=a.width,n.style.height=a.height,e&&globalSettings.soundIM&&E.play("imnewwindow"),n}function yt(o,t){if(!globalSettings.canIM){alert("You do not have permission to use this feature.");return}H.im(o,t,"",1,Date.now())}function Nt({fromId:o,fromName:t,message:e,fromMe:n,timestamp:s}){Yt(t,e);let i=Xt({fromId:o,fromName:t,message:e});if(!e)return;let r=document.createElement("div"),a=e.startsWith("/me");a&&(r.className="action",e=e.substring(3),t=`***${t}`),r.classList.add(n?"you":"them"),n||document.querySelector(`#im_${o}`)?.classList.remove("offline"),r.innerHTML=`<a href='/profile/${n||o}' class='name'>${t}</a> ${a?"":": "}${e}`,r.dataset.timestamp=`${s}`;let l=i.scrollTop>i.scrollHeight-i.clientHeight-50;i.appendChild(r),l&&(i.scrollTop=i.scrollHeight),g(r),globalSettings.soundIM&&E.play("imbeep")}function Gt(o){let t=o?o.split(","):[],e=t.length===1?"":"s",n=t.length?" and <br>":"";return[t,e,n]}function Vt(o){let t=o?o.split(","):[],n=(t?t.length:0)===1?"":"s";return[t,n]}var X=class{whichone=0;boundCheckLocation;pids=[];tids=[];modb;constructor(){this.boundCheckLocation=()=>this.checkLocation(),Object.assign(H,{modcontrols_clearbox:this.destroyModControls.bind(this),modcontrols_move:this.showMoveControls.bind(this),modcontrols_postsync:this.postSync.bind(this)})}checkLocation(){let{whichone:t}=this,n=(t?/topic\/(\d+)/:/forum\/(\d+)/).exec(document.location.toString());n?this.moveTo(Number(n[1])):this.showMoveControls(t)}moveTo(t){let{whichone:e}=this;this.renderModControls(`<form method="post" action="/modcontrols" data-ajax-form="true">
                move ${e?"posts":"topics"} here?
            <input type="hidden"
                name="${e?"dop":"dot"}"
                value="moveto">
            <input type="hidden" name="id" value="${t}">
            <input type="submit" value="Yes">
            <input type="submit" name="cancel" value="Cancel" onclick="this.form.submitButton=this">
            </form>`)}renderModControls(t){this.modb=this.modb||document.querySelector("#modbox")||void 0,this.modb||(this.modb=document.createElement("div"),this.modb.id="modbox",document.body.appendChild(this.modb)),this.modb.style.display="block",this.modb.innerHTML=t,g(this.modb)}destroyModControls(){globalThis.removeEventListener("pushstate",this.boundCheckLocation),this.modb&&(this.modb.innerHTML="",this.modb.style.display="none")}togbutton(t){t.classList.toggle("selected")}postSync(t,e){let[n,s,i]=Gt(t),[r,a]=Vt(e);if(this.tids=r,this.pids=n,!r.length&&!n.length){this.destroyModControls();return}let l=r.length?`
            <select name="dot">
                <option value="delete">Delete</option>
                <option value="merge">Merge</option>
                <option value="move">Move</option>
                <option value="pin">Pin</option>
                <option value="unpin">Unpin</option>
                <option value="lock">Lock</option>
                <option value="unlock">Unlock</option>
            </select> &nbsp; &nbsp;
            <strong>${r.length}</strong> topic${a}${i}`:"",d=n.length?`
            <select name="dop">
                <option value="delete">Delete</option>
                <option value="move">Move</option>
            </select> &nbsp; &nbsp;
            <strong>${n.length}</strong> post${s}`:"",c=n.length&&r.length?"<br>":" &nbsp; &nbsp; ",f=`
        <form method="post" action="/modcontrols" data-ajax-form="true">
            ${l}
            ${d}
            ${c}
            <input type="submit" value="Go">
            <input
                name="cancel" type="submit"
                onclick="this.form.submitButton=this;" value="Cancel">
        </form>`;this.renderModControls(f)}showMoveControls(t){this.whichone=t,globalThis.addEventListener("pushstate",this.boundCheckLocation),this.renderModControls(`Ok, now browse to the ${this.whichone?"topic":"forum"} you want to move the ${this.whichone?`${this.pids.length} posts`:`${this.tids.length} topics`} to...`)}};function Zt(o=200){let t=document.querySelector("#snow");if(t===null){t=document.createElement("div"),t.id="snow",Object.assign(t.style,{position:"fixed",top:0,left:0,zIndex:1});let e=document.createElement("style");e.appendChild(document.createTextNode(`
            .snowflake {
                position: absolute;
                width: 10px;
                height: 10px;
                background: linear-gradient(white, white);
                /* Workaround for Chromium's selective color inversion */
                border-radius: 50%;
                filter: drop-shadow(0 0 10px white);
            }`)),document.body.prepend(e),document.body.prepend(t)}t.innerHTML="";for(let e=1;e<o;e+=1){let n=document.createElement("div");n.className="snowflake",t.appendChild(n)}}function Jt(){let o=document.getElementById("snow-css");return o||(o=document.createElement("style"),o.id="snow-css",document.head.appendChild(o),o)}function Kt(o){let t=Jt();t.innerHTML=o,document.head.appendChild(t)}function Qt(o=100){return Math.floor(Math.random()*o)+1}function te(o,t){let e=Math.ceil(o),n=Math.floor(t);return Math.floor(Math.random()*(n-e+1))+e}function ee(o,t){return Math.random()*(t-o)+o}function ne(o=200){let e=100*document.body.offsetHeight/window.innerHeight,n="snowflake",s="";for(let i=1;i<o;i+=1){let r=Math.random()*100,a=Math.random()*10,l=r+a,d=r+a/2,c=ee(.3,.8),f=c*e,p=Math.random(),m=te(10,e/10*3),tt=Qt(e/10*3)*-1,S=Math.random();s+=`
      .${n}:nth-child(${i}) {
        opacity: ${S};
        transform: translate(${r}vw, -10px) scale(${p});
        animation: fall-${i} ${m}s ${tt}s linear infinite;
      }
      @keyframes fall-${i} {
        ${c*100}% {
          transform: translate(${l}vw, ${f}vh) scale(${p});
        }
        to {
          transform: translate(${d}vw, ${e}vh) scale(${p});
        }
      }
    `}Kt(s)}function Et(){ne(200),Zt(200)}function oe(){new v({title:"Keyboard Shortcuts",id:"shortcuts",content:`
      <style>
        #shortcuts { width: 300px; }
        #shortcuts dt { float: left;margin-left: 5px;}
      </style>
      <h3>Navigation</h3>
      <dl>
        <dt>?</dt><dd>This help window</dd>
        <dt>h</dt><dd>Home / Board Index</dd>
        <dt>i</dt><dd>Inbox</dd>
        <dt>s</dt><dd>Settings</dd>
        `+(globalSettings.isAdmin?"<dt>a</dt><dd>Admin CP</dd>":"")+(globalSettings.isMod?"<dt>m</dt><dd>Moderator CP</dd>":"")+`</dl>

      <h3>Inbox</h3>
      <dl>
        <dt>c</dt><dd>Compose</dd>
        <dt>i</dt><dd>Inbox</dd>
        <dt>f</dt><dd>Flagged Messages</dd>
        <dt>r</dt><dd>Reply to Message</dd>
      </dl>

      <h3>Forum/Topic</h3>
      <dl>
        <dt>t</dt><dd>New Topic</dd>
        <dt>r</dt><dd>Reply</dd>
        <dt>p</dt><dd>Full Reply</dd>
      </dl>
      `}).render()}function Pt(o){if(o.target instanceof HTMLInputElement||o.target instanceof HTMLTextAreaElement||o.target instanceof HTMLSelectElement)return;if(o.key==="?"){oe();return}document.documentElement.querySelector(`[data-shortcut="${o.key}"]`)?.click()}var se=5e3,G=class{commands;lastURL;timeout;constructor(){this.lastURL=`${document.location.pathname}${document.location.search}`,this.commands=H}handleRequestData(t,e,n=1){let s=!1;e.forEach(([i,...r])=>{i==="softurl"?s=!0:i in this.commands&&this.commands[i].apply(null,r)}),n>=2&&(s||(globalThis.history.pushState({lastURL:t},"",t),globalThis.dispatchEvent(new Event("pushstate")),this.lastURL=t)),this.pollData()}location(t,e=2){this.load(t,{requestType:e})}async load(t,{body:e,method:n="POST",requestType:s=1}={}){try{let i=await fetch(t,{method:n,body:e,headers:{"X-JSACCESS":`${s}`,"Content-Type":"application/x-www-form-urlencoded"}});if(i.ok){let r=await i.json();this.handleRequestData(t,r,s);return}M.error("An unrecoverable error has occurred.<br>Please try again later.")}catch{navigator.onLine?M.error("Network fetch failed: timeout"):M.error("You appear to be offline.")}}pollData(t=!1){t&&this.load(this.lastURL),clearTimeout(this.timeout),document.cookie.includes(`actw=${window.name}`)&&(this.timeout=setTimeout(()=>this.load(this.lastURL),se))}updatePage(t){t!==this.lastURL&&this.location(t,3)}};var ie=2,Lt=class{stream=new G;onAppReady(){ie&&g(document.body);let t=new Date;t.getMonth()===11&&[23,24,25].includes(t.getDate())&&Et(),N(),setInterval(N,1e3*30),this.stream.pollData(),globalThis.addEventListener("popstate",({state:n})=>{if(n){let{lastURL:s}=n;this.stream.updatePage(s)}else this.stream.updatePage(document.location.toString())}),E.load("sbblip","/Sounds/blip.mp3",!1),E.load("imbeep","/Sounds/receive.mp3",!1),E.load("imnewwindow","/Sounds/receive.mp3",!1)}handleQuoting(t){this.stream.load(`${t.href}&qreply=${document.querySelector("#qreply")?"1":"0"}`)}setWindowActive(){document.cookie=`actw=${window.name}; SameSite:Lax`,bt(),this.stream.pollData()}},Q=new Lt;q(()=>{Q.onAppReady()});q(()=>{window.name=`${Math.random()}`,Q.setWindowActive(),globalThis.addEventListener("focus",()=>{Q.setWindowActive()})});q(function(){At()||document.documentElement.classList.add("no-emoji"),document.documentElement.classList.add("js-enabled")});q(()=>{globalThis.addEventListener("keyup",Pt)});var Wt=Q;Object.assign(globalThis,{RUN:Wt,IMWindow:yt,ModControls:new X});})();
