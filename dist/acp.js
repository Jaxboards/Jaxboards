"use strict";(()=>{function M(r){return globalThis.getComputedStyle(r)}function h(r){let{x:e,y:t,height:n,width:o}=r.getBoundingClientRect(),s=e+globalThis.scrollX,i=t+globalThis.scrollY;return{x:s,y:i,yh:i+n,xw:s+o,w:o,h:n}}function v(r,e){return e.contains(r)}function A(r,e){e.before(r)}function g(r,e){e.after(r)}function T(){return Array.from(document.querySelectorAll("*")).reduce((t,n)=>n.style.zIndex&&Number(n.style.zIndex)>t?Number(n.style.zIndex):t,0)+1}function w(r,e){let t=r.scrollTop,n=r.selectionStart??0,o=r.selectionEnd??0;r.value=r.value.substring(0,n)+e+r.value.slice(o),r.selectionStart=n+e.length,r.selectionEnd=n+e.length,r.focus(),r.scrollTop=t}var H=class{sess;boundEvents;droppables;noChild=!1;bounds;onstart;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[],this.sess={el:document.body,mx:0,my:0},this.boundEvents={drag:e=>this.drag(e),drop:()=>this.drop()}}start(e,t,n){e.preventDefault(),e.stopPropagation();let o=t||e.target,s=M(o),i=T();this.noChild&&e.target!==(n||o)||o.getAttribute("draggable")!=="false"&&(this.sess={el:o,mx:e.pageX,my:e.pageY,ex:Number.parseInt(s.left,10)||0,ey:Number.parseInt(s.top,10)||0,info:{el:o,mx:0,my:0},zIndex:o.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<i-1)&&(o.style.zIndex=`${i}`),this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(e))}drag(e){e.stopPropagation();let t=this.sess.el.style,n=e.pageX,o=e.pageY,s=n,i=o,a,l=(this.sess.ex??0)+s-this.sess.mx,c=(this.sess.ey??0)+i-this.sess.my,d=this.bounds;d&&(l<d[0]?(s=s-l+d[0],[l]=d):l>d[0]+d[2]&&(l=d[0]+d[2]),c<d[1]?(i=i-c+d[1],[c]=d):c>d[1]+d[3]&&(c=d[1]+d[3])),t.left=`${l}px`,t.top=`${c}px`;let p=this.sess.info,m=p?.droptarget,u={left:l,top:c,el:this.sess.el,mx:s,my:i,dx:s-(p?.mx||s),dy:i-(p?.my||i),droptarget:this.testDrops(n,o)};this.sess.info=u,this.ondrag?.(u),u.droptarget&&m!==u.droptarget&&this.ondragover?.(u),m&&u.droptarget!==m&&(a=u.droptarget,u.droptarget=m,this.ondragout?.(u),u.droptarget=a)}boundingBox(e,t,n,o){return this.bounds=[e,t,n,o],this}drop(){return this.boundEvents&&(document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag)),this.ondrop?.(this.sess.info??{}),this.autoZIndex&&(this.sess.el.style.zIndex=this.sess.zIndex??""),!0}testDrops(e,t){let{droppables:n}=this,o,s=[9999,9999];if(n.length)return n.findLast(i=>{if(!(i===this.sess.el||v(i,this.sess.el))&&(o=h(i),s[0]>o.w&&s[1]>o.h&&e>=o.x&&t>=o.y&&e<=o.xw&&t<=o.yh))return s=[o.w,o.h],i})}drops(e){return this.droppables=e,this}addDrops(e){return this.droppables?(this.droppables=this.droppables.concat(e),this):this.drops(e)}addListener(e){return Object.assign(this,e),this}apply(e,t){if(Array.isArray(e))return e.forEach(s=>this.apply(s)),this;let o=M(e)?.position;return(!o||o==="static")&&(e.style.position="relative"),(t||e).onmousedown=t?s=>this.start(s,e,t):s=>this.start(s,e),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset(e=this.sess.el){return e.style.top="0",e.style.left="0",this}},I=H;function C(r,e){let t=Array.from(r.querySelectorAll("li")),n={},o=0;return t.forEach(s=>{if(s.className!=="seperator"&&s.parentNode===r){o=1;let[i]=s.getElementsByTagName("ul");n[`_${s.id.slice(e.length)}`]=i?C(i,e):1}}),o?n:1}function $(r,e){if(!r.droptarget)return;let t=r.el.classList.contains("parentlock"),n=r.el.classList.contains("nofirstlevel");if(t&&r.droptarget.parentNode!==r.el.parentNode){e.reset(r.el);return}if(n&&r.droptarget.parentNode?.className==="tree"){e.reset(r.el);return}if(v(r.droptarget,r.el)||r.el===r.droptarget.nextSibling){e.reset(r.el);return}let o=r.droptarget.nextSibling;o.className==="spacer"&&o.remove(),o.className==="spacer"?r.el.previousSibling?.remove():g(r.el.previousSibling,r.droptarget),g(r.el,r.droptarget)}function S(r,e,t){let n=Array.from(r.querySelectorAll("li")),o=[],s=[];o.push(...n.filter(a=>a.className!=="title")),o.forEach(a=>{let l=document.createElement("li");l.className="seperator",s.push(l),A(l,a)});let i=new I().noChildActivation();i.drops([...o,...s]).addListener({ondragover(a){a.droptarget&&(a.droptarget.style.border="1px solid #000")},ondragout(a){a.droptarget&&(a.droptarget.style.border="none")},ondrop(a){let l,c=a.el.classList.contains("parentlock");i.reset(a.el),a.droptarget&&(a.droptarget.style.border="none",a.droptarget.className==="seperator"?$(a,i):!c&&a.droptarget.tagName==="LI"&&([l]=a.droptarget.getElementsByTagName("ul"),l||(l=document.createElement("ul"),a.droptarget.appendChild(l)),l.appendChild(a.el.previousSibling),l.appendChild(a.el),a.droptarget.appendChild(l)),t&&(t.value=JSON.stringify(C(r,e))))}}),o.forEach(a=>i.apply(a))}function D(r){document.readyState==="complete"?r():document.addEventListener("DOMContentLoaded",r)}var x=new Map,f=class{element;constructor(e){this.element=e}};function E(r,e,t){x.has(r)||x.set(r,new WeakMap),e.forEach(function(o){x.get(r)?.has(o)||x.get(r)?.set(o,new t(o))})}var k="valid",N="invalid",y=class extends f{method;outputElement;indicatorElement;static hydrate(e){E("AutoComplete",e.querySelectorAll("input[data-autocomplete-action]"),this)}constructor(e){super(e),e.autocomplete="off",this.method=e.dataset.autocompleteAction;let t=e.dataset.autocompleteOutput,n=e.dataset.autocompleteIndicator,o=t?document.querySelector(t):void 0;if(!o)throw new Error("Expected element to have data-autocomplete-output");this.outputElement=o||document.createElement("input"),this.indicatorElement=n?document.querySelector(n):void 0,e.addEventListener("keyup",s=>this.keyUp(s)),e.addEventListener("keydown",s=>{s.key==="Enter"&&s.preventDefault()})}getResultsContainer(){let e=h(this.element),t=document.querySelector("#autocomplete");return t||(t=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(t.style,{zIndex:T()}),document.body.appendChild(t)),Object.assign(t.style,{top:`${e.yh}px`,left:`${e.x}px`,width:`${e.w}px`}),t}keyUp(e){let t=this.getResultsContainer(),n=Array.from(t.querySelectorAll("div")),o=n.findIndex(s=>s.classList.contains("selected"));switch(e.key){case"ArrowUp":case"ArrowDown":n.at(o)?.classList.remove("selected"),n.at((o+(e.key==="ArrowDown"?1:-1))%n.length)?.classList.add("selected");return;case"Enter":o>=0&&n.at(o)?.dispatchEvent(new Event("click"));return;default:this.indicatorElement&&(this.indicatorElement.classList.remove(k),this.indicatorElement.classList.add(N)),this.clearResults(),this.element.value&&this.doSearch();break}}clearResults(){let e=this.getResultsContainer();e.style.display="none",e.innerHTML=""}async doSearch(){let e=this.getResultsContainer(),t=/ACP/.test(document.location.toString())?"../":"",o=`term=${encodeURIComponent(this.element.value)}`,s=await fetch(`${t}/api/${this.method}?${o}`);if(!s.ok)return;let i=await s.json();if(e.innerHTML="",i.length){e.style.display="";let[a,l]=i;a.forEach((c,d)=>{let p=l[d],m=document.createElement("div");m.innerHTML=p,m.addEventListener("click",()=>{e.style.display="none",this.indicatorElement&&(this.indicatorElement.classList.add(k),this.indicatorElement.classList.remove(N)),this.outputElement.value=`${c}`,this.outputElement.dispatchEvent(new Event("change")),this.element.value=p}),e.appendChild(m)});return}e.style.display="none"}};var b=class r extends HTMLElement{static formAssociated=!0;shadow;internals;results;search;leaveHandler;optionKeyboardHandler;hiddenFormField;value;static hydrate(){customElements.define("better-select",r),customElements.define("better-option",class extends HTMLElement{})}constructor(){super(),this.value=this.getAttribute("value")??"",this.shadow=this.attachShadow({mode:"open"}),this.internals=this.attachInternals(),this.search=document.createElement("input"),this.results=document.createElement("div"),this.hiddenFormField=Object.assign(document.createElement("input"),{type:"hidden",name:this.getAttribute("name")}),this.leaveHandler=e=>{this.results.classList.toggle("open",e.relatedTarget instanceof HTMLElement&&this.results.contains(e.relatedTarget))},this.optionKeyboardHandler=function(t){switch(t.key){case"ArrowUp":this.previousElementSibling?.focus();break;case"ArrowDown":this.nextElementSibling.focus();break;default:break}}}connectedCallback(){let{shadow:e,results:t,search:n}=this;t.className="results",n.autocomplete="off",n.addEventListener("focus",()=>t.classList.toggle("open",!0)),n.addEventListener("input",()=>{this.renderOptions(n.value)}),n.addEventListener("keydown",s=>{switch(s.key){case"ArrowUp":this.shadow.querySelector(".results button:last-child")?.focus();break;case"ArrowDown":this.shadow.querySelector(".results button:first-child")?.focus();break;default:break}}),n.addEventListener("blur",this.leaveHandler),e.appendChild(n),e.appendChild(this.hiddenFormField),e.appendChild(t),this.renderOptions(),e.adoptedStyleSheets=[this.stylesheet()],n.setAttribute("role","combobox"),n.setAttribute("aria-activedescendant",""),t.setAttribute("role","listbox");let o=`id-${Math.random()}`;t.setAttribute("id",o),n.setAttribute("aria-controls",o)}close(){this.results.classList.remove("open")}clear(){[...Array.from(this.querySelectorAll("better-option[selected]")),...Array.from(this.results.querySelectorAll(".selected"))].forEach(e=>{e.removeAttribute("selected"),e.classList.remove("selected")})}renderOptions(e=""){this.results.innerHTML="",this.getOptions(e).forEach(t=>this.results.appendChild(t))}getOptions(e=""){return Array.from(this.querySelectorAll("better-option")).filter(t=>t.innerText.toLowerCase().includes(e.toLowerCase())).map(t=>{let n=document.createElement("button");n.addEventListener("click",()=>{this.hasAttribute("multiple")||(this.clear(),this.close()),n.classList.toggle("selected"),t.toggleAttribute("selected",n.classList.contains("selected")),this.updateValue()}),n.addEventListener("keydown",this.optionKeyboardHandler),n.classList.toggle("selected",t.hasAttribute("selected"));let o=t.getAttribute("image");if(o){let i=new Image;i.src=o,n.appendChild(i)}let s=document.createTextNode(` ${t.innerText}`);return n.appendChild(s),n.addEventListener("blur",this.leaveHandler),n}).filter(Boolean)}updateValue(){let e=Array.from(this.querySelectorAll("better-option[selected]"));this.value=e.map(t=>t.getAttribute("value")).join(","),this.search.value=e.at(-1)?.innerText??"",this.internals.setFormValue(this.value),this.dispatchEvent(new Event("change"))}stylesheet(){let e=new CSSStyleSheet;return e.replaceSync(`
            button { display: block; width: 100%; text-align: left; }
            button.selected { background: #1f1f83; color: #FFF; }
            button:hover { background: #9cdcfe; }
            button img { vertical-align: middle; }
            .results { position: absolute; display: none; max-height: 400px; overflow: auto; }
            .results.open { display: block; }
        `),e}};var L=class extends f{static hydrate(e){E("Switch",e.querySelectorAll("input.switch"),this)}constructor(e){super(e),e.style.display="none";let t=Object.assign(document.createElement("button"),{type:"button",title:e.className,className:e.className}),n=()=>{t.style.backgroundPosition=e.checked?"top":"bottom"};n(),t.addEventListener("click",()=>{e.checked=!e.checked,n(),e.dispatchEvent(new Event("change"))}),g(t,e)}};function q(r){let e=r.target;if(e instanceof HTMLElement&&e?.tagName.toLowerCase()==="a"){let t=document.querySelector(`#menu_${e.classList[0]}`);if(!t)return;e.classList.add("active");let n=t.style;n.display="block";let o=h(e);n.top=`${o.y+e.clientHeight}px`,n.left=`${o.x}px`,e.addEventListener("mouseout",s=>{s.relatedTarget instanceof HTMLElement&&s.relatedTarget!==t&&s.relatedTarget.offsetParent!==t&&(e.classList.remove("active"),t.style.display="none")}),t?.addEventListener("mouseout",s=>{s.relatedTarget instanceof HTMLElement&&s.relatedTarget!==e&&s.relatedTarget.offsetParent!==t&&s.relatedTarget!==t&&(e.classList.remove("active"),t.style.display="none")})}}async function O(r){let e=new FormData(r,r.submitButton),t=Array.from(e.entries()).filter(n=>typeof n[1]=="string");await fetch(document.location.search,{method:"POST",body:new URLSearchParams(t),headers:{"X-JSACCESS":"1","Content-Type":"application/x-www-form-urlencoded"}}),alert("Saved. Ajax-submitted so you don't lose your place")}function F(){document.querySelector("#nav")?.addEventListener("mouseover",q),Array.from(document.querySelectorAll("form")).forEach(n=>{n.dataset.useAjaxSubmit&&n.addEventListener("submit",o=>{o.preventDefault(),O(n)})}),y.hydrate(document.body),L.hydrate(document.body),b.hydrate();let r=document.querySelector(".editor");r&&r.addEventListener("keydown",n=>{n.key==="Tab"&&(w(r,"    "),n.preventDefault())});let e=document.querySelector(".tree"),t=document.querySelector("#ordered");e&&t&&S(e,"forum_",t)}D(F);})();
