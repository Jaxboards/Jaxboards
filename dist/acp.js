"use strict";(()=>{function M(s){return globalThis.getComputedStyle(s)}function h(s){let{x:e,y:n,height:t,width:r}=s.getBoundingClientRect(),o=e+globalThis.scrollX,a=n+globalThis.scrollY;return{x:o,y:a,yh:a+t,xw:o+r,w:r,h:t}}function v(s,e){return e.contains(s)}function A(s,e){s.remove(),e.parentNode?.insertBefore(s,e)}function g(s,e){s.remove(),e.parentNode?.insertBefore(s,e.nextSibling)}function T(){return Array.from(document.querySelectorAll("*")).reduce((n,t)=>t.style.zIndex&&Number(t.style.zIndex)>n?Number(t.style.zIndex):n,0)+1}function w(s,e){let n=s.scrollTop,t=s.selectionStart??0,r=s.selectionEnd??0;s.value=s.value.substring(0,t)+e+s.value.slice(r),s.selectionStart=t+e.length,s.selectionEnd=t+e.length,s.focus(),s.scrollTop=n}var H=class{sess;boundEvents;droppables;noChild=!1;bounds;onstart;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[],this.sess={el:document.body,mx:0,my:0},this.boundEvents={drag:e=>this.drag(e),drop:()=>this.drop()}}start(e,n,t){e.preventDefault(),e.stopPropagation();let r=n||e.target,o=M(r),a=T();this.noChild&&e.target!==(t||r)||r.getAttribute("draggable")!=="false"&&(this.sess={el:r,mx:e.pageX,my:e.pageY,ex:Number.parseInt(o.left,10)||0,ey:Number.parseInt(o.top,10)||0,info:{el:r,mx:0,my:0},zIndex:r.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<a-1)&&(r.style.zIndex=`${a}`),this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(e))}drag(e){e.stopPropagation();let n=this.sess.el.style,t=e.pageX,r=e.pageY,o=t,a=r,i,l=(this.sess.ex??0)+o-this.sess.mx,c=(this.sess.ey??0)+a-this.sess.my,d=this.bounds;d&&(l<d[0]?(o=o-l+d[0],[l]=d):l>d[0]+d[2]&&(l=d[0]+d[2]),c<d[1]?(a=a-c+d[1],[c]=d):c>d[1]+d[3]&&(c=d[1]+d[3])),n.left=`${l}px`,n.top=`${c}px`;let u=this.sess.info,p=u?.droptarget,m={left:l,top:c,el:this.sess.el,mx:o,my:a,dx:o-(u?.mx||o),dy:a-(u?.my||a),droptarget:this.testDrops(t,r)};this.sess.info=m,this.ondrag?.(m),m.droptarget&&p!==m.droptarget&&this.ondragover?.(m),p&&m.droptarget!==p&&(i=m.droptarget,m.droptarget=p,this.ondragout?.(m),m.droptarget=i)}boundingBox(e,n,t,r){return this.bounds=[e,n,t,r],this}drop(){return this.boundEvents&&(document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag)),this.ondrop?.(this.sess.info),this.autoZIndex&&(this.sess.el.style.zIndex=this.sess.zIndex??""),!0}testDrops(e,n){let{droppables:t}=this,r,o=[9999,9999];if(t.length)return t.findLast(a=>{if(!(a===this.sess.el||v(a,this.sess.el))&&(r=h(a),o[0]>r.w&&o[1]>r.h&&e>=r.x&&n>=r.y&&e<=r.xw&&n<=r.yh))return o=[r.w,r.h],a})}drops(e){return this.droppables=e,this}addDrops(e){return this.droppables?(this.droppables=this.droppables.concat(e),this):this.drops(e)}addListener(e){return Object.assign(this,e),this}apply(e,n){if(Array.isArray(e))return e.forEach(o=>this.apply(o)),this;let r=M(e)?.position;return(!r||r==="static")&&(e.style.position="relative"),(n||e).onmousedown=n?o=>this.start(o,e,n):o=>this.start(o,e),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset(e=this.sess.el){return e.style.top="0",e.style.left="0",this}},I=H;function C(s,e){let n=Array.from(s.querySelectorAll("li")),t={},r=0;return n.forEach(o=>{if(o.className!=="seperator"&&o.parentNode===s){r=1;let[a]=o.getElementsByTagName("ul");t[`_${o.id.slice(e.length)}`]=a!==void 0?C(a,e):1}}),r?t:1}function S(s,e,n){let t=Array.from(s.querySelectorAll("li")),r=[],o=[];r.push(...t.filter(i=>i.className!=="title")),r.forEach(i=>{let l=document.createElement("li");l.className="seperator",o.push(l),A(l,i)});let a=new I().noChildActivation();a.drops([...r,...o]).addListener({ondragover(i){i.droptarget&&(i.droptarget.style.border="1px solid #000")},ondragout(i){i.droptarget&&(i.droptarget.style.border="none")},ondrop(i){let l,c=i.el.classList.contains("parentlock"),d=i.el.classList.contains("nofirstlevel");if(a.reset(i.el),!!i.droptarget){if(i.droptarget.style.border="none",i.droptarget.className==="seperator"){if(c&&i.droptarget.parentNode!==i.el.parentNode){a.reset(i.el);return}if(d&&i.droptarget.parentNode?.className==="tree"){a.reset(i.el);return}if(v(i.droptarget,i.el)||i.el===i.droptarget.nextSibling){a.reset(i.el);return}let u=i.droptarget.nextSibling;u.className==="spacer"&&u.parentNode?.removeChild(u),u.className!=="spacer"?g(i.el.previousSibling,i.droptarget):i.el.previousSibling?.parentNode?.removeChild(i.el.previousSibling),g(i.el,i.droptarget)}else!c&&i.droptarget.tagName==="LI"&&([l]=i.droptarget.getElementsByTagName("ul"),l||(l=document.createElement("ul"),i.droptarget.appendChild(l)),l.appendChild(i.el.previousSibling),l.appendChild(i.el),i.droptarget.appendChild(l));n&&(n.value=JSON.stringify(C(s,e)))}}}),r.forEach(i=>a.apply(i))}function k(s){document.readyState==="complete"?s():document.addEventListener("DOMContentLoaded",s)}var x=new Map,f=class{element;constructor(e){this.element=e}};function E(s,e,n){x.has(s)||x.set(s,new WeakMap),e.forEach(function(r){x.get(s)?.has(r)||x.get(s)?.set(r,new n(r))})}var D="valid",N="invalid",y=class extends f{method;outputElement;indicatorElement;static hydrate(e){E("AutoComplete",e.querySelectorAll("input[data-autocomplete-action]"),this)}constructor(e){super(e),e.autocomplete="off",this.method=e.dataset.autocompleteAction;let n=e.dataset.autocompleteOutput,t=e.dataset.autocompleteIndicator,r=n?document.querySelector(n):void 0;if(!r)throw new Error("Expected element to have data-autocomplete-output");this.outputElement=r||document.createElement("input"),this.indicatorElement=t?document.querySelector(t):void 0,e.addEventListener("keyup",o=>this.keyUp(o)),e.addEventListener("keydown",o=>{o.key==="Enter"&&o.preventDefault()})}getResultsContainer(){let e=h(this.element),n=document.querySelector("#autocomplete");return n||(n=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(n.style,{zIndex:T()}),document.body.appendChild(n)),Object.assign(n.style,{top:`${e.yh}px`,left:`${e.x}px`,width:`${e.w}px`}),n}keyUp(e){let n=this.getResultsContainer(),t=Array.from(n.querySelectorAll("div")),r=t.findIndex(o=>o.classList.contains("selected"));if(t)switch(e.key){case"ArrowUp":r>=0&&(t[r].classList.remove("selected"),t[r-1].classList.add("selected"));return;case"ArrowDown":r===-1?t[0].classList.add("selected"):r<t.length-1&&(t[r].classList.remove("selected"),t[r+1].classList.add("selected"));return;case"Enter":r>=0&&t[r].dispatchEvent(new Event("click"));return;default:this.indicatorElement&&(this.indicatorElement.classList.remove(D),this.indicatorElement.classList.add(N));break}this.doSearch()}async doSearch(){let e=this.getResultsContainer(),n=/ACP/.test(document.location.toString())?"../":"",r=`term=${encodeURIComponent(this.element.value)}`,o=await fetch(`${n}/api/${this.method}?${r}`);if(!o.ok)return;let a=await o.json();if(e.innerHTML="",a.length){e.style.display="";let[i,l]=a;i.forEach((c,d)=>{let u=l[d],p=document.createElement("div");p.innerHTML=u,p.addEventListener("click",()=>{e.style.display="none",this.indicatorElement&&this.indicatorElement.classList.add(D),this.outputElement.value=`${c}`,this.outputElement.dispatchEvent(new Event("change")),this.element.value=u}),e.appendChild(p)});return}e.style.display="none"}};var b=class s extends HTMLElement{static formAssociated=!0;shadow;internals;results;search;leaveHandler;optionKeyboardHandler;hiddenFormField;value;static hydrate(){customElements.define("better-select",s),customElements.define("better-option",class extends HTMLElement{})}constructor(){super(),this.value=this.getAttribute("value")??"",this.shadow=this.attachShadow({mode:"open"}),this.internals=this.attachInternals(),this.search=document.createElement("input"),this.results=document.createElement("div"),this.hiddenFormField=Object.assign(document.createElement("input"),{type:"hidden",name:this.getAttribute("name")}),this.leaveHandler=e=>{this.results.classList.toggle("open",e.relatedTarget instanceof HTMLElement&&this.results.contains(e.relatedTarget))},this.optionKeyboardHandler=function(n){switch(n.key){case"ArrowUp":this.previousElementSibling?.focus();break;case"ArrowDown":this.nextElementSibling.focus();break;default:break}}}connectedCallback(){let{shadow:e,results:n,search:t}=this;n.className="results",t.autocomplete="off",t.addEventListener("focus",()=>n.classList.toggle("open",!0)),t.addEventListener("input",()=>{this.renderOptions(t.value)}),t.addEventListener("keydown",o=>{switch(o.key){case"ArrowUp":this.shadow.querySelector(".results button:last-child")?.focus();break;case"ArrowDown":this.shadow.querySelector(".results button:first-child")?.focus();break;default:break}}),t.addEventListener("blur",this.leaveHandler),e.appendChild(t),e.appendChild(this.hiddenFormField),e.appendChild(n),this.renderOptions(),e.adoptedStyleSheets=[this.stylesheet()],t.setAttribute("role","combobox"),t.setAttribute("aria-activedescendant",""),n.setAttribute("role","listbox");let r=`id-${Math.random()}`;n.setAttribute("id",r),t.setAttribute("aria-controls",r)}close(){this.results.classList.remove("open")}clear(){[...Array.from(this.querySelectorAll("better-option[selected]")),...Array.from(this.results.querySelectorAll(".selected"))].forEach(e=>{e.removeAttribute("selected"),e.classList.remove("selected")})}renderOptions(e=""){this.results.innerHTML="",this.getOptions(e).forEach(n=>this.results.appendChild(n))}getOptions(e=""){return Array.from(this.querySelectorAll("better-option")).filter(n=>n.innerText.toLowerCase().includes(e.toLowerCase())).map(n=>{let t=document.createElement("button");t.addEventListener("click",()=>{this.hasAttribute("multiple")||(this.clear(),this.close()),t.classList.toggle("selected"),n.toggleAttribute("selected",t.classList.contains("selected")),this.updateValue()}),t.addEventListener("keydown",this.optionKeyboardHandler),t.classList.toggle("selected",n.hasAttribute("selected"));let r=n.getAttribute("image");if(r){let a=new Image;a.src=r,t.appendChild(a)}let o=document.createTextNode(` ${n.innerText}`);return t.appendChild(o),t.addEventListener("blur",this.leaveHandler),t}).filter(Boolean)}updateValue(){let e=Array.from(this.querySelectorAll("better-option[selected]"));this.value=e.map(n=>n.getAttribute("value")).join(","),this.search.value=e.at(-1)?.innerText??"",this.internals.setFormValue(this.value),this.dispatchEvent(new Event("change"))}stylesheet(){let e=new CSSStyleSheet;return e.replaceSync(`
            button { display: block; width: 100%; text-align: left; }
            button.selected { background: #1f1f83; color: #FFF; }
            button:hover { background: #9cdcfe; }
            button img { vertical-align: middle; }
            .results { position: absolute; display: none; max-height: 400px; overflow: auto; }
            .results.open { display: block; }
        `),e}};var L=class extends f{static hydrate(e){E("Switch",e.querySelectorAll("input.switch"),this)}constructor(e){super(e),e.style.display="none";let n=Object.assign(document.createElement("button"),{type:"button",title:e.className,className:e.className}),t=()=>{n.style.backgroundPosition=e.checked?"top":"bottom"};t(),n.addEventListener("click",()=>{e.checked=!e.checked,t(),e.dispatchEvent(new Event("change"))}),g(n,e)}};function $(s){let e=s.target;if(e instanceof HTMLElement&&e?.tagName.toLowerCase()==="a"){let n=document.querySelector(`#menu_${e.classList[0]}`);e.classList.add("active");let t=n.style;t.display="block";let r=h(e);t.top=`${r.y+e.clientHeight}px`,t.left=`${r.x}px`,e.addEventListener("mouseout",o=>{o.relatedTarget instanceof HTMLElement&&o.relatedTarget!==n&&o.relatedTarget.offsetParent!==n&&(e.classList.remove("active"),n.style.display="none")}),n?.addEventListener("mouseout",o=>{o.relatedTarget instanceof HTMLElement&&o.relatedTarget!==e&&o.relatedTarget.offsetParent!==n&&o.relatedTarget!==n&&(e.classList.remove("active"),n.style.display="none")})}}async function q(s){let e=new URLSearchParams,n=Array.from(s.elements),t=s.submitButton;n.forEach(r=>{r instanceof HTMLInputElement&&(["checkbox","radio"].includes(r.type)&&!r.checked||r.type==="submit")||(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement)&&e.append(r.name,r.value)}),t&&e.append(t.name,t.value),await fetch(document.location.search,{method:"POST",body:e,headers:{"X-JSACCESS":"1","Content-Type":"application/x-www-form-urlencoded"}}),alert("Saved. Ajax-submitted so you don't lose your place")}function O(){document.querySelector("#nav")?.addEventListener("mouseover",$),Array.from(document.querySelectorAll("form")).forEach(t=>{t.dataset.useAjaxSubmit&&t.addEventListener("submit",r=>{r.preventDefault(),q(t)})}),y.hydrate(document.body),L.hydrate(document.body),b.hydrate();let s=document.querySelector(".editor");s&&s.addEventListener("keydown",t=>{t.key==="Tab"&&(w(s,"    "),t.preventDefault())});let e=document.querySelector(".tree"),n=document.querySelector("#ordered");e&&n&&S(e,"forum_",n)}k(O);})();
