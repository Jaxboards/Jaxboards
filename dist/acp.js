"use strict";(()=>{function w(n){document.readyState==="complete"?n():document.addEventListener("DOMContentLoaded",n)}function L(n){return n&&window.getComputedStyle?window.getComputedStyle(n):null}function m(n){let{x:e,y:o,height:t,width:s}=n.getBoundingClientRect(),i=e+window.scrollX,a=o+window.scrollY;return{x:i,y:a,yh:a+t,xw:i+s,w:s,h:t}}function x(n,e){return e.contains(n)}function M(n,e){n.parentNode&&n.parentNode.removeChild(n),e.parentNode?.insertBefore(n,e)}function y(n,e){n.parentNode&&n.parentNode.removeChild(n),e.parentNode?.insertBefore(n,e.nextSibling)}function E(){return Array.from(document.querySelectorAll("*")).reduce((o,t)=>t.style.zIndex&&Number(t.style.zIndex)>o?Number(t.style.zIndex):o,0)+1}function N(n,e){return n?e?n.map((o,t)=>`${encodeURIComponent(o)}=${encodeURIComponent(e[t]||"")}`).join("&"):Object.keys(n).map(o=>`${encodeURIComponent(o)}=${encodeURIComponent(n[o]||"")}`).join("&"):""}var S=class{constructor(e){this.setup={readyState:4,callback(){},method:"POST",...e}}load(e,{callback:o,data:t,method:s=this.setup.method,requestType:i=1}={}){let a=null;t&&Array.isArray(t)&&Array.isArray(t[0])&&t[0].length===t[1].length?a=N(t[0],t[1]):typeof t!="string"&&(a=N(t));let r=new XMLHttpRequest;return o&&(this.setup.callback=o),r.onreadystatechange=()=>{r.readyState===this.setup.readyState&&this.setup.callback(r)},r.open(s,e,!0),r.url=e,r.type=i,s&&r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("X-JSACCESS",i),r.send(a),r}},b=S;function I(n,e){let o=n.scrollTop;if(document.selection)n.focus(),document.selection.createRange().text=e;else{let t=n.selectionStart,s=n.selectionEnd;n.value=n.value.substring(0,t)+e+n.value.substr(s),n.selectionStart=t+e.length,n.selectionEnd=t+e.length}n.focus(),n.scrollTop=o}var T=class{onstart;sess;boundEvents;droppables;noChild=!1;bounds;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[]}start(e,o,t){e.stopPropagation();let s=o||e.target,i=L(s),a=E();this.noChild&&e.target!==(t||s)||s.getAttribute("draggable")!=="false"&&(this.sess={el:s,mx:e.pageX,my:e.pageY,ex:parseInt(i?.left??"",10)||0,ey:parseInt(i?.top??"",10)||0,info:{},bc:m(s),zIndex:s.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<a-1)&&(s.style.zIndex=`${a}`),this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),this.boundEvents={drag:r=>this.drag(r),drop:()=>this.drop()},document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(e))}drag(e){e.stopPropagation();let o=this.sess.el.style,t,s,i=e.pageX,a=e.pageY,r=i,d=a,c,u=this.sess.ex+r-this.sess.mx,p=this.sess.ey+d-this.sess.my,l=this.bounds;l&&(u<l[0]?(r=r-u+l[0],[u]=l):u>l[0]+l[2]&&(u=l[0]+l[2]),p<l[1]?(d=d-p+l[1],[p]=l):p>l[1]+l[3]&&(p=l[1]+l[3])),o.left=`${u}px`,o.top=`${p}px`,s=(t=this.sess.info).droptarget,t={left:u,top:p,el:this.sess.el,mx:r,my:d,droptarget:this.testDrops(i,a),dx:r-(t.mx||r),dy:d-(t.my||d),sx:this.sess.ex,sy:this.sess.ey},this.sess.info=t,this.ondrag?.(t),t.droptarget&&s!==t.droptarget&&this.ondragover?.(t),s&&t.droptarget!==s&&(c=t.droptarget,t.droptarget=s,this.ondragout?.(t),t.droptarget=c)}boundingBox(e,o,t,s){return this.bounds=[e,o,t,s],this}drop(){return this.boundEvents&&(document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag)),this.ondrop?.(this.sess.info),this.autoZIndex&&(this.sess.el.style.zIndex=this.sess.zIndex),!0}testDrops(e,o){let{droppables:t}=this,s,i=[9999,9999];if(t.length)return t.findLast(a=>{if(!(a===this.sess.el||x(a,this.sess.el))&&(s=m(a),i[0]>s.w&&i[1]>s.h&&e>=s.x&&o>=s.y&&e<=s.xw&&o<=s.yh))return i=[s.w,s.h],a})}drops(e){return this.droppables=e,this}addDrops(e){return this.droppables?(this.droppables=this.droppables.concat(e),this):this.drops(e)}addListener(e){return Object.assign(this,e),this}apply(e,o){if(Array.isArray(e))return e.forEach(i=>this.apply(i)),this;let s=L(e)?.position;return(!s||s==="static")&&(e.style.position="relative"),(o||e).onmousedown=o?i=>this.start(i,e,o):i=>this.start(i,e),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset(e=this.sess.el){return e.style.top=0,e.style.left=0,this}},$=T;function H(n,e){let o=Array.from(n.querySelectorAll("li")),t={},s=0;return o.forEach(i=>{if(i.className!=="seperator"&&i.parentNode===n){s=1;let[a]=i.getElementsByTagName("ul");t[`_${i.id.substr(e.length)}`]=a!==void 0?H(a,e):1}}),s?t:1}function C(n,e,o){let t=Array.from(n.querySelectorAll("li")),s=[],i=[];s.push(...t.filter(r=>r.className!=="title")),s.forEach(r=>{let d=document.createElement("li");d.className="seperator",i.push(d),M(d,r)});let a=new $().noChildActivation();a.drops(i.concat(s)).addListener({ondragover(r){r.droptarget.style.border="1px solid #000"},ondragout(r){r.droptarget.style.border="none"},ondrop(r){let d=r.droptarget.nextSibling,c,u=r.el.className==="parentlock",p=r.el.className==="nofirstlevel";if(r.droptarget&&(r.droptarget.style.border="none"),r.droptarget.className==="seperator"){if(u&&r.droptarget.parentNode!==r.el.parentNode||p&&r.droptarget.parentNode.className==="tree"||x(r.droptarget,r.el)||r.el===d)return a.reset(r.el);d.className==="spacer"&&d.parentNode.removeChild(d),d.className!=="spacer"?y(r.el.previousSibling,r.droptarget):r.el.previousSibling.parentNode.removeChild(r.el.previousSibling),y(r.el,r.droptarget)}else!u&&r.droptarget.tagName==="LI"&&([c]=r.droptarget.getElementsByTagName("ul"),c||(c=document.createElement("ul"),r.droptarget.appendChild(c)),c.appendChild(r.el.previousSibling),c.appendChild(r.el),r.droptarget.appendChild(c));return a.reset(r.el),o&&(o.value=JSON.stringify(H(n,e))),null}}),s.forEach(r=>a.apply(r))}var f=class{static get selector(){throw new Error("No Selector defined")}constructor(e){this.element=e,e.hydrated=!0}};var D="valid",q="invalid",h=class extends f{static get selector(){return"input[data-autocomplete-action]"}constructor(e){super(e),e.autocomplete="off",this.action=e.dataset.autocompleteAction;let o=e.dataset.autocompleteOutput,t=e.dataset.autocompleteIndicator;if(this.outputElement=o&&document.querySelector(o),this.indicatorElement=t&&document.querySelector(t),!this.outputElement)throw new Error("Expected element to have data-autocomplete-output");e.addEventListener("keyup",s=>this.keyUp(s)),e.addEventListener("keydown",s=>{s.key==="Enter"&&s.preventDefault()})}getResultsContainer(){let e=m(this.element),o=document.querySelector("#autocomplete");return o||(o=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(o.style,{zIndex:E()}),document.body.appendChild(o)),Object.assign(o.style,{top:`${e.yh}px`,left:`${e.x}px`,width:`${e.w}px`}),o}keyUp(e){let o=this.getResultsContainer(),t=Array.from(o.querySelectorAll("div")),s=t.findIndex(d=>d.classList.contains("selected"));if(t)switch(e.key){case"ArrowUp":s>=0&&(t[s].classList.remove("selected"),t[s-1].classList.add("selected"));return;case"ArrowDown":s===-1?t[0].classList.add("selected"):s<t.length-1&&(t[s].classList.remove("selected"),t[s+1].classList.add("selected"));return;case"Enter":s>=0&&t[s].onclick();return;default:this.indicatorElement&&(this.indicatorElement.classList.remove(D),this.indicatorElement.classList.add(q));break}let i=document.location.toString().match("/ACP/")?"../":"",a=encodeURIComponent(this.element.value),r=`act=${this.action}&term=${a}`;new b().load(`${i}api/?${r}`,{callback:d=>{let c=JSON.parse(d.responseText);if(o.innerHTML="",!c.length)o.style.display="none";else{o.style.display="";let[u,p]=c;u.forEach((l,k)=>{let A=p[k],v=document.createElement("div");v.innerHTML=A,v.onclick=()=>{o.style.display="none",this.indicatorElement&&this.indicatorElement.classList.add(D),this.outputElement.value=l,this.outputElement.dispatchEvent(new Event("change")),this.element.value=A},o.appendChild(v)})}}})}};var g=class extends f{static get selector(){return"input.switch"}constructor(e){super(e),e.style.display="none";let o=Object.assign(document.createElement("button"),{type:"button",title:e.className,className:e.className}),t=()=>{o.style.backgroundPosition=e.checked?"top":"bottom"};t(),o.addEventListener("click",()=>{e.checked=!e.checked,t(),e.dispatchEvent(new Event("change"))}),y(o,e)}};function j(n){let e=n.target;if(e?.tagName.toLowerCase()==="a"){let o=document.querySelector(`#menu_${e.classList[0]}`);e.classList.add("active");let t=o.style;t.display="block";let s=m(e);t.top=`${s.y+e.clientHeight}px`,t.left=`${s.x}px`,e.onmouseout=i=>{!i.relatedTarget&&i.toElement&&(i.relatedTarget=i.toElement),i.relatedTarget!==o&&i.relatedTarget.offsetParent!==o&&(e.classList.remove("active"),o.style.display="none")},o.onmouseout=i=>{!i.relatedTarget&&i.toElement&&(i.relatedTarget=i.toElement),i.relatedTarget!==e&&i.relatedTarget.offsetParent!==o&&i.relatedTarget!==o&&(e.classList.remove("active"),o.style.display="none")}}}function O(n){let e=[],o=[],t=Array.from(n.elements),s=n.submitButton;t.forEach(i=>{!i.name||i.type==="submit"||(i.type==="checkbox"||i.type==="radio")&&!i.checked||(e.push(i.name),o.push(i.value))}),s&&(e.push(s.name),o.push(s.value)),new b().load(document.location.search,{data:[e,o]}),alert("Saved. Ajax-submitted so you don't lose your place")}function R(){document.querySelector("#nav").addEventListener("mouseover",j),Array.from(document.querySelectorAll("form[data-use-ajax-submit]")).forEach(t=>{t.addEventListener("submit",s=>{s.preventDefault(),O(t)})}),document.querySelectorAll(g.selector).forEach(t=>new g(t));let n=document.querySelector(".editor");n&&n.addEventListener("keydown",t=>{t.keyCode===9&&(I(n,"    "),t.preventDefault())}),document.querySelectorAll(h.selector).forEach(t=>new h(t));let o=document.querySelector(".tree");o&&C(o,"forum_",document.querySelector("#ordered"))}w(R);})();
