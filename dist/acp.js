"use strict";(()=>{function w(i,e){if(!i)return"";if(Array.isArray(i)){if(!e)throw new Error("Invalid arguments for buildQueryString. Received array and undefined");return i.map((t,n)=>`${encodeURIComponent(t)}=${encodeURIComponent(e[n]||"")}`).join("&")}return Object.keys(i).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(i[t]||"")}`).join("&")}var T=class{setup={readyState:4,method:"POST"};constructor(e={}){Object.assign(this.setup,e)}load(e,{callback:t,data:n,method:r="POST",requestType:o=1}={}){let a=null;n&&Array.isArray(n)?a=w(n[0],n[1]):n&&typeof n!="string"&&(a=w(n));let s=new XMLHttpRequest;return t&&(this.setup.callback=t),s.onreadystatechange=()=>{s.readyState===this.setup.readyState&&this.setup.callback?.(s)},s.open(r,e,!0),Object.assign(s,{url:e,requestType:o}),r&&s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("X-JSACCESS",`${o}`),s.send(a),s}},E=T;function S(i){return globalThis.getComputedStyle(i)}function h(i){let{x:e,y:t,height:n,width:r}=i.getBoundingClientRect(),o=e+globalThis.scrollX,a=t+globalThis.scrollY;return{x:o,y:a,yh:a+n,xw:o+r,w:r,h:n}}function v(i,e){return e.contains(i)}function I(i,e){i.remove(),e.parentNode?.insertBefore(i,e)}function f(i,e){i.remove(),e.parentNode?.insertBefore(i,e.nextSibling)}function L(){return Array.from(document.querySelectorAll("*")).reduce((t,n)=>n.style.zIndex&&Number(n.style.zIndex)>t?Number(n.style.zIndex):t,0)+1}function C(i,e){let t=i.scrollTop,n=i.selectionStart??0,r=i.selectionEnd??0;i.value=i.value.substring(0,n)+e+i.value.slice(r),i.selectionStart=n+e.length,i.selectionEnd=n+e.length,i.focus(),i.scrollTop=t}var M=class{sess;boundEvents;droppables;noChild=!1;bounds;onstart;ondragover;ondrag;ondragout;ondrop;autoZIndex=!0;constructor(){this.droppables=[],this.sess={el:document.body,mx:0,my:0},this.boundEvents={drag:e=>this.drag(e),drop:()=>this.drop()}}start(e,t,n){e.preventDefault(),e.stopPropagation();let r=t||e.target,o=S(r),a=L();this.noChild&&e.target!==(n||r)||r.getAttribute("draggable")!=="false"&&(this.sess={el:r,mx:e.pageX,my:e.pageY,ex:Number.parseInt(o.left,10)||0,ey:Number.parseInt(o.top,10)||0,info:{el:r,mx:0,my:0},zIndex:r.style.zIndex},(!this.sess.zIndex||Number(this.sess.zIndex)<a-1)&&(r.style.zIndex=`${a}`),this.onstart?.({...this.sess,droptarget:this.testDrops(this.sess.mx,this.sess.my)}),document.addEventListener("mousemove",this.boundEvents.drag),document.addEventListener("mouseup",this.boundEvents.drop),this.drag(e))}drag(e){e.stopPropagation();let t=this.sess.el.style,n=e.pageX,r=e.pageY,o=n,a=r,s,l=(this.sess.ex??0)+o-this.sess.mx,c=(this.sess.ey??0)+a-this.sess.my,d=this.bounds;d&&(l<d[0]?(o=o-l+d[0],[l]=d):l>d[0]+d[2]&&(l=d[0]+d[2]),c<d[1]?(a=a-c+d[1],[c]=d):c>d[1]+d[3]&&(c=d[1]+d[3])),t.left=`${l}px`,t.top=`${c}px`;let m=this.sess.info,p=m?.droptarget,u={left:l,top:c,el:this.sess.el,mx:o,my:a,dx:o-(m?.mx||o),dy:a-(m?.my||a),droptarget:this.testDrops(n,r)};this.sess.info=u,this.ondrag?.(u),u.droptarget&&p!==u.droptarget&&this.ondragover?.(u),p&&u.droptarget!==p&&(s=u.droptarget,u.droptarget=p,this.ondragout?.(u),u.droptarget=s)}boundingBox(e,t,n,r){return this.bounds=[e,t,n,r],this}drop(){return this.boundEvents&&(document.removeEventListener("mouseup",this.boundEvents.drop),document.removeEventListener("mousemove",this.boundEvents.drag)),this.ondrop?.(this.sess.info),this.autoZIndex&&(this.sess.el.style.zIndex=this.sess.zIndex??""),!0}testDrops(e,t){let{droppables:n}=this,r,o=[9999,9999];if(n.length)return n.findLast(a=>{if(!(a===this.sess.el||v(a,this.sess.el))&&(r=h(a),o[0]>r.w&&o[1]>r.h&&e>=r.x&&t>=r.y&&e<=r.xw&&t<=r.yh))return o=[r.w,r.h],a})}drops(e){return this.droppables=e,this}addDrops(e){return this.droppables?(this.droppables=this.droppables.concat(e),this):this.drops(e)}addListener(e){return Object.assign(this,e),this}apply(e,t){if(Array.isArray(e))return e.forEach(o=>this.apply(o)),this;let r=S(e)?.position;return(!r||r==="static")&&(e.style.position="relative"),(t||e).onmousedown=t?o=>this.start(o,e,t):o=>this.start(o,e),this}autoZ(){return this.autoZIndex=!1,this}noChildActivation(){return this.noChild=!0,this}reset(e=this.sess.el){return e.style.top="0",e.style.left="0",this}},D=M;function N(i,e){let t=Array.from(i.querySelectorAll("li")),n={},r=0;return t.forEach(o=>{if(o.className!=="seperator"&&o.parentNode===i){r=1;let[a]=o.getElementsByTagName("ul");n[`_${o.id.slice(e.length)}`]=a!==void 0?N(a,e):1}}),r?n:1}function A(i,e,t){let n=Array.from(i.querySelectorAll("li")),r=[],o=[];r.push(...n.filter(s=>s.className!=="title")),r.forEach(s=>{let l=document.createElement("li");l.className="seperator",o.push(l),I(l,s)});let a=new D().noChildActivation();a.drops([...r,...o]).addListener({ondragover(s){s.droptarget&&(s.droptarget.style.border="1px solid #000")},ondragout(s){s.droptarget&&(s.droptarget.style.border="none")},ondrop(s){let l,c=s.el.classList.contains("parentlock"),d=s.el.classList.contains("nofirstlevel");if(a.reset(s.el),!!s.droptarget){if(s.droptarget.style.border="none",s.droptarget.className==="seperator"){if(c&&s.droptarget.parentNode!==s.el.parentNode){a.reset(s.el);return}if(d&&s.droptarget.parentNode?.className==="tree"){a.reset(s.el);return}if(v(s.droptarget,s.el)||s.el===s.droptarget.nextSibling){a.reset(s.el);return}let m=s.droptarget.nextSibling;m.className==="spacer"&&m.parentNode?.removeChild(m),m.className!=="spacer"?f(s.el.previousSibling,s.droptarget):s.el.previousSibling?.parentNode?.removeChild(s.el.previousSibling),f(s.el,s.droptarget)}else!c&&s.droptarget.tagName==="LI"&&([l]=s.droptarget.getElementsByTagName("ul"),l||(l=document.createElement("ul"),s.droptarget.appendChild(l)),l.appendChild(s.el.previousSibling),l.appendChild(s.el),s.droptarget.appendChild(l));t&&(t.value=JSON.stringify(N(i,e)))}}}),r.forEach(s=>a.apply(s))}function k(i){document.readyState==="complete"?i():document.addEventListener("DOMContentLoaded",i)}var $="valid",q="invalid",g=class{element;action;outputElement;indicatorElement;static selector(e){e.querySelectorAll("input[data-autocomplete-action]").forEach(t=>new this(t))}constructor(e){this.element=e,e.autocomplete="off",this.action=e.dataset.autocompleteAction;let t=e.dataset.autocompleteOutput,n=e.dataset.autocompleteIndicator,r=t?document.querySelector(t):void 0;if(!r)throw new Error("Expected element to have data-autocomplete-output");this.outputElement=r||document.createElement("input"),this.indicatorElement=n?document.querySelector(n):void 0,e.addEventListener("keyup",o=>this.keyUp(o)),e.addEventListener("keydown",o=>{o.key==="Enter"&&o.preventDefault()})}getResultsContainer(){let e=h(this.element),t=document.querySelector("#autocomplete");return t||(t=Object.assign(document.createElement("div"),{id:"autocomplete"}),Object.assign(t.style,{zIndex:L()}),document.body.appendChild(t)),Object.assign(t.style,{top:`${e.yh}px`,left:`${e.x}px`,width:`${e.w}px`}),t}keyUp(e){let t=this.getResultsContainer(),n=Array.from(t.querySelectorAll("div")),r=n.findIndex(l=>l.classList.contains("selected"));if(n)switch(e.key){case"ArrowUp":r>=0&&(n[r].classList.remove("selected"),n[r-1].classList.add("selected"));return;case"ArrowDown":r===-1?n[0].classList.add("selected"):r<n.length-1&&(n[r].classList.remove("selected"),n[r+1].classList.add("selected"));return;case"Enter":r>=0&&n[r].dispatchEvent(new Event("click"));return;default:this.indicatorElement&&(this.indicatorElement.classList.remove($),this.indicatorElement.classList.add(q));break}let o=document.location.toString().match("/ACP/")?"../":"",a=encodeURIComponent(this.element.value),s=`act=${this.action}&term=${a}`;new E().load(`${o}api/?${s}`,{callback:l=>{let c=JSON.parse(l.responseText);if(t.innerHTML="",!c.length)t.style.display="none";else{t.style.display="";let[d,m]=c;d.forEach((p,u)=>{let H=m[u],x=document.createElement("div");x.innerHTML=H,x.onclick=()=>{t.style.display="none",this.indicatorElement&&this.indicatorElement.classList.add($),this.outputElement.value=`${p}`,this.outputElement.dispatchEvent(new Event("change")),this.element.value=H},t.appendChild(x)})}}})}};var y=class i extends HTMLElement{shadow;internals;results;search;leaveHandler;optionKeyboardHandler;hiddenFormField;static formAssociated=!0;value;static selector(){customElements.define("better-select",i),customElements.define("better-option",class extends HTMLElement{})}constructor(){super(),this.value=this.getAttribute("value")??"",this.shadow=this.attachShadow({mode:"open"}),this.internals=this.attachInternals(),this.search=document.createElement("input"),this.results=document.createElement("div"),this.hiddenFormField=Object.assign(document.createElement("input"),{type:"hidden",name:this.getAttribute("name")}),this.leaveHandler=e=>{this.results.classList.toggle("open",e.relatedTarget instanceof HTMLElement&&this.results.contains(e.relatedTarget))},this.optionKeyboardHandler=function(t){switch(t.key){case"ArrowUp":this.previousElementSibling?.focus();break;case"ArrowDown":this.nextElementSibling.focus();break;default:break}}}connectedCallback(){let{shadow:e,results:t,search:n}=this;t.className="results",n.autocomplete="off",n.onfocus=()=>t.classList.toggle("open",!0),n.oninput=()=>{this.renderOptions(n.value)},n.onkeydown=o=>{switch(o.key){case"ArrowUp":this.shadow.querySelector(".results button:last-child")?.focus();break;case"ArrowDown":this.shadow.querySelector(".results button:first-child")?.focus();break;default:break}},n.onblur=this.leaveHandler,e.appendChild(n),e.appendChild(this.hiddenFormField),e.appendChild(t),this.renderOptions(),e.adoptedStyleSheets=[this.stylesheet()],n.setAttribute("role","combobox"),n.setAttribute("aria-activedescendant",""),t.setAttribute("role","listbox");let r=`id-${Math.random()}`;t.setAttribute("id",r),n.setAttribute("aria-controls",r)}close(){this.results.classList.remove("open")}clear(){[...Array.from(this.querySelectorAll("better-option[selected]")),...Array.from(this.results.querySelectorAll(".selected"))].forEach(e=>{e.removeAttribute("selected"),e.classList.remove("selected")})}renderOptions(e=""){this.results.innerHTML="",this.getOptions(e).forEach(t=>this.results.appendChild(t))}getOptions(e=""){return Array.from(this.querySelectorAll("better-option")).filter(t=>t.innerText.toLowerCase().includes(e.toLowerCase())).map(t=>{let n=document.createElement("button");n.onclick=()=>{this.hasAttribute("multiple")||(this.clear(),this.close()),n.classList.toggle("selected"),t.toggleAttribute("selected",n.classList.contains("selected")),this.updateValue()},n.onkeydown=this.optionKeyboardHandler,n.classList.toggle("selected",t.hasAttribute("selected"));let r=t.getAttribute("image");if(r){let a=new Image;a.src=r,n.appendChild(a)}let o=document.createTextNode(` ${t.innerText}`);return n.appendChild(o),n.onblur=this.leaveHandler,n}).filter(Boolean)}updateValue(){let e=Array.from(this.querySelectorAll("better-option[selected]"));this.value=e.map(t=>t.getAttribute("value")).join(","),this.search.value=e.at(-1)?.innerText??"",this.internals.setFormValue(this.value),this.dispatchEvent(new Event("change"))}stylesheet(){let e=new CSSStyleSheet;return e.replaceSync(`
            button { display: block; width: 100%; text-align: left; }
            button.selected { background: #1f1f83; color: #FFF; }
            button:hover { background: #9cdcfe; }
            button img { vertical-align: middle; }
            .results { position: absolute; display: none; max-height: 400px; overflow: auto; }
            .results.open { display: block; }
        `),e}};var b=class{element;static selector(e){e.querySelectorAll("input.switch").forEach(t=>new this(t))}constructor(e){this.element=e,e.style.display="none";let t=Object.assign(document.createElement("button"),{type:"button",title:e.className,className:e.className}),n=()=>{t.style.backgroundPosition=e.checked?"top":"bottom"};n(),t.addEventListener("click",()=>{e.checked=!e.checked,n(),e.dispatchEvent(new Event("change"))}),f(t,e)}};function O(i){let e=i.target;if(e?.tagName.toLowerCase()==="a"){let t=document.querySelector(`#menu_${e.classList[0]}`);e.classList.add("active");let n=t.style;n.display="block";let r=h(e);n.top=`${r.y+e.clientHeight}px`,n.left=`${r.x}px`,e.onmouseout=o=>{!o.relatedTarget&&o.toElement&&(o.relatedTarget=o.toElement),o.relatedTarget!==t&&o.relatedTarget.offsetParent!==t&&(e.classList.remove("active"),t.style.display="none")},t.onmouseout=o=>{!o.relatedTarget&&o.toElement&&(o.relatedTarget=o.toElement),o.relatedTarget!==e&&o.relatedTarget.offsetParent!==t&&o.relatedTarget!==t&&(e.classList.remove("active"),t.style.display="none")}}}function j(i){let e=[],t=[],n=Array.from(i.elements),r=i.submitButton;n.forEach(o=>{!o.name||o.type==="submit"||(o.type==="checkbox"||o.type==="radio")&&!o.checked||(e.push(o.name),t.push(o.value))}),r&&(e.push(r.name),t.push(r.value)),new E().load(document.location.search,{data:[e,t]}),alert("Saved. Ajax-submitted so you don't lose your place")}function R(){document.querySelector("#nav").addEventListener("mouseover",O),Array.from(document.querySelectorAll("form[data-use-ajax-submit]")).forEach(n=>{n.addEventListener("submit",r=>{r.preventDefault(),j(n)})}),g.selector(document.body),b.selector(document.body),y.selector(document.body);let i=document.querySelector(".editor");i&&i.addEventListener("keydown",n=>{n.keyCode===9&&(C(i,"    "),n.preventDefault())});let e=document.querySelector(".tree"),t=document.querySelector("#ordered");e&&t&&A(e,"forum_",t)}k(R);})();
